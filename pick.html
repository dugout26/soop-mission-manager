<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MK í†µí•© ëŒ€ì‹œë³´ë“œ</title>
<link rel="icon" href="icon.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#080f0a;--card:#0f1a12;--card2:#162219;--blue:#4ade80;--orange:#f97316;--green:#22c55e;--red:#ef4444;--purple:#86efac;--cyan:#6ee7b7;--yellow:#eab308;--text:#f1f4f1;--text2:#88a090;--muted:#557060;--border:#1e3625;--team-blue:#3b82f6;--team-red:#ef4444}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:linear-gradient(rgba(74,222,128,.04)1px,transparent 1px),linear-gradient(90deg,rgba(74,222,128,.04)1px,transparent 1px);background-size:40px 40px;pointer-events:none}

.app{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:16px}

/* ë©”ì¸ í—¤ë” */
.main-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding:20px 24px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.main-logo{font-family:'Black Han Sans';font-size:28px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:12px}
.main-logo img{width:40px;height:40px;border-radius:8px}
.main-nav{display:flex;gap:8px}
.nav-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.nav-btn:hover{border-color:var(--blue);color:var(--blue)}
.nav-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.nav-btn.status{border-color:var(--green);color:var(--green)}

/* íƒ­ ì»¨í…ì¸  */
.tab-content{display:none}
.tab-content.active{display:block}


/* DRAFTMASTER ìŠ¤íƒ€ì¼ ì‚¬ë‹¤ë¦¬ ê²Œì„ */
.ladder-container{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px}

/* ìƒë‹¨ ì°¸ê°€ì í˜ì–´ ëª©ë¡ */
.pair-list{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px}
.pair-box{display:flex;flex-direction:column;gap:4px;padding:10px 16px;background:var(--card2);border:2px solid var(--border);border-radius:8px;min-width:120px;text-align:center;transition:all .2s}
.pair-box.matched{border-color:var(--green);box-shadow:0 0 12px rgba(74,222,128,.15)}
.pair-box .pair-member{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600}
.pair-box .pair-member img{width:24px;height:24px;border-radius:50%;object-fit:cover}
.pair-box .pair-member.leader{color:var(--green)}

/* ë©”ì¸ 3ë‹¨ ë ˆì´ì•„ì›ƒ: AíŒ€ | ì¤‘ì•™ | BíŒ€ */
.draft-layout{display:grid;grid-template-columns:1fr 100px 1fr;gap:16px;margin-top:20px}

/* íŒ€ ì˜ì—­ */
.team-panel{background:var(--card2);border:2px solid var(--border);border-radius:10px;padding:16px}
.team-panel.team-a{border-color:rgba(59,130,246,.3)}
.team-panel.team-b{border-color:rgba(239,68,68,.3)}
.team-panel.team-a.picking{border-color:var(--team-blue);box-shadow:0 0 20px rgba(59,130,246,.35);animation:pickPulse-blue 1.5s infinite}
.team-panel.team-b.picking{border-color:var(--team-red);box-shadow:0 0 20px rgba(239,68,68,.35);animation:pickPulse-red 1.5s infinite}
@keyframes pickPulse-blue{0%,100%{box-shadow:0 0 18px rgba(59,130,246,.4),inset 0 0 12px rgba(59,130,246,.08)}50%{box-shadow:0 0 36px rgba(59,130,246,.7),inset 0 0 20px rgba(59,130,246,.12)}}
@keyframes pickPulse-red{0%,100%{box-shadow:0 0 18px rgba(239,68,68,.4),inset 0 0 12px rgba(239,68,68,.08)}50%{box-shadow:0 0 36px rgba(239,68,68,.7),inset 0 0 20px rgba(239,68,68,.12)}}
.team-header{text-align:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.team-header h3{font-size:22px;font-weight:900;margin:0}
.team-header .team-count{font-size:12px;color:var(--muted);margin-top:2px}
.team-slot{padding:12px;margin-bottom:8px;border:2px dashed var(--border);border-radius:8px;min-height:56px;display:flex;align-items:center;gap:8px;transition:all .2s}
.team-a .team-slot.filled{border-style:solid;border-color:var(--team-blue);background:rgba(59,130,246,.05)}
.team-b .team-slot.filled{border-style:solid;border-color:var(--team-red);background:rgba(239,68,68,.05)}
.team-slot .slot-label{font-size:11px;color:var(--muted);text-align:center;width:100%}
.team-a .team-slot img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--team-blue)}
.team-b .team-slot img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--team-red)}
.team-slot .slot-name{font-size:13px;font-weight:700}
.team-a .team-slot .slot-role{font-size:9px;color:var(--team-blue);font-weight:600;text-transform:uppercase}
.team-b .team-slot .slot-role{font-size:9px;color:var(--team-red);font-weight:600;text-transform:uppercase}

/* ì‚¬ë‹¤ë¦¬ ì¤‘ì•™ ì˜ì—­ */
.ladder-center{display:flex;flex-direction:column;align-items:stretch}
.ladder-top-players{display:flex;justify-content:space-evenly;margin-bottom:8px}
.ladder-player{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:60px}
.ladder-player img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--green);background:var(--card2)}
.ladder-player .player-name{font-size:11px;font-weight:700;text-align:center;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.ladder-bottom{display:flex;justify-content:space-evenly;margin-top:8px}
.ladder-result-slot{text-align:center}
.ladder-result-slot .result-label{padding:6px 12px;border-radius:4px;font-size:11px;font-weight:700}
.ladder-result-slot .result-label.team-a-label{background:var(--team-blue);color:#fff}
.ladder-result-slot .result-label.team-b-label{background:var(--team-red);color:#fff}

/* í•˜ë‹¨ ì´ë²¤íŠ¸ ë¡œê·¸ ë°” */
.event-bar{margin-top:16px;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;gap:12px;font-size:12px;overflow:hidden}
.event-bar .event-icon{font-size:18px}
.event-bar .event-text{flex:1;color:var(--text2)}
.event-bar .event-text span{color:var(--green);font-weight:700}

/* ë§ë²¨ ì²´í¬ë°•ìŠ¤ */
.match-check{display:flex;flex-direction:column;align-items:center;gap:2px;padding:0 4px}
.match-check input[type=checkbox]{width:18px;height:18px;accent-color:var(--green);cursor:pointer}
.match-check .match-label{font-size:8px;color:var(--green);font-weight:700}

.game-controls{display:flex;gap:12px;justify-content:center;margin-top:20px}
.game-btn{padding:12px 24px;border-radius:8px;border:none;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.game-btn:hover{transform:translateY(-1px)}
.game-btn.primary{background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;box-shadow:0 4px 12px rgba(74,222,128,.3)}
.game-btn.secondary{background:var(--card2);color:var(--text2);border:1px solid var(--border)}

/* ì‚¬ë‹¤ë¦¬ ì„¤ì • */
.ladder-settings{display:flex;align-items:center;gap:12px;font-size:12px;color:var(--text2)}
.ladder-settings label{display:flex;align-items:center;gap:4px}
.ladder-settings input[type=number]{width:50px;padding:4px 6px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;text-align:center}

/* í•˜ë‹¨ ìƒíƒœë°” */
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-top:12px;font-size:10px;color:var(--muted)}
.status-bar .status-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px}

@media(max-width:900px){
  .draft-layout{grid-template-columns:1fr;gap:12px}
  .team-panel{order:2}
  .ladder-center{order:1}
}

/* ì˜¤ëŠ˜ì˜ ë©¤ë²„ ìŠ¤íƒ€ì¼ */
.member-grid{display:flex;flex-direction:column;gap:6px;min-height:80px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px}
.member-pair{display:flex;align-items:center;gap:6px;padding:8px 10px;background:var(--card2);border:1px solid var(--border);border-radius:8px}
.member-pair .pair-label{font-size:11px;font-weight:900;color:var(--green);min-width:50px;text-align:center;line-height:1.2}
.member-slot{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg);border:2px dashed var(--border);border-radius:8px;flex:1;min-width:0;min-height:44px;position:relative;transition:all .15s}
.member-slot.filled{border-style:solid;border-color:var(--border);cursor:grab;user-select:none}
.member-slot.filled:active{cursor:grabbing}
.member-slot.filled:hover{border-color:var(--blue);background:rgba(74,222,128,.1)}
.member-slot.empty{cursor:pointer}
.member-slot.empty:hover{border-color:var(--green);background:rgba(74,222,128,.05)}
.member-slot.empty .slot-placeholder{font-size:11px;color:var(--muted);width:100%;text-align:center}
.member-slot.editing{border-color:var(--green);border-style:solid;background:rgba(74,222,128,.05)}
.member-slot .slot-input{width:100%;padding:4px 8px;background:transparent;border:none;color:var(--text);font-size:13px;font-family:inherit;outline:none}
.member-slot .slot-input::placeholder{color:var(--muted);font-size:11px}
.member-slot .slot-search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border:2px solid var(--green);border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.5);margin-top:4px}
.member-slot .slot-search-item{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(74,222,128,.1);transition:all .1s}
.member-slot .slot-search-item:hover,.member-slot .slot-search-item.highlighted{background:rgba(74,222,128,.15)}
.member-slot .slot-search-item img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--green)}
.member-slot .slot-search-item .si-name{font-size:13px;font-weight:700}
.member-slot .slot-search-item .si-id{font-size:10px;color:var(--muted)}
.member-slot.dragging{opacity:0.4;border:2px dashed var(--green)}
.member-slot.drag-over{border-color:var(--green);background:rgba(74,222,128,.15);transform:scale(1.02)}
.member-slot img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
.member-slot .info{flex:1;min-width:0}
.member-slot .name{font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.member-slot .remove{position:absolute;top:-5px;right:-5px;width:18px;height:18px;background:var(--red);color:#fff;border:none;border-radius:50%;font-size:10px;cursor:pointer;display:none;z-index:2}
.member-slot.filled:hover .remove{display:flex;align-items:center;justify-content:center}
.live-indicator{width:14px;height:14px;border-radius:3px;border:2px solid rgba(255,255,255,.2);flex-shrink:0;transition:all .3s}
.live-indicator.on-air{background:#22c55e;border-color:#22c55e;cursor:pointer;box-shadow:0 0 6px rgba(34,197,94,.6);animation:livePulse 2s infinite}
.live-indicator.off-air{background:#ef4444;border-color:#ef4444}
@keyframes livePulse{0%,100%{box-shadow:0 0 6px rgba(34,197,94,.6)}50%{box-shadow:0 0 12px rgba(34,197,94,.9)}}
.member-card{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg);border:2px solid var(--border);border-radius:8px;cursor:grab;transition:all .15s;position:relative;user-select:none;flex:1;min-width:0}
.member-card:active{cursor:grabbing}
.member-card:hover{border-color:var(--blue);background:rgba(74,222,128,.1)}
.member-card.selected{border-color:var(--green);background:rgba(34,197,94,.15)}
.member-card.dragging{opacity:0.4;border:2px dashed var(--green)}
.member-card.drag-over{border-color:var(--green);background:rgba(74,222,128,.15);transform:scale(1.02)}
.member-card img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
.member-card .info{flex:1;min-width:0}
.member-card .name{font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.member-card .id{font-size:10px;color:var(--muted)}
.member-card .member-order{font-size:14px;font-weight:900;color:var(--green);min-width:18px;text-align:center}
.member-card .remove{position:absolute;top:-5px;right:-5px;width:18px;height:18px;background:var(--red);color:#fff;border:none;border-radius:50%;font-size:10px;cursor:pointer;display:none;z-index:2}
.member-card:hover .remove{display:flex;align-items:center;justify-content:center}
.member-pair .pair-vs{font-size:10px;font-weight:900;color:var(--yellow)}
.member-pair-divider{display:none}

/* ì°¸ê°€ì ì„ íƒ ëª¨ë‹¬ */
.pick-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.pick-overlay.active{display:flex}
.pick-modal{background:var(--card);border:2px solid var(--green);border-radius:12px;padding:24px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto}
.pick-modal h3{font-size:16px;font-weight:700;color:var(--green);margin-bottom:16px}
.pick-option{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.pick-option:hover{border-color:var(--green);background:rgba(74,222,128,.05)}
.pick-option img{width:40px;height:40px;border-radius:50%;object-fit:cover}
.pick-option .pick-name{font-size:14px;font-weight:700}

/* ë¼ì¸ ì„ íƒ ì˜µì…˜ */
.line-option{display:flex;align-items:center;gap:12px;padding:14px 16px;border:2px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.line-option:hover{border-color:var(--green);background:rgba(74,222,128,.05)}
.line-option.selected{border-color:var(--green);background:rgba(34,197,94,.15);box-shadow:0 0 12px rgba(74,222,128,.2)}
.line-option.done{opacity:0.4;cursor:not-allowed;border-color:var(--muted)}
.line-option img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
.line-option .line-label{font-size:15px;font-weight:700;color:var(--green)}
.line-option .line-vs{font-size:12px;font-weight:900;color:var(--yellow);margin:0 4px}
.member-card.locked{opacity:0.8;cursor:default;border-style:solid}
.pick-option .pick-id{font-size:10px;color:var(--muted)}

/* í”½ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ */
.pick-anim-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.pick-anim-overlay.show{opacity:1;pointer-events:auto}
.pick-anim-card{background:var(--card);border:3px solid var(--green);border-radius:16px;padding:32px 48px;text-align:center;transform:scale(.5);transition:transform .4s cubic-bezier(.34,1.56,.64,1),border-color .3s}
.pick-anim-overlay.show .pick-anim-card{transform:scale(1)}
.pick-anim-card.blue{border-color:var(--team-blue)}
.pick-anim-card.red{border-color:var(--team-red)}
.pick-anim-card img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;border:3px solid var(--green)}
.pick-anim-card.blue img{border-color:var(--team-blue)}
.pick-anim-card.red img{border-color:var(--team-red)}
.pick-anim-card .anim-name{font-size:22px;font-weight:900;margin-bottom:4px}
.pick-anim-card .anim-team{font-size:13px;font-weight:700;margin-top:8px}

/* ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜ */
.dice-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:flex;align-items:center;justify-content:center;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .3s}
.dice-overlay.show{opacity:1;pointer-events:auto}
.dice-container{font-size:120px;animation:diceRoll 2s ease-out;text-align:center}
@keyframes diceRoll{0%{transform:rotate(0deg) scale(.3);opacity:0}20%{transform:rotate(360deg) scale(1.2);opacity:1}40%{transform:rotate(720deg) scale(1)}60%{transform:rotate(1080deg) scale(1.1)}80%{transform:rotate(1440deg) scale(1)}100%{transform:rotate(1800deg) scale(1)}}
.dice-result-text{font-size:24px;font-weight:900;color:var(--green);margin-top:20px;opacity:0;animation:fadeInUp .5s .8s forwards}
@keyframes fadeInUp{to{opacity:1;transform:translateY(0)}from{opacity:0;transform:translateY(20px)}}
.random-assign-anim{display:flex;flex-direction:column;gap:12px;margin-top:24px;max-width:500px;width:100%;padding:0 16px}
.random-assign-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;opacity:0;transform:translateY(20px);transition:all .4s cubic-bezier(.34,1.56,.64,1)}
.random-assign-card.show{opacity:1;transform:translateY(0)}
.random-assign-card .ra-role{font-size:13px;font-weight:900;color:var(--yellow);min-width:44px;text-align:center}
.random-assign-card .ra-member{display:flex;align-items:center;gap:8px;flex:1;padding:8px 12px;border-radius:8px;background:var(--card2)}
.random-assign-card .ra-member img{width:36px;height:36px;border-radius:50%;object-fit:cover}
.random-assign-card .ra-member .ra-name{font-size:13px;font-weight:700}
.random-assign-card .ra-member .ra-team{font-size:10px;font-weight:700;margin-top:1px}
.random-assign-card .ra-member.team-a{border:2px solid var(--team-blue)}
.random-assign-card .ra-member.team-a .ra-team{color:var(--team-blue)}
.random-assign-card .ra-member.team-a img{border:2px solid var(--team-blue)}
.random-assign-card .ra-member.team-b{border:2px solid var(--team-red)}
.random-assign-card .ra-member.team-b .ra-team{color:var(--team-red)}
.random-assign-card .ra-member.team-b img{border:2px solid var(--team-red)}
.random-assign-card .ra-vs{font-size:11px;font-weight:900;color:var(--muted)}

/* ë“œë˜í”„íŠ¸ ë°©ì‹ ì„ íƒ ëª¨ë‹¬ */
.draft-method-option{display:flex;align-items:center;gap:16px;padding:20px;border:2px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;transition:all .2s}
.draft-method-option:hover{border-color:var(--green);background:rgba(74,222,128,.05);transform:translateY(-1px)}
.draft-method-option .dm-icon{font-size:36px;min-width:50px;text-align:center}
.draft-method-option .dm-title{font-size:16px;font-weight:900;color:var(--green)}
.draft-method-option .dm-desc{font-size:11px;color:var(--text2);margin-top:2px;line-height:1.4}

/* ì»¤ìŠ¤í…€ ìŠ¬ë¡¯ ì„¤ì • */
.custom-slot-row{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card2);border:2px solid var(--border);border-radius:10px}
.custom-slot-row .cs-label{font-size:14px;font-weight:700;color:var(--text);min-width:90px}
.custom-slot-row .cs-label.side{color:var(--yellow)}
.custom-slot-btns{display:flex;gap:6px;flex:1}
.custom-slot-btns button{flex:1;padding:8px 4px;border-radius:6px;border:2px solid var(--border);background:var(--bg);color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.custom-slot-btns button:hover{border-color:var(--green)}
.custom-slot-btns button.active-pick{border-color:var(--team-blue);background:rgba(59,130,246,.15);color:var(--team-blue)}
.custom-slot-btns button.active-counter{border-color:var(--team-red);background:rgba(239,68,68,.15);color:var(--team-red)}
.custom-slot-btns button.active-ladder{border-color:var(--green);background:rgba(74,222,128,.15);color:var(--green)}

/* í¬ì§€ì…˜ ì„ íƒ ëª¨ë‹¬ */
.role-select-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:150;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.role-select-overlay.active{opacity:1;pointer-events:auto}
.role-select-modal{background:var(--card);border:2px solid var(--green);border-radius:16px;padding:24px;max-width:360px;width:90%}
.role-btn{display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;margin-bottom:8px;border:2px solid var(--border);border-radius:10px;background:var(--card2);color:var(--text);font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.role-btn:hover{border-color:var(--green);background:rgba(74,222,128,.05);transform:translateY(-1px)}
.role-btn.used{opacity:.3;pointer-events:none;border-color:var(--border)}
.role-btn .role-icon{font-size:22px;min-width:30px;text-align:center}
.role-btn .role-name{flex:1}

/* íŒ€ê²°ì„±ì™„ë£Œ í™•ëŒ€ */
.team-complete-result{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px}
.team-complete-result .team-panel{padding:20px}
.team-complete-result .team-header h3{font-size:26px}
.team-complete-result .team-slot{padding:14px;min-height:60px}
.team-complete-result .team-slot img{width:44px;height:44px}
.team-complete-result .team-slot .slot-name{font-size:15px}

@media(max-width:768px){
  .main-header{flex-direction:column;gap:12px}
  .participants{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
}
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<!-- ë¡œê·¸ì¸ ë¶ˆí•„ìš” -->

<div class="app" id="mainApp" style="display:block">
  <!-- í—¤ë” ë„¤ë¹„ -->
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
    <div style="font-family:'Black Han Sans';font-size:22px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px"><img src="icon.png" style="width:32px;height:32px;border-radius:6px">MK íŒ€ë½‘ê¸°</div>
  </div>

  <!-- íŒ€ë½‘ê¸° -->
  <div id="ladderTab" class="tab-content active" style="display:block">
    <!-- ê²Œì„ ëª¨ë“œ ì„ íƒ -->
    <div id="gameModeSelector" class="ladder-container" style="margin-bottom:16px;text-align:center">
      <h2 style="font-family:'Black Han Sans';font-size:24px;color:var(--green);margin-bottom:16px">âš”ï¸ ê²Œì„ ëª¨ë“œ ì„ íƒ</h2>
      <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap">
        <button onclick="selectGameMode('solo')" style="flex:1;max-width:280px;padding:24px 20px;background:var(--card2);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s;font-family:inherit" onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="font-size:32px;margin-bottom:8px">ğŸ®</div>
          <div style="font-size:18px;font-weight:900;color:var(--green);margin-bottom:4px">ì†”ë­ ë‚´ê¸°</div>
          <div style="font-size:11px;color:var(--text2);line-height:1.5">ë§ë²¨ì„ <span style="color:var(--green);font-weight:700">ìˆ˜ë™</span>ìœ¼ë¡œ ì„¤ì •<br>ì›í•˜ëŠ” ë©¤ë²„ë¼ë¦¬ë§Œ ë§ë²¨ ì²´í¬</div>
        </button>
        <button onclick="selectGameMode('land')" style="flex:1;max-width:280px;padding:24px 20px;background:var(--card2);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s;font-family:inherit" onmouseover="this.style.borderColor='var(--yellow)'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="font-size:32px;margin-bottom:8px">ğŸ°</div>
          <div style="font-size:18px;font-weight:900;color:var(--yellow);margin-bottom:4px">ëœë“œ / CK</div>
          <div style="font-size:11px;color:var(--text2);line-height:1.5">ì „ì› <span style="color:var(--yellow);font-weight:700">ìë™ ë§ë²¨</span><br>A,B C,D ìˆœì„œëŒ€ë¡œ 2ì¸ 1ì¡°</div>
        </button>
      </div>
    </div>

    <!-- ì˜¤ëŠ˜ì˜ ëŒ€ê²° ë©¤ë²„ -->
    <div id="memberSection" class="ladder-container" style="margin-bottom:16px;display:none">
      <h2 id="memberSectionTitle" style="font-size:16px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        ğŸ‘¥ ì˜¤ëŠ˜ì˜ ëŒ€ê²° ë©¤ë²„
        <span id="mapToggle" style="display:none;margin-left:4px;align-items:center;gap:4px">
          <button id="btnRift" onclick="setMapMode('rift')" style="padding:3px 10px;border-radius:6px;border:2px solid var(--green);background:rgba(74,222,128,.2);color:var(--green);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">í˜‘ê³¡</button>
          <button id="btnAram" onclick="setMapMode('aram')" style="padding:3px 10px;border-radius:6px;border:2px solid var(--border);background:transparent;color:var(--muted);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">ì¹¼ë°”ëŒ</button>
        </span>
        <span style="font-size:10px;color:var(--muted);font-weight:400">ë¯¸ë¦¬ ë“±ë¡í•´ë‘ê³  í´ë¦­ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”</span>
        <span id="memberToggleHint" style="display:none;font-size:10px;color:var(--green);margin-left:auto">â–¼ í¼ì¹˜ê¸°</span>
      </h2>

      <!-- ë©¤ë²„ ì¶”ê°€ -->
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end">
        <div class="search-container" style="flex:1;min-width:250px;position:relative">
          <label style="display:block;font-size:14px;font-weight:600;color:var(--text);margin-bottom:6px">
            ğŸ” ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰
          </label>
          <div style="position:relative">
            <input id="newMemberInput"
                   placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..."
                   style="width:100%;padding:12px 16px;background:var(--card);border:2px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;font-family:inherit;transition:border-color 0.2s,box-shadow 0.2s"
                   oninput="searchStreamerForMember(this)"
                   onfocus="this.style.borderColor='var(--green)';this.style.boxShadow='0 0 0 3px rgba(74, 222, 128, 0.1)'"
                   onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
            <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none">
              âŒ¨ï¸
            </div>
          </div>
        </div>
        <button onclick="addTodayMember()"
                style="padding:12px 20px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(74, 222, 128, 0.3);transition:transform 0.1s"
                onmouseover="this.style.transform='translateY(-1px)'"
                onmouseout="this.style.transform='translateY(0)'">
          âœ… ì¶”ê°€
        </button>
        <button onclick="clearTodayMembers()"
                style="padding:12px 20px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(239, 68, 68, 0.3);transition:transform 0.1s"
                onmouseover="this.style.transform='translateY(-1px)'"
                onmouseout="this.style.transform='translateY(0)'">
          ğŸ—‘ï¸ ì „ì²´ì‚­ì œ
        </button>
        <button onclick="fullReset()"
                style="padding:12px 20px;background:linear-gradient(135deg,#6b7280,#4b5563);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(107,114,128,.3);transition:transform 0.1s"
                onmouseover="this.style.transform='translateY(-1px)'"
                onmouseout="this.style.transform='translateY(0)'">
          ğŸ”„ ì „ì²´ì´ˆê¸°í™”
        </button>
      </div>

      <!-- ë“±ë¡ëœ ë©¤ë²„ ëª©ë¡ (2ì—´ ì„¸ë¡œ ê·¸ë¦¬ë“œ) -->
      <div id="todayMembersList" class="member-grid"></div>

      <!-- ë©¤ë²„í™•ì • ë²„íŠ¼ -->
      <div style="margin-top:16px;text-align:center">
        <button id="confirmMembersBtn" onclick="confirmMembers()" style="display:none;padding:16px 48px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;border:none;border-radius:12px;font-size:18px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 4px 16px rgba(74,222,128,.4);transition:all .15s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          âœ… ë©¤ë²„í™•ì •
        </button>
      </div>
    </div>

    <!-- DRAFTMASTER ê²Œì„ ì˜ì—­ -->
    <div class="ladder-container" id="draftArea" style="display:none">
      <!-- í—¤ë” -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <h2 style="font-family:'Black Han Sans';font-size:26px;color:var(--green);margin:0;display:flex;align-items:center;gap:8px">
          <span style="font-size:22px">ğŸªœ</span> íŒ€ë½‘ê¸°
        </h2>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <input type="hidden" id="rungCount" value="3">
          <span id="roundInfo" style="font-size:13px;color:var(--muted);font-weight:600"></span>
          <button onclick="goBackToMembers()" style="padding:6px 14px;background:var(--card2);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">â†© ì´ˆê¸°í™”</button>
        </div>
      </div>

      <!-- STEP 1: ì‚¬ë‹¤ë¦¬ ì°¸ê°€ì ì„ íƒ -->
      <div id="ladderSetupArea">
        <div id="ladderSetupTitle" style="margin-bottom:12px;font-size:13px;font-weight:700;color:var(--green)">STEP 1: ì‚¬ë‹¤ë¦¬ ì°¸ê°€ì ì„ íƒ</div>
        <div style="display:flex;gap:16px;align-items:stretch;flex-wrap:wrap;margin-bottom:16px">
          <!-- ì‚¬ë‹¤ë¦¬ ì„¸ë¡œì¤„ ìŠ¬ë¡¯: X, ì°¸ê°€ì1, ì°¸ê°€ì2 -->
          <div style="flex:1;min-width:100px;background:var(--bg);border:2px dashed var(--red);border-radius:8px;padding:16px;text-align:center;opacity:0.5">
            <div style="font-size:36px;font-weight:900;color:var(--red);margin-bottom:4px">X</div>
            <div style="font-size:10px;color:var(--muted)">ê½ (íƒˆë½)</div>
          </div>
          <div id="ladderSlot1" style="flex:1;min-width:100px;background:var(--bg);border:2px dashed var(--green);border-radius:8px;padding:16px;text-align:center;cursor:pointer" onclick="openPlayerSelect(0)">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">2ë²ˆ ìë¦¬</div>
            <div style="font-size:13px;color:var(--text2)">ë©¤ë²„ í´ë¦­</div>
          </div>
          <button id="swapLadderBtn" onclick="swapLadderPlayers()" style="align-self:center;padding:10px 14px;background:var(--card2);border:2px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;cursor:pointer;font-family:inherit;transition:all .15s;display:none" onmouseover="this.style.borderColor='var(--green)';this.style.background='rgba(74,222,128,.1)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--card2)'" title="ìë¦¬ êµí™˜">ğŸ”„</button>
          <div id="ladderSlot2" style="flex:1;min-width:100px;background:var(--bg);border:2px dashed var(--green);border-radius:8px;padding:16px;text-align:center;cursor:pointer" onclick="openPlayerSelect(1)">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">3ë²ˆ ìë¦¬</div>
            <div style="font-size:13px;color:var(--text2)">ë©¤ë²„ í´ë¦­</div>
          </div>
        </div>
      </div>

      <!-- ì‚¬ë‹¤ë¦¬ ìº”ë²„ìŠ¤ -->
      <div id="ladderSection" style="margin-top:12px">
        <canvas id="ladderCanvas" width="700" height="340" style="width:100%;max-width:600px;margin:0 auto;display:block;border:2px solid var(--border);border-radius:8px;background:rgba(0,0,0,.3)"></canvas>
        <!-- í•˜ë‹¨ ê²°ê³¼ ë¼ë²¨: X / ì„  / í›„ -->
        <div id="ladderBottomLabels" style="display:flex;justify-content:space-around;max-width:600px;margin:8px auto 0">
          <button class="ladder-bottom-btn" data-slot="0" onclick="assignBottomLabel(0)" style="flex:1;margin:0 4px;padding:10px 6px;border-radius:6px;border:2px solid var(--red);background:rgba(239,68,68,.1);color:var(--red);font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;transition:all .15s">X</button>
          <button class="ladder-bottom-btn" data-slot="1" onclick="assignBottomLabel(1)" style="flex:1;margin:0 4px;padding:10px 6px;border-radius:6px;border:2px solid var(--green);background:rgba(74,222,128,.1);color:var(--green);font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;transition:all .15s">ì„ </button>
          <button class="ladder-bottom-btn" data-slot="2" onclick="assignBottomLabel(2)" style="flex:1;margin:0 4px;padding:10px 6px;border-radius:6px;border:2px solid var(--yellow);background:rgba(234,179,8,.1);color:var(--yellow);font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;transition:all .15s">í›„</button>
        </div>
      </div>

      <!-- ê²Œì„ ì»¨íŠ¸ë¡¤ -->
      <div class="game-controls" style="margin-top:16px">
        <button class="game-btn primary" onclick="runLadder()" id="runLadderBtn" disabled>â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘</button>
        <button class="game-btn secondary" onclick="showAllResults()" id="showAllBtn" style="display:none">âš¡ ì „ì²´ê²°ê³¼ë³´ê¸°</button>
        <button class="game-btn secondary" onclick="resetLadder()">ğŸ”„ ì´ˆê¸°í™”</button>
      </div>

      <!-- ì‚¬ë‹¤ë¦¬ ê²°ê³¼ í‘œì‹œ -->
      <div id="ladderResult" style="display:none;margin-top:16px;padding:16px;background:var(--bg);border:2px solid var(--green);border-radius:10px;text-align:center">
        <div style="font-size:14px;font-weight:700;color:var(--green);margin-bottom:12px">ì‚¬ë‹¤ë¦¬ ê²°ê³¼</div>
        <div id="ladderResultContent" style="display:flex;justify-content:center;gap:24px;flex-wrap:wrap"></div>
      </div>

      <!-- STEP 2: ë“œë˜í”„íŠ¸ (ì„ /í›„ ê²°ì • í›„ í‘œì‹œ) -->
      <div id="draftSection" style="display:none;margin-top:24px">
        <div style="margin-bottom:12px;font-size:13px;font-weight:700;color:var(--green)">STEP 2: íŒ€ì› ë“œë˜í”„íŠ¸</div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px">
          <div id="draftOrderInfo" style="font-size:13px;color:var(--text2);flex:1"></div>
          <div id="draftTurnInfo" style="font-size:14px;font-weight:700;color:var(--green)"></div>
        </div>

        <!-- ë‚¨ì€ ë©¤ë²„ í’€ -->
        <div style="margin-bottom:12px;font-size:11px;color:var(--muted)">ë‚¨ì€ ë©¤ë²„ (í´ë¦­í•˜ì—¬ í˜„ì¬ íŒ€ì— ë°°ì •)</div>
        <div id="draftPool" style="display:flex;gap:8px;flex-wrap:wrap;min-height:60px;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:16px"></div>

        <!-- íŒ€ í˜„í™© -->
        <div class="draft-layout">
          <div class="team-panel team-a">
            <div class="team-header">
              <h3 id="teamAHeader" style="color:var(--team-blue)"><span id="teamAName">AíŒ€</span> <span id="captainALabel" style="font-size:11px;color:var(--muted)"></span></h3>
              <div class="team-count" id="teamACount">0</div>
            </div>
            <div id="teamASlots"></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px">
            <div style="font-size:11px;color:var(--muted)">ë‚¨ì€ ë©¤ë²„</div>
            <div id="remainingMembers" style="font-size:36px;font-weight:900;color:var(--green)">0</div>
          </div>
          <div class="team-panel team-b">
            <div class="team-header">
              <h3 id="teamBHeader" style="color:var(--team-red)"><span id="teamBName">BíŒ€</span> <span id="captainBLabel" style="font-size:11px;color:var(--muted)"></span></h3>
              <div class="team-count" id="teamBCount">0</div>
            </div>
            <div id="teamBSlots"></div>
          </div>
        </div>
      </div>

      <!-- ì´ë²¤íŠ¸ ë¡œê·¸ ë°” -->
      <div class="event-bar" id="eventBar">
        <span class="event-icon">ğŸ’¡</span>
        <span class="event-text">ë©¤ë²„ë¥¼ ë“±ë¡í•˜ê³  ì‚¬ë‹¤ë¦¬ì— <span>2ëª…ì„ ë°°ì¹˜</span>í•œ ë’¤ X/ì„ /í›„ë¥¼ ì§€ì •í•˜ì„¸ìš”.</span>
      </div>

      <!-- í•˜ë‹¨ ìƒíƒœë°” -->
      <div class="status-bar">
        <div><span class="status-dot"></span>SYSTEM ONLINE</div>
        <div>ENGINE: LADDER_DRAFT_V3</div>
      </div>
    </div>

    <!-- íŒ€ ê²°ì„± ì™„ë£Œ í™”ë©´ -->
    <div class="ladder-container" id="teamCompleteArea" style="display:none">
      <div style="text-align:center;margin-bottom:24px">
        <h2 style="font-family:'Black Han Sans';font-size:30px;color:var(--green);margin:0">âš”ï¸ íŒ€ ê²°ì„± ì™„ë£Œ!</h2>
        <div id="teamCompleteSubtitle" style="font-size:12px;color:var(--muted);margin-top:4px">íŒ€ í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div>
      </div>
      <div class="team-complete-result">
        <div class="team-panel team-a">
          <div class="team-header">
            <h3 id="finalTeamAHeader" style="color:var(--team-blue)"><span id="finalTeamAName">AíŒ€</span></h3>
          </div>
          <div id="finalTeamA"></div>
        </div>
        <div class="team-panel team-b">
          <div class="team-header">
            <h3 id="finalTeamBHeader" style="color:var(--team-red)"><span id="finalTeamBName">BíŒ€</span></h3>
          </div>
          <div id="finalTeamB"></div>
        </div>
      </div>
      <!-- ì§„ì˜ ì„ íƒ ì˜ì—­ (ëœë“œ/CKë§Œ) -->
      <div id="sideSelectArea" style="display:none;margin-top:24px;text-align:center"></div>
      <!-- ì§„ì˜ ì‚¬ë‹¤ë¦¬ ì˜ì—­ (ì‚¬ë‹¤ë¦¬ ì§„í–‰ ì¤‘) -->
      <div id="sideLadderArea" style="display:none;margin-top:24px;text-align:center">
        <div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:12px">ğŸ® ì§„ì˜ ê²°ì • ì‚¬ë‹¤ë¦¬</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:16px">ì‚¬ë‹¤ë¦¬ë¥¼ íƒ€ì„œ ë¸”ë£¨/ë ˆë“œ ì§„ì˜ì„ ê²°ì •í•©ë‹ˆë‹¤!</div>
      </div>
      <div class="game-controls" style="margin-top:24px;flex-wrap:wrap">
        <button id="startSideLadderBtn" class="game-btn primary" onclick="startSideLadder()" style="display:none">ğŸ® ì§„ì˜ ì‚¬ë‹¤ë¦¬ íƒ€ê¸°</button>
        <button class="game-btn primary" onclick="window.location.href='/control'">ğŸ“º ì§€í†µì‹¤ ê°€ê¸°</button>
        <button class="game-btn primary" onclick="redraft()">ğŸ”„ ë‹¤ì‹œ ëŒë¦¬ê¸°</button>
        <button class="game-btn secondary" onclick="goBackToMembers()">â¬…ï¸ ì´ì „ìœ¼ë¡œ</button>
        <button class="game-btn secondary" onclick="resetAll()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </div>

    <!-- í”½ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
    <div id="pickAnimOverlay" class="pick-anim-overlay">
      <div id="pickAnimCard" class="pick-anim-card">
        <img id="pickAnimImg" src="icon.png">
        <div id="pickAnimName" class="anim-name"></div>
        <div id="pickAnimTeam" class="anim-team"></div>
      </div>
    </div>

    <!-- ì°¸ê°€ì ì„ íƒ ëª¨ë‹¬ -->
    <div class="pick-overlay" id="pickOverlay">
      <div class="pick-modal">
        <h3 id="pickTitle">ì‚¬ë‹¤ë¦¬ì— ì˜¬ë¦´ ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <div id="pickOptions"></div>
        <button onclick="closePickModal()" style="width:100%;padding:10px;background:var(--card2);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;margin-top:12px;font-family:inherit">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- íŒ€ì¥ ì„ íƒ + ì„ í”½ê¶Œ ì„¤ì • ëª¨ë‹¬ -->
    <div class="pick-overlay" id="lineSelectOverlay">
      <div class="pick-modal" style="max-width:500px">
        <h3 id="lineSelectTitle" style="font-size:18px">ëˆ„ê°€ íŒ€ì„ ë½‘ì„ê¹Œìš”?</h3>
        <div id="lineSelectOptions" style="margin-bottom:12px"></div>
        <div id="lineFirstPickArea" style="display:none;margin-top:12px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <span style="font-size:13px;font-weight:700;color:var(--yellow)">â­ ì„ í”½ê¶Œ:</span>
            <select id="lineFirstPickSelect" style="padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;cursor:pointer">
              <option value="">ì—†ìŒ (ì‚¬ë‹¤ë¦¬ë¡œ ê²°ì •)</option>
            </select>
            <select id="lineFirstPickCountSelect" style="padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;cursor:pointer">
              <option value="always">ê³„ì† (ë§¤ ë¼ìš´ë“œ)</option>
              <option value="once">1ë²ˆë§Œ</option>
            </select>
            <span style="font-size:11px;color:var(--muted)">ì„ í”½ê¶Œìê°€ ë¨¼ì € ë½‘ê³ , ìƒëŒ€ê°€ ë½‘ìŠµë‹ˆë‹¤</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button id="lineConfirmBtn" onclick="confirmLineSelection()" style="display:none;flex:1;padding:14px;background:linear-gradient(135deg,#4ade80,#22c55e);border:none;border-radius:8px;color:#000;font-weight:900;font-size:15px;cursor:pointer;font-family:inherit">í™•ì¸</button>
          <button onclick="closeLineSelectModal()" style="flex:1;padding:14px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-family:inherit;font-size:14px">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- ë“œë˜í”„íŠ¸ ë°©ì‹ ì„ íƒ ëª¨ë‹¬ -->
    <div class="pick-overlay" id="draftMethodOverlay">
      <div class="pick-modal" style="max-width:460px">
        <h3 style="font-size:20px;text-align:center;margin-bottom:16px">ğŸ¯ íŒ€ ë½‘ê¸° ë°©ì‹ ì„ íƒ</h3>
        <div id="draftMethodOptions">
          <div class="draft-method-option" onclick="selectDraftMethod('normal')">
            <div class="dm-icon">âš”ï¸</div>
            <div><div class="dm-title">ì¼ë°˜ ë“œë˜í”„íŠ¸</div>
            <div class="dm-desc">ì‚¬ë‹¤ë¦¬ë¡œ ì„ /í›„ë¥¼ ì •í•˜ê³  ë²ˆê°ˆì•„ 1ëª…ì”© ë½‘ê¸°</div></div>
          </div>
          <div class="draft-method-option" onclick="selectDraftMethod('random')" id="draftRandomOption">
            <div class="dm-icon">ğŸ²</div>
            <div style="flex:1"><div class="dm-title">ëœë¤ íŒ€ë½‘ê¸°</div>
            <div class="dm-desc">ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¤ ëœë¤ìœ¼ë¡œ íŒ€ ë°°ì •!</div>
            <div id="randomShuffleOptions" style="display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
              <div style="font-size:11px;color:var(--muted);margin-bottom:6px">ì…”í”Œ ì˜µì…˜ (í´ë¦­ìœ¼ë¡œ ì„ íƒ)</div>
              <label onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;margin-right:12px;cursor:pointer;font-size:12px;color:var(--text);font-weight:600"><input type="checkbox" id="chkShuffleStreamer" checked style="accent-color:var(--green)">ìŠ¤íŠ¸ë¦¬ë¨¸</label>
              <label onclick="event.stopPropagation()" id="lblShufflePosition" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;color:var(--text);font-weight:600"><input type="checkbox" id="chkShufflePosition" style="accent-color:var(--yellow)">í¬ì§€ì…˜</label>
            </div></div>
          </div>
          <div class="draft-method-option" onclick="selectDraftMethod('custom')">
            <div class="dm-icon">ğŸ‘‘</div>
            <div><div class="dm-title">ì»¤ìŠ¤í…€</div>
            <div class="dm-desc">í•œ ëª…ì´ íŒ€ì› ì „ì› + ì§„ì˜ ì„ íƒê¶Œì„ ê°€ì§</div></div>
          </div>
        </div>
        <button onclick="closeDraftMethodModal()" style="width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;margin-top:12px;font-family:inherit;font-size:13px">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ í”½ì»¤ ì„ íƒ ëª¨ë‹¬ -->
    <div class="pick-overlay" id="customPickerOverlay">
      <div class="pick-modal" style="max-width:420px">
        <h3 style="font-size:18px;text-align:center">ğŸ‘‘ ì»¤ìŠ¤í…€ í”½ì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <div style="font-size:12px;color:var(--muted);text-align:center;margin-bottom:16px">ì´ ì‚¬ëŒì´ íŒ€ì› ì „ì› + ì§„ì˜ì„ ì„ íƒí•©ë‹ˆë‹¤</div>
        <div id="customPickerOptions"></div>
        <button onclick="closeCustomPickerModal()" style="width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;margin-top:12px;font-family:inherit;font-size:13px">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ì£¼ì‚¬ìœ„ ì˜¤ë²„ë ˆì´ -->
    <div id="diceOverlay" class="dice-overlay">
      <div id="diceContainer" class="dice-container"></div>
      <div id="diceResultText" class="dice-result-text"></div>
      <div id="randomAssignArea" class="random-assign-anim"></div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ì„¤ì • í™”ë©´ -->
    <div class="ladder-container" id="customDraftArea" style="display:none">
      <div style="text-align:center;margin-bottom:20px">
        <h2 style="font-family:'Black Han Sans';font-size:26px;color:var(--yellow);margin:0">ğŸ‘‘ <span id="customPickerName"></span> ì»¤ìŠ¤í…€</h2>
        <div style="font-size:12px;color:var(--muted);margin-top:4px" id="customDraftSubtitle">ê° ìŠ¬ë¡¯ì˜ ì„ íƒ ë°©ì‹ì„ ì •í•˜ì„¸ìš”</div>
      </div>
      <div id="customSlotSettings" style="display:flex;flex-direction:column;gap:10px;max-width:500px;margin:0 auto"></div>
      <div style="text-align:center;margin-top:16px">
        <button onclick="setAllCustomSlots('pick')" class="game-btn" style="padding:10px 20px;background:var(--yellow);color:#000;font-size:13px;font-weight:700;margin-right:8px;border-radius:8px">â­ ì „ë¶€ ì„ í”½ê¶Œ</button>
        <button onclick="confirmCustomSettings()" class="game-btn primary" style="padding:12px 32px;font-size:15px">âœ… í™•ì¸ â€” ë“œë˜í”„íŠ¸ ì‹œì‘</button>
      </div>
    </div>

</div>

<script>
let currentTab = 'mission';
let todayMembers = JSON.parse(localStorage.getItem('mk_pick_members') || '[]');
let gameHistory = JSON.parse(localStorage.getItem('mk_pick_history') || '[]');

// ê²Œì„ ëª¨ë“œ: 'solo' (ì†”ë­ë‚´ê¸°) or 'land' (ëœë“œ/CK - ì „ì› ë§ë²¨)
let gameMode = '';

// ì‚¬ë‹¤ë¦¬ ìƒíƒœ
let ladderPlayers = [null, null]; // ì‚¬ë‹¤ë¦¬ 2,3ë²ˆ ìë¦¬ì— ì˜¬ë¦´ ë©¤ë²„
let ladderRungs = []; // ê°€ë¡œì¤„ ë°ì´í„° [{y, fromLine, toLine}]
let rungCount = 3; // ê°€ë¡œì¤„ ìˆ˜ (2~10, ê¸°ë³¸ 3)
let bottomLabels = ['X', 'ì„ ', 'í›„']; // í•˜ë‹¨ ë¼ë²¨ (ì…”í”Œ ê°€ëŠ¥)
let isLadderRunning = false;
let ladderAnimResults = null; // ì‚¬ë‹¤ë¦¬ ê²°ê³¼: {line0ê²°ê³¼, line1ê²°ê³¼, line2ê²°ê³¼}

// ë“œë˜í”„íŠ¸ ìƒíƒœ
let captainFirst = null; // 'ì„ ' ë‹¹ì²¨ì {name,id,img}
let captainSecond = null; // 'í›„' ë‹¹ì²¨ì {name,id,img}
let teamA = [];
let teamB = [];
let draftPool = []; // ë“œë˜í”„íŠ¸ì—ì„œ ë‚¨ì€ ë©¤ë²„
let currentPickTeam = 'A'; // í˜„ì¬ ë½‘ëŠ” íŒ€
let draftStarted = false;
let draftRound = 0; // í˜„ì¬ ë“œë˜í”„íŠ¸ ë¼ìš´ë“œ (ì‚¬ë‹¤ë¦¬ ëª‡ ë²ˆì§¸ì¸ì§€)
let draftInitialized = false; // íŒ€ì¥ ë°°ì • ì™„ë£Œ ì—¬ë¶€
let firstPickId = ''; // ì„ í”½ê¶Œì ID (ë¹„ì–´ìˆìœ¼ë©´ ì‚¬ë‹¤ë¦¬ë¡œ ê²°ì •)
let firstPickCount = 'always'; // 'once' = 1ë²ˆë§Œ, 'always' = ê³„ì†
let firstPickUsed = false; // 1ë²ˆë§Œì¼ ë•Œ ì‚¬ìš©ëëŠ”ì§€

// ì§„ì˜ ì„ íƒ
let teamSide = { A: 'blue', B: 'red' }; // ê¸°ë³¸ê°’
let isSideLadder = false; // ì§„ì˜ ê²°ì • ì‚¬ë‹¤ë¦¬ ëª¨ë“œ

// ë§µ ëª¨ë“œ: 'rift' (í˜‘ê³¡) | 'aram' (ì¹¼ë°”ëŒ)
let mapMode = 'rift';

// ë“œë˜í”„íŠ¸ ë°©ì‹: 'normal' | 'random' | 'custom'
let draftMethod = 'normal';
let customPicker = null; // ì»¤ìŠ¤í…€ ì‹œ ì„ íƒí•œ ì‚¬ëŒ
let customPickTeam = 'A'; // ì»¤ìŠ¤í…€ ì‹œ í˜„ì¬ ë„£ì„ íŒ€

// ë¬¶ë°¸ (ê·¸ë£¹ ë§ë²¨) - ì²´í¬ëœ ë¼ì¸ë¼ë¦¬ í•˜ë‚˜ì˜ ê·¸ë£¹
let bundleChecked = [false, false, false, false, false];

function toggleBundleCheck(posIdx){
  if(membersConfirmed) return;
  bundleChecked[posIdx] = !bundleChecked[posIdx];
  updateTodayMembersList();
}

function getLineGroupKey(lineIdx){
  return bundleChecked[lineIdx] ? 'bundle' : ('solo_' + lineIdx);
}

// í¬ì§€ì…˜
let usedRolesA = [];
let usedRolesB = [];
const ROLES = [
  { key: 'top', name: 'íƒ‘', icon: 'ğŸ—¡ï¸' },
  { key: 'jg', name: 'ì •ê¸€', icon: 'ğŸŒ¿' },
  { key: 'mid', name: 'ë¯¸ë“œ', icon: 'ğŸ”®' },
  { key: 'adc', name: 'ì›ë”œ', icon: 'ğŸ¹' },
  { key: 'sup', name: 'ì„œí¿', icon: 'ğŸ›¡ï¸' }
];

// ìŠ¬ë¡¯ ì¸ë±ìŠ¤ë¡œ í¬ì§€ì…˜ ìë™ ê²°ì • (0,1=íƒ‘, 2,3=ì •ê¸€, 4,5=ë¯¸ë“œ, 6,7=ì›ë”œ, 8,9=ì„œí¿)
function getRoleFromSlot(memberId){
  // ì†”ë­ì€ í¬ì§€ì…˜ ì—†ìŒ
  if(gameMode === 'solo') return { key: 'pick', name: 'PICK', icon: 'ğŸ®' };
  // ì¹¼ë°”ëŒì€ í¬ì§€ì…˜ ì—†ìŒ
  if(mapMode === 'aram') return { key: 'pick', name: 'PICK', icon: 'ğŸ®' };
  const slots = landSlots;
  for(let i = 0; i < slots.length; i++){
    if(slots[i] && slots[i].id === memberId){
      const posIdx = Math.floor(i / 2);
      return ROLES[posIdx] || { key: 'fill', name: 'FILL', icon: 'ğŸ®' };
    }
  }
  return { key: 'fill', name: 'FILL', icon: 'ğŸ®' };
}

// ë©¤ë²„í™•ì • & ë¼ì¸ ì„ íƒ
let membersConfirmed = false; // ë©¤ë²„í™•ì • ì—¬ë¶€
let availableLines = []; // [{idx, a:member, b:member, drafted:false}, ...]
let currentLine = null; // í˜„ì¬ ì„ íƒëœ ë¼ì¸

// ëœë“œ/CK ëª¨ë“œ ê³ ì • 10ìŠ¬ë¡¯ (íƒ‘L,íƒ‘R,ì •ê¸€L,ì •ê¸€R,...,ì„œí¿L,ì„œí¿R)
let landSlots = [null,null,null,null,null,null,null,null,null,null];

// ì†”ë­ ëª¨ë“œ ë™ì  ìŠ¬ë¡¯ (ë¬´ì œí•œ í˜ì–´)
let soloSlots = Array(10).fill(null);
let soloNumPairs = 5; // ì´ˆê¸° í˜ì–´ ìˆ˜ (ë™ì ìœ¼ë¡œ ì¶”ê°€/ì‚­ì œ)

// ë§ë²¨ (ì†”ë­: ìˆ˜ë™ / ëœë“œCK: ì „ì› ê¸°ë³¸ ë§ë²¨)
let matchedPairs = new Map(); // memberId -> partnerId

// ë¡œê·¸ì¸ ë¶ˆí•„ìš” â€” ë°”ë¡œ ì‹œì‘
window.addEventListener('DOMContentLoaded', () => { updateStats(); resetAll(); });

function switchTab(tab, btn){
  currentTab = tab;
  document.querySelectorAll('.nav-btn:not(.status)').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');
}

// ========== ë§µ ëª¨ë“œ (í˜‘ê³¡/ì¹¼ë°”ëŒ) ==========
function setMapMode(mode){
  mapMode = mode;
  var btnR = document.getElementById('btnRift'), btnA = document.getElementById('btnAram');
  if(mode === 'rift'){
    btnR.style.borderColor = 'var(--green)'; btnR.style.background = 'rgba(74,222,128,.2)'; btnR.style.color = 'var(--green)';
    btnA.style.borderColor = 'var(--border)'; btnA.style.background = 'transparent'; btnA.style.color = 'var(--muted)';
  } else {
    btnA.style.borderColor = 'var(--blue)'; btnA.style.background = 'rgba(96,165,250,.2)'; btnA.style.color = 'var(--blue)';
    btnR.style.borderColor = 'var(--border)'; btnR.style.background = 'transparent'; btnR.style.color = 'var(--muted)';
  }
  updateTodayMembersList();
}

// ========== ê²Œì„ ëª¨ë“œ ì„ íƒ ==========
function selectGameMode(mode){
  gameMode = mode;
  document.getElementById('gameModeSelector').style.display = 'none';
  document.getElementById('memberSection').style.display = '';
  document.getElementById('mapToggle').style.display = mode === 'land' ? 'inline-flex' : 'none';

  if(mode === 'solo'){
    // ì†”ë­ëª¨ë“œ: ë™ì  ìŠ¬ë¡¯ (ë©¤ë²„ ìˆ˜ì— ë§ê²Œ)
    soloNumPairs = Math.max(2, Math.ceil(todayMembers.length / 2));
    if(soloNumPairs < 2) soloNumPairs = 2;
    soloSlots = Array(soloNumPairs * 2).fill(null);
    for(let i = 0; i < todayMembers.length && i < soloSlots.length; i++){
      soloSlots[i] = todayMembers[i];
    }
    logEvent('ì†”ë­ ë‚´ê¸° ëª¨ë“œ: ë©¤ë²„ë¥¼ ë“±ë¡í•˜ì„¸ìš”. (+ ë²„íŠ¼ìœ¼ë¡œ í˜ì–´ ì¶”ê°€ ê°€ëŠ¥)');
  } else {
    // ëœë“œëª¨ë“œ: landSlots ì´ˆê¸°í™” í›„ ê¸°ì¡´ todayMembersë¡œ ì±„ìš°ê¸°
    landSlots = [null,null,null,null,null,null,null,null,null,null];
    for(let i = 0; i < todayMembers.length && i < 10; i++){
      landSlots[i] = todayMembers[i];
    }
    logEvent('ëœë“œ/CK ëª¨ë“œ: ì „ì› ìë™ ë§ë²¨! ë©¤ë²„ë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
  }
  updateTodayMembersList();
  updateMatchPairs();
}

// ========== ë§ë²¨ í˜ì–´ ì—…ë°ì´íŠ¸ ==========
function updateMatchPairs(){
  matchedPairs.clear();
  const slots = gameMode === 'solo' ? soloSlots : landSlots;
  if(gameMode === 'land'){
    // ëœë“œ/CK: ìŠ¬ë¡¯ í˜ì–´ ê¸°ë°˜ ë§ë²¨ (0-1, 2-3, 4-5, 6-7, 8-9) â€” ì „ì› ìë™ ë§ë²¨
    for(let i = 0; i < 10; i += 2){
      const a = slots[i];
      const b = slots[i + 1];
      if(a && b){
        matchedPairs.set(a.id, b.id);
        matchedPairs.set(b.id, a.id);
      }
    }
  }
  // ì†”ë­ì€ ìˆ˜ë™ ë§ë²¨ì´ë¯€ë¡œ ì—¬ê¸°ì„œ ìë™ ì„¤ì •í•˜ì§€ ì•ŠìŒ
}

// slotsì—ì„œ todayMembers ë™ê¸°í™”
function syncTodayMembersFromSlots(){
  const slots = gameMode === 'solo' ? soloSlots : landSlots;
  todayMembers = slots.filter(s => s !== null);
  saveTodayMembers();
}

// ========== ì†”ë­ í˜ì–´ ì¶”ê°€/ì‚­ì œ ==========
function addSoloPair(){
  soloNumPairs++;
  soloSlots.push(null, null);
  updateTodayMembersList();
}
function removeSoloPair(){
  if(soloNumPairs <= 2) return;
  const lastIdx = (soloNumPairs - 1) * 2;
  if(soloSlots[lastIdx] || soloSlots[lastIdx + 1]){
    if(!confirm('ë§ˆì§€ë§‰ í˜ì–´ì— ë©¤ë²„ê°€ ìˆìŠµë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  }
  soloSlots.splice(lastIdx, 2);
  soloNumPairs--;
  syncTodayMembersFromSlots();
  updateTodayMembersList();
}

// ========== ë§ë²¨ ìˆ˜ë™ í† ê¸€ (ì†”ë­ ëª¨ë“œ) ==========
function toggleManualMatch(memberId1, memberId2, checked){
  if(checked){
    // ê¸°ì¡´ ë§ë²¨ í•´ì œ
    if(matchedPairs.has(memberId1)){
      const oldPartner = matchedPairs.get(memberId1);
      matchedPairs.delete(oldPartner);
    }
    if(matchedPairs.has(memberId2)){
      const oldPartner = matchedPairs.get(memberId2);
      matchedPairs.delete(oldPartner);
    }
    matchedPairs.set(memberId1, memberId2);
    matchedPairs.set(memberId2, memberId1);
  } else {
    matchedPairs.delete(memberId1);
    matchedPairs.delete(memberId2);
  }
  updateTodayMembersList();
}

// ========== ê°€ë¡œì¤„ ìˆ˜ ë³€ê²½ ==========
function updateRungCount(val){
  rungCount = Math.max(2, Math.min(10, parseInt(val) || 3));
  document.getElementById('rungCount').value = rungCount;
  drawLadder();
}

// ========== ì‚¬ë‹¤ë¦¬ ì°¸ê°€ì ì„ íƒ ==========
function openPlayerSelect(slotIndex){
  if(ladderReady){ clickLadderLine(slotIndex + 1); return; }
  if(isLadderRunning || draftStarted) return;
  const overlay = document.getElementById('pickOverlay');
  const options = document.getElementById('pickOptions');
  document.getElementById('pickTitle').textContent = (slotIndex + 2) + 'ë²ˆ ìë¦¬ì— ì˜¬ë¦´ ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”';
  options.innerHTML = '';

  const available = todayMembers.filter(m => {
    // ì´ë¯¸ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ìˆìœ¼ë©´ ì œì™¸
    const otherSlot = slotIndex === 0 ? 1 : 0;
    return !(ladderPlayers[otherSlot] && ladderPlayers[otherSlot].id === m.id);
  });

  if(available.length === 0){
    options.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }

  available.forEach(member => {
    const opt = document.createElement('div');
    opt.className = 'pick-option';
    opt.innerHTML =
      '<img src="' + (member.profileImage || 'icon.png') + '" onerror="this.src=\'icon.png\'">' +
      '<div><div class="pick-name">' + member.name + '</div><div class="pick-id">@' + member.id + '</div></div>';
    opt.onclick = () => {
      let imgUrl = member.profileImage || 'icon.png';
      if(imgUrl && !imgUrl.startsWith('http') && imgUrl !== 'icon.png') imgUrl = 'https://res.sooplive.co.kr' + imgUrl;
      ladderPlayers[slotIndex] = { name: member.name, id: member.id, img: imgUrl };
      closePickModal();
      renderLadderSlots();
      drawLadder();
      checkLadderReady();
    };
    options.appendChild(opt);
  });

  overlay.classList.add('active');
}

function closePickModal(){
  document.getElementById('pickOverlay').classList.remove('active');
}

// ========== ì‚¬ë‹¤ë¦¬ ìŠ¬ë¡¯ ë Œë”ë§ ==========
function renderLadderSlots(){
  for(let i = 0; i < 2; i++){
    const slot = document.getElementById('ladderSlot' + (i + 1));
    if(!slot) continue;
    const player = ladderPlayers[i];
    slot.onclick = function(){ openPlayerSelect(i); };
    slot.style.cursor = 'pointer';
    if(player){
      slot.innerHTML =
        '<img src="' + (player.img || 'icon.png') + '" onerror="this.src=\'icon.png\'" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--green);margin-bottom:4px">' +
        '<div style="font-size:12px;font-weight:700;color:var(--text)">' + player.name + '</div>' +
        '<div style="font-size:9px;color:var(--muted)">í´ë¦­í•˜ì—¬ ë³€ê²½</div>';
      slot.style.borderStyle = 'solid';
      slot.style.borderColor = 'var(--green)';
      slot.style.background = 'rgba(74,222,128,.05)';
    } else {
      slot.innerHTML =
        '<div style="font-size:11px;color:var(--muted);margin-bottom:4px">' + (i + 2) + 'ë²ˆ ìë¦¬</div>' +
        '<div style="font-size:13px;color:var(--text2)">ë©¤ë²„ í´ë¦­</div>';
      slot.style.borderStyle = 'dashed';
      slot.style.borderColor = 'var(--green)';
      slot.style.background = 'var(--bg)';
    }
  }
}

// ========== í•˜ë‹¨ ë¼ë²¨ ì…”í”Œ (X/ì„ /í›„ ìˆœì„œ ë³€ê²½) ==========
function assignBottomLabel(slotIdx){
  if(isLadderRunning) return;
  // ì…”í”Œ ë¡œì§: í´ë¦­í•˜ë©´ ìˆœì„œë¥¼ ëœë¤ìœ¼ë¡œ ì„ìŒ
  // ë˜ëŠ” ì§ì ‘ ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ ìˆê²Œ í•˜ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ
  // ì‚¬ë‹¤ë¦¬ ê²Œì„ì˜ ì˜ë¯¸ëŠ” ì–´ë””ì— ë­ê°€ ìˆëŠ”ì§€ ëª¨ë¥´ëŠ” ê²ƒì´ë¯€ë¡œ ëœë¤ ì…”í”Œ
  for(let i = bottomLabels.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [bottomLabels[i], bottomLabels[j]] = [bottomLabels[j], bottomLabels[i]];
  }
  renderBottomLabels();
  drawLadder();
  logEvent('í•˜ë‹¨ ë¼ë²¨ì´ ì…”í”Œë˜ì—ˆìŠµë‹ˆë‹¤! (ìˆ¨ê¹€ ìƒíƒœë¡œ ì§„í–‰)');
}

function renderBottomLabels(){
  const btns = document.querySelectorAll('.ladder-bottom-btn');
  // ì‹¤ì œ ì‚¬ë‹¤ë¦¬ ê²Œì„ì—ì„œëŠ” í•˜ë‹¨ì„ ê°€ë ¤ì•¼ í•˜ë¯€ë¡œ "?" ë¡œ í‘œì‹œ
  // ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ê³µê°œ
  btns.forEach((btn, i) => {
    if(ladderAnimResults){
      // ê²°ê³¼ ê³µê°œ
      const label = bottomLabels[i];
      btn.textContent = label;
      if(label === 'X'){ btn.style.borderColor = 'var(--red)'; btn.style.color = 'var(--red)'; btn.style.background = 'rgba(239,68,68,.1)'; }
      else if(label === 'ì„ '){ btn.style.borderColor = 'var(--green)'; btn.style.color = 'var(--green)'; btn.style.background = 'rgba(74,222,128,.1)'; }
      else { btn.style.borderColor = 'var(--yellow)'; btn.style.color = 'var(--yellow)'; btn.style.background = 'rgba(234,179,8,.1)'; }
    } else {
      // ìˆ¨ê¹€
      btn.textContent = '?';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = 'var(--text2)';
      btn.style.background = 'rgba(255,255,255,.03)';
    }
  });
}

// ========== ì‚¬ë‹¤ë¦¬ ì¤€ë¹„ í™•ì¸ ==========
function checkLadderReady(){
  const ready = ladderPlayers[0] && ladderPlayers[1];
  document.getElementById('runLadderBtn').disabled = !ready;
}

// ========== 3ì¤„ ì‚¬ë‹¤ë¦¬ ê·¸ë¦¬ê¸° ==========
function drawLadder(){
  const canvas = document.getElementById('ladderCanvas');
  if(!canvas) return;
  const rect = canvas.getBoundingClientRect();
  const W = rect.width || 600;
  const H = 340;
  canvas.width = W * 2;
  canvas.height = H * 2;
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  ctx.clearRect(0, 0, W, H);

  // ê°€ë¡œì¤„ ìˆ˜ê°€ ì—†ìœ¼ë©´ ëœë¤ ìƒì„± (ì´ˆê¸° í‘œì‹œìš©), ìµœì†Œ 7ê°œ ë³´ì¥
  if(!rungCount || rungCount < 7) rungCount = Math.floor(Math.random() * 4) + 7;

  const lineCount = 3;
  const padX = W * 0.12;
  const padTop = 40;
  const padBottom = 30;
  const ladderH = H - padTop - padBottom;
  const gap = (W - padX * 2) / (lineCount - 1);

  // ìƒë‹¨ ë¼ë²¨
  ctx.font = 'bold 13px "Noto Sans KR", sans-serif';
  ctx.textAlign = 'center';

  ctx.fillStyle = '#888888';
  ctx.fillText('X', padX, padTop - 12);

  if(ladderPlayers[0]){
    ctx.fillStyle = '#3b82f6';
    const label1 = ladderReady && !animatedLines.has(1) ? 'â–¼ '+ladderPlayers[0].name : ladderPlayers[0].name;
    ctx.fillText(label1, padX + gap, padTop - 12);
  } else {
    ctx.fillStyle = '#557060';
    ctx.fillText('?', padX + gap, padTop - 12);
  }

  if(ladderPlayers[1]){
    ctx.fillStyle = '#ef4444';
    const label2 = ladderReady && !animatedLines.has(2) ? 'â–¼ '+ladderPlayers[1].name : ladderPlayers[1].name;
    ctx.fillText(label2, padX + gap * 2, padTop - 12);
  } else {
    ctx.fillStyle = '#557060';
    ctx.fillText('?', padX + gap * 2, padTop - 12);
  }

  // ì„¸ë¡œì¤„ 3ê°œ
  ctx.strokeStyle = '#4ade80';
  ctx.lineWidth = 3;
  ctx.shadowColor = 'rgba(74,222,128,0.3)';
  ctx.shadowBlur = 4;
  for(let i = 0; i < lineCount; i++){
    const x = padX + i * gap;
    ctx.beginPath(); ctx.moveTo(x, padTop); ctx.lineTo(x, padTop + ladderH); ctx.stroke();
  }

  // ê°€ë¡œì¤„ ëœë¤ ìƒì„±
  ladderRungs = [];
  for(let r = 0; r < rungCount; r++){
    const y = padTop + (ladderH / (rungCount + 1)) * (r + 1);
    let pair;
    if(r % 2 === 0){
      pair = Math.random() < 0.8 ? [0, 1] : [1, 2];
    } else {
      pair = Math.random() < 0.8 ? [1, 2] : [0, 1];
    }
    const [from, to] = pair;
    ladderRungs.push({ y, fromLine: from, toLine: to });
    ctx.beginPath();
    ctx.moveTo(padX + from * gap, y);
    ctx.lineTo(padX + to * gap, y);
    ctx.stroke();
  }
  ctx.shadowBlur = 0;
}

// ========== ì‚¬ë‹¤ë¦¬ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì• ë‹ˆë©”ì´ì…˜ìš©) ==========
function redrawLadder(){
  const canvas = document.getElementById('ladderCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width / 2;
  const H = 340;
  const lineCount = 3;
  const padX = W * 0.12;
  const padTop = 40;
  const padBottom = 30;
  const ladderH = H - padTop - padBottom;
  const gap = (W - padX * 2) / (lineCount - 1);

  ctx.clearRect(0, 0, W, H);

  // ìƒë‹¨ ë¼ë²¨
  ctx.font = 'bold 13px "Noto Sans KR", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#888888';
  ctx.fillText('X', padX, padTop - 12);
  if(ladderPlayers[0]){
    ctx.fillStyle = '#3b82f6';
    const label1 = ladderReady && !animatedLines.has(1) ? 'â–¼ '+ladderPlayers[0].name : ladderPlayers[0].name;
    ctx.fillText(label1, padX + gap, padTop - 12);
  } else { ctx.fillStyle = '#557060'; ctx.fillText('?', padX + gap, padTop - 12); }
  if(ladderPlayers[1]){
    ctx.fillStyle = '#ef4444';
    const label2 = ladderReady && !animatedLines.has(2) ? 'â–¼ '+ladderPlayers[1].name : ladderPlayers[1].name;
    ctx.fillText(label2, padX + gap * 2, padTop - 12);
  } else { ctx.fillStyle = '#557060'; ctx.fillText('?', padX + gap * 2, padTop - 12); }

  // ì„¸ë¡œì¤„
  ctx.strokeStyle = '#4ade80';
  ctx.lineWidth = 3;
  for(let i = 0; i < lineCount; i++){
    ctx.beginPath(); ctx.moveTo(padX + i * gap, padTop); ctx.lineTo(padX + i * gap, padTop + ladderH); ctx.stroke();
  }

  // ê°€ë¡œì¤„
  ladderRungs.forEach(rung => {
    ctx.beginPath();
    ctx.moveTo(padX + rung.fromLine * gap, rung.y);
    ctx.lineTo(padX + rung.toLine * gap, rung.y);
    ctx.stroke();
  });
}

// ========== 3ì¤„ ì‚¬ë‹¤ë¦¬ ê²½ë¡œ ê³„ì‚° ==========
function calcLadderPath(startLine){
  const canvas = document.getElementById('ladderCanvas');
  const W = canvas.width / 2;
  const lineCount = 3;
  const padX = W * 0.12;
  const padTop = 40;
  const padBottom = 30;
  const ladderH = 340 - padTop - padBottom;
  const gap = (W - padX * 2) / (lineCount - 1);

  let pos = startLine;
  const xOf = p => padX + p * gap;
  const path = [{ x: xOf(pos), y: padTop }];

  // ê°€ë¡œì¤„ì„ yìˆœìœ¼ë¡œ ì •ë ¬
  const sorted = [...ladderRungs].sort((a, b) => a.y - b.y);

  for(const rung of sorted){
    if(rung.fromLine === pos){
      path.push({ x: xOf(pos), y: rung.y });
      pos = rung.toLine;
      path.push({ x: xOf(pos), y: rung.y });
    } else if(rung.toLine === pos){
      path.push({ x: xOf(pos), y: rung.y });
      pos = rung.fromLine;
      path.push({ x: xOf(pos), y: rung.y });
    }
  }

  path.push({ x: xOf(pos), y: padTop + ladderH });
  return { path, endLine: pos };
}

// ========== ì‚¬ë‹¤ë¦¬ ì• ë‹ˆë©”ì´ì…˜ ==========
let skipAnimation = false;
let completedPaths = [];
const ladderColors = ['#888888', '#3b82f6', '#ef4444'];
let ladderReady = false;
let ladderResults = null;
let animatedLines = new Set();

// ì´ˆë¡ ë¡œë´‡ ë§ˆìŠ¤ì½”íŠ¸ ê·¸ë¦¬ê¸°
function drawMascot(ctx, x, y, size){
  const s = size || 12;
  const hs = s / 2;
  ctx.save();
  ctx.fillStyle = '#2a2a2a';
  ctx.beginPath(); ctx.roundRect(x - hs - 3, y - hs*0.4, 4, s*0.5, 2); ctx.fill();
  ctx.beginPath(); ctx.roundRect(x + hs - 1, y - hs*0.4, 4, s*0.5, 2); ctx.fill();
  ctx.fillStyle = '#90d08a';
  ctx.strokeStyle = '#2a2a2a';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.roundRect(x - hs, y - hs, s, s, 2); ctx.fill(); ctx.stroke();
  const eyeW = s * 0.22, eyeH = s * 0.14, eyeY = y - hs * 0.15;
  ctx.fillStyle = '#fff';
  ctx.fillRect(x - hs * 0.6, eyeY - eyeH/2, eyeW, eyeH);
  ctx.fillRect(x + hs * 0.18, eyeY - eyeH/2, eyeW, eyeH);
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(x - hs * 0.48, eyeY - eyeH*0.3, eyeW*0.5, eyeH*0.6);
  ctx.fillRect(x + hs * 0.3, eyeY - eyeH*0.3, eyeW*0.5, eyeH*0.6);
  ctx.strokeStyle = '#3a3a3a'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(x - hs*0.2, y + hs*0.4); ctx.lineTo(x + hs*0.2, y + hs*0.4); ctx.stroke();
  ctx.restore();
}

// ì‚¬ë‹¤ë¦¬ + ì™„ë£Œëœ ê²½ë¡œë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
function redrawWithPaths(){
  redrawLadder();
  const canvas = document.getElementById('ladderCanvas');
  const ctx = canvas.getContext('2d');
  for(const cp of completedPaths){
    drawFullPath(ctx, cp.path, cp.color, cp.endLine);
  }
}

// í•œ ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜ (ë§ˆìŠ¤ì½”íŠ¸ 1ê°œê°€ ë¶€ë“œëŸ½ê²Œ ì´ë™)
async function animateLadderPath(startLine, color){
  const canvas = document.getElementById('ladderCanvas');
  const ctx = canvas.getContext('2d');
  const { path, endLine } = calcLadderPath(startLine);

  if(skipAnimation){
    drawFullPath(ctx, path, color, endLine);
    completedPaths.push({path, color, endLine});
    return endLine;
  }

  const drawnSegments = [];
  for(let i = 0; i < path.length - 1; i++){
    const from = path[i];
    const to = path[i + 1];
    const dist = Math.sqrt((to.x - from.x) ** 2 + (to.y - from.y) ** 2);
    const steps = Math.max(3, Math.round(dist / 12));
    for(let s = 0; s <= steps; s++){
      if(skipAnimation){
        completedPaths.push({path, color, endLine});
        redrawWithPaths();
        return endLine;
      }
      const t = s / steps;
      const x = from.x + (to.x - from.x) * t;
      const y = from.y + (to.y - from.y) * t;

      redrawWithPaths();

      ctx.strokeStyle = color;
      ctx.lineWidth = 5;
      ctx.shadowColor = color + '80';
      ctx.shadowBlur = 8;
      if(drawnSegments.length > 0 || s > 0){
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        for(const seg of drawnSegments) ctx.lineTo(seg.x, seg.y);
        ctx.lineTo(x, y);
        ctx.stroke();
      }
      ctx.shadowBlur = 0;

      drawMascot(ctx, x, y, 16);

      await sleep(8);
    }
    drawnSegments.push({x: to.x, y: to.y});
  }

  completedPaths.push({path, color, endLine});
  redrawWithPaths();
  drawEndMarker(ctx, path[path.length - 1], color, endLine);
  return endLine;
}

// ê²½ë¡œ ì „ì²´ë¥¼ í•œ ë²ˆì— ê·¸ë¦¬ê¸°
function drawFullPath(ctx, path, color, endLine){
  ctx.strokeStyle = color;
  ctx.lineWidth = 5;
  ctx.shadowColor = color + '80';
  ctx.shadowBlur = 8;
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  for(let i = 1; i < path.length; i++) ctx.lineTo(path[i].x, path[i].y);
  ctx.stroke();
  ctx.shadowBlur = 0;
  drawEndMarker(ctx, path[path.length - 1], color, endLine);
}

// ìµœì¢… ìœ„ì¹˜ ë§ˆì»¤
function drawEndMarker(ctx, pos, color, endLine){
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(pos.x, pos.y, 9, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 9px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(bottomLabels[endLine], pos.x, pos.y);
}

// ìƒë‹¨ ì´ë¦„ í´ë¦­ â†’ í•´ë‹¹ ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜
async function clickLadderLine(lineIdx){
  if(!ladderReady || animatedLines.has(lineIdx)) return;
  animatedLines.add(lineIdx);
  skipAnimation = false;
  await animateLadderPath(lineIdx, ladderColors[lineIdx]);

  // 2ê°œ ì™„ë£Œë˜ë©´ ë‚˜ë¨¸ì§€ ìë™ìœ¼ë¡œ ì „ì²´ê²°ê³¼
  if(animatedLines.size >= 2){
    await sleep(200);
    skipAnimation = true;
    for(let i = 0; i < 3; i++){
      if(!animatedLines.has(i)){
        animatedLines.add(i);
        const { path, endLine } = calcLadderPath(i);
        completedPaths.push({path, color: ladderColors[i], endLine});
      }
    }
    redrawWithPaths();
    ladderReady = false;
    document.getElementById('showAllBtn').style.display = 'none';
    renderBottomLabels();
    await sleep(300);
    showLadderResult(ladderResults);
    isLadderRunning = false;
  }
}

// ========== ì‚¬ë‹¤ë¦¬ ì‹¤í–‰ ==========
async function runLadder(){
  if(isLadderRunning) return;
  if(!ladderPlayers[0] || !ladderPlayers[1]){
    logEvent('2ëª…ì˜ ì°¸ê°€ìë¥¼ ë°°ì¹˜í•´ì£¼ì„¸ìš”!');
    return;
  }

  isLadderRunning = true;
  skipAnimation = false;
  ladderAnimResults = null;
  completedPaths = [];
  animatedLines = new Set();
  document.getElementById('runLadderBtn').disabled = true;
  document.getElementById('showAllBtn').style.display = '';
  document.getElementById('ladderResult').style.display = 'none';

  rungCount = Math.floor(Math.random() * 5) + 7;

  for(let i = bottomLabels.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [bottomLabels[i], bottomLabels[j]] = [bottomLabels[j], bottomLabels[i]];
  }

  drawLadder();

  ladderResults = {};
  for(let i = 0; i < 3; i++){
    const { endLine } = calcLadderPath(i);
    ladderResults[i] = { startLine: i, endLine, label: bottomLabels[endLine] };
  }
  ladderAnimResults = ladderResults;

  // í•˜ë‹¨ ë¼ë²¨ ê³µê°œ (ì…”í”Œ í›„ ë³´ì—¬ì£¼ê¸°)
  renderBottomLabels();

  ladderReady = true;
  logEvent('ì‚¬ë‹¤ë¦¬ ì¤€ë¹„ ì™„ë£Œ! ìƒë‹¨ì˜ ì´ë¦„ì„ í´ë¦­í•˜ì„¸ìš”.');
}

// ========== ì „ì²´ê²°ê³¼ë³´ê¸° (ì• ë‹ˆë©”ì´ì…˜ ìŠ¤í‚µ) ==========
function showAllResults(){
  skipAnimation = true;
  if(ladderReady){
    const canvas = document.getElementById('ladderCanvas');
    const ctx = canvas.getContext('2d');
    for(let i = 0; i < 3; i++){
      if(!animatedLines.has(i)){
        animatedLines.add(i);
        const { path, endLine } = calcLadderPath(i);
        completedPaths.push({path, color: ladderColors[i], endLine});
      }
    }
    redrawWithPaths();
    ladderReady = false;
    document.getElementById('showAllBtn').style.display = 'none';
    renderBottomLabels();
    showLadderResult(ladderResults);
    isLadderRunning = false;
  }
}

// ========== ìº”ë²„ìŠ¤ í´ë¦­ â†’ ì´ë¦„ ìœ„ì¹˜ ê°ì§€ ==========
(function(){
  const cv = document.getElementById('ladderCanvas');
  if(!cv) return;
  cv.style.cursor = 'pointer';
  cv.addEventListener('click', function(e){
    if(!ladderReady) return;
    const rect = cv.getBoundingClientRect();
    const scaleX = (cv.width / 2) / rect.width;
    const scaleY = (cv.height / 2) / rect.height;
    const mx = (e.clientX - rect.left) * scaleX;
    const my = (e.clientY - rect.top) * scaleY;
    const W = cv.width / 2;
    const padX = W * 0.12;
    const gap = (W - padX * 2) / 2;
    if(my < 5 || my > 42) return;
    const hitW = 50;
    for(let i = 0; i < 3; i++){
      const cx = padX + i * gap;
      if(mx >= cx - hitW && mx <= cx + hitW){
        clickLadderLine(i);
        return;
      }
    }
  });
})();

// ========== ì‚¬ë‹¤ë¦¬ ê²°ê³¼ í‘œì‹œ ==========
function showLadderResult(results){
  // ì§„ì˜ ì‚¬ë‹¤ë¦¬ ëª¨ë“œ ë¶„ê¸°
  if(isSideLadder){
    showSideLadderResult(results);
    return;
  }

  const resultDiv = document.getElementById('ladderResult');
  const content = document.getElementById('ladderResultContent');
  resultDiv.style.display = '';

  // 2ëª…ë§Œ ìˆìœ¼ë¯€ë¡œ: í•œ ëª…ì´ ì„ ì´ë©´ ë‹¤ë¥¸ í•œ ëª…ì€ ìë™ìœ¼ë¡œ í›„
  // startLine 1 = ì°¸ê°€ì1, startLine 2 = ì°¸ê°€ì2
  const p1Label = results[1].label; // ì°¸ê°€ì1ì´ ë„ì°©í•œ ë¼ë²¨
  const p2Label = results[2].label; // ì°¸ê°€ì2ê°€ ë„ì°©í•œ ë¼ë²¨

  let firstCaptain = null; // ì„ 
  let secondCaptain = null; // í›„

  // ì§ì ‘ ì„ ì— ë„ì°©í•œ ì‚¬ëŒ ì°¾ê¸°
  if(p1Label === 'ì„ '){
    firstCaptain = ladderPlayers[0];
    secondCaptain = ladderPlayers[1];
  } else if(p2Label === 'ì„ '){
    firstCaptain = ladderPlayers[1];
    secondCaptain = ladderPlayers[0];
  } else if(p1Label === 'í›„'){
    // ì°¸ê°€ì1ì´ í›„ â†’ ì°¸ê°€ì2ê°€ ì„ 
    firstCaptain = ladderPlayers[1];
    secondCaptain = ladderPlayers[0];
  } else if(p2Label === 'í›„'){
    // ì°¸ê°€ì2ê°€ í›„ â†’ ì°¸ê°€ì1ì´ ì„ 
    firstCaptain = ladderPlayers[0];
    secondCaptain = ladderPlayers[1];
  } else {
    // ë‘˜ ë‹¤ Xê°€ ì•„ë‹Œ ê²½ìš°ëŠ” ì—†ì§€ë§Œ (3ì¤„ì´ë‹ˆê¹Œ), ë§Œì•½ ë‘˜ ë‹¤ Xê°€ ì•„ë‹ˆë©´ ëœë¤
    // í•œ ëª…ì´ Xì— ë„ì°©í–ˆìœ¼ë©´ ë‚˜ë¨¸ì§€ í•œ ëª…ì´ ì„  ë˜ëŠ” í›„ì— ê°ˆ ìˆ˜ë°–ì— ì—†ìŒ
    // í•˜ì§€ë§Œ ë‘˜ ë‹¤ Xì— ë„ë‹¬í•  ìˆ˜ëŠ” ì—†ìœ¼ë¯€ë¡œ ìœ„ ì¡°ê±´ì—ì„œ ì²˜ë¦¬ë¨
    // í˜¹ì‹œ ëª¨ë¥¼ ì˜ˆì™¸: ì°¸ê°€ì1ì´ Xë©´ ì°¸ê°€ì2ê°€ ì„  or í›„
    if(p1Label === 'X'){
      if(p2Label === 'ì„ '){ firstCaptain = ladderPlayers[1]; secondCaptain = ladderPlayers[0]; }
      else { firstCaptain = ladderPlayers[0]; secondCaptain = ladderPlayers[1]; }
    } else {
      if(p1Label === 'ì„ '){ firstCaptain = ladderPlayers[0]; secondCaptain = ladderPlayers[1]; }
      else { firstCaptain = ladderPlayers[1]; secondCaptain = ladderPlayers[0]; }
    }
  }

  captainFirst = firstCaptain;
  captainSecond = secondCaptain;

  // ìœ„ìª½ ìŠ¬ë¡¯ì— ì„ /í›„ ê²°ê³¼ í‘œì‹œ
  for(let i = 0; i < 2; i++){
    const slot = document.getElementById('ladderSlot' + (i + 1));
    if(!slot) continue;
    const player = ladderPlayers[i];
    if(!player) continue;
    const isFirst = player.id === firstCaptain.id;
    const label = isFirst ? 'ì„ ' : 'í›„';
    const color = isFirst ? '#4ade80' : '#eab308';
    const borderColor = isFirst ? 'var(--green)' : 'var(--yellow)';
    slot.innerHTML =
      '<img src="' + (player.img || 'icon.png') + '" onerror="this.src=\'icon.png\'" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid ' + borderColor + ';margin-bottom:4px">' +
      '<div style="font-size:14px;font-weight:900;color:var(--text)">' + player.name + '</div>' +
      '<div style="font-size:18px;font-weight:900;color:' + color + ';margin-top:2px">' + label + '</div>';
    slot.style.borderStyle = 'solid';
    slot.style.borderColor = borderColor;
    slot.style.background = isFirst ? 'rgba(74,222,128,.1)' : 'rgba(234,179,8,.1)';
    slot.onclick = null;
    slot.style.cursor = 'default';
  }

  // ì‚¬ë‹¤ë¦¬ ì‹œì‘ ë²„íŠ¼ ìë¦¬ì— ë“œë˜í”„íŠ¸ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
  const runBtn = document.getElementById('runLadderBtn');
  if(!draftInitialized){
    logEvent(firstCaptain.name + ' = ì„ (ë¨¼ì € ë½‘ê¸°), ' + secondCaptain.name + ' = í›„(ë‚˜ì¤‘ì— ë½‘ê¸°)');
    const btnLabel = firstPickId
      ? 'âš”ï¸ íŒ€ì› ë“œë˜í”„íŠ¸ ì‹œì‘ (ì„ í”½ê¶Œ: ' + (todayMembers.find(m=>m.id===firstPickId)?.name||'') + ')'
      : 'âš”ï¸ íŒ€ì› ë“œë˜í”„íŠ¸ ì‹œì‘';
    runBtn.textContent = btnLabel;
    runBtn.onclick = function(){ startDraft(); };
    runBtn.disabled = false;
    runBtn.style.display = '';
  } else {
    logEvent('ë¼ìš´ë“œ ' + (draftRound + 1) + ': ' + firstCaptain.name + ' = ì„ !');
    runBtn.textContent = 'âš”ï¸ íŒ€ì› ë½‘ê¸° ì‹œì‘';
    runBtn.onclick = function(){ startDraft(); };
    runBtn.disabled = false;
    runBtn.style.display = '';
  }

  // í•˜ë‹¨ ê²°ê³¼ ì˜ì—­ì€ ìˆ¨ê¹€ (ìœ„ìª½ ìŠ¬ë¡¯ì— ì´ë¯¸ í‘œì‹œ)
  resultDiv.style.display = 'none';
}

// ========== ì§„ì˜ ì‚¬ë‹¤ë¦¬ ê²°ê³¼ ì²˜ë¦¬ ==========
function showSideLadderResult(results){
  // ladderPlayers[0] = AíŒ€ì¥ (line 1), ladderPlayers[1] = BíŒ€ì¥ (line 2)
  const p1Label = results[1].label; // AíŒ€ì¥ì´ ë„ì°©í•œ ë¼ë²¨
  const p2Label = results[2].label; // BíŒ€ì¥ì´ ë„ì°©í•œ ë¼ë²¨

  // AíŒ€ì¥ì´ ğŸ”µì— ë„ì°©í•˜ë©´ A=ë¸”ë£¨, ğŸ”´ì— ë„ì°©í•˜ë©´ A=ë ˆë“œ
  if(p1Label === 'ğŸ”µ'){
    teamSide = { A: 'blue', B: 'red' };
  } else if(p1Label === 'ğŸ”´'){
    teamSide = { A: 'red', B: 'blue' };
  } else if(p2Label === 'ğŸ”µ'){
    teamSide = { A: 'red', B: 'blue' };
  } else if(p2Label === 'ğŸ”´'){
    teamSide = { A: 'blue', B: 'red' };
  }

  isSideLadder = false;

  // ì‚¬ë‹¤ë¦¬ ê²°ê³¼ í‘œì‹œ
  const resultDiv = document.getElementById('ladderResult');
  const content = document.getElementById('ladderResultContent');
  resultDiv.style.display = '';

  const aIsBlue = teamSide.A === 'blue';
  content.innerHTML =
    '<div style="padding:16px 24px;background:var(--card2);border:2px solid ' + (aIsBlue ? 'var(--team-blue)' : 'var(--team-red)') + ';border-radius:8px;min-width:140px">' +
    '<div style="font-size:20px;font-weight:900;color:' + (aIsBlue ? 'var(--team-blue)' : 'var(--team-red)') + '">' + (aIsBlue ? 'ğŸ”µ ë¸”ë£¨' : 'ğŸ”´ ë ˆë“œ') + '</div>' +
    '<div style="font-size:14px;color:var(--text);margin-top:6px;font-weight:700">' + teamA[0].name + 'íŒ€</div></div>' +
    '<div style="padding:16px 24px;background:var(--card2);border:2px solid ' + (aIsBlue ? 'var(--team-red)' : 'var(--team-blue)') + ';border-radius:8px;min-width:140px">' +
    '<div style="font-size:20px;font-weight:900;color:' + (aIsBlue ? 'var(--team-red)' : 'var(--team-blue)') + '">' + (aIsBlue ? 'ğŸ”´ ë ˆë“œ' : 'ğŸ”µ ë¸”ë£¨') + '</div>' +
    '<div style="font-size:14px;color:var(--text);margin-top:6px;font-weight:700">' + teamB[0].name + 'íŒ€</div></div>';

  applyTeamColors();

  const aName = aIsBlue ? 'ë¸”ë£¨íŒ€' : 'ë ˆë“œíŒ€';
  const bName = aIsBlue ? 'ë ˆë“œíŒ€' : 'ë¸”ë£¨íŒ€';
  logEvent('ì§„ì˜ ê²°ì •! ' + teamA[0].name + 'íŒ€ = ' + aName + ', ' + teamB[0].name + 'íŒ€ = ' + bName);

  // ì ì‹œ í›„ ì‚¬ë‹¤ë¦¬ ìˆ¨ê¸°ê³  ì™„ë£Œ í™”ë©´ìœ¼ë¡œ
  content.innerHTML += '<div style="width:100%;margin-top:12px;text-align:center">' +
    '<button class="game-btn primary" onclick="finishSideLadder()" style="padding:12px 32px;font-size:15px">âœ… í™•ì¸</button></div>';
}

function finishSideLadder(){
  document.getElementById('draftArea').style.display = 'none';
  document.getElementById('ladderSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('teamCompleteArea').style.display = '';

  const aIsBlue = teamSide.A === 'blue';
  const aRgb = aIsBlue ? '59,130,246' : '239,68,68';
  const bRgb = aIsBlue ? '239,68,68' : '59,130,246';

  const renderFinalTeam = (arr, containerId, rgb) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    arr.forEach(m => {
      c.innerHTML += '<div class="team-slot filled" style="border:2px solid rgb(' + rgb + ');background:rgba(' + rgb + ',.05)">' +
        '<img src="' + (m.img || 'icon.png') + '" style="border-color:rgb(' + rgb + ')" onerror="this.src=\'icon.png\'">' +
        '<div><div class="slot-name">' + m.name + '</div>' +
        '<div class="slot-role" style="color:rgb(' + rgb + ')">' + (m.role === 'PICK' ? 'PICK' : m.role || 'PICK') + '</div></div></div>';
    });
  };
  renderFinalTeam(teamA, 'finalTeamA', aRgb);
  renderFinalTeam(teamB, 'finalTeamB', bRgb);
  applyTeamColors();
}

// ========== ë“œë˜í”„íŠ¸ ì‹œì‘ ==========
async function startDraft(){
  if(!captainFirst || !captainSecond) return;

  draftRound++;
  draftStarted = true;
  picksThisRound = 0;

  // ì²« ë¼ìš´ë“œ: íŒ€ì¥ ë°°ì • (í¬ì§€ì…˜ ìë™)
  if(!draftInitialized){
    draftInitialized = true;

    const roleFirst = getRoleFromSlot(captainFirst.id);
    teamA = [{ name: captainFirst.name, id: captainFirst.id, img: captainFirst.img, role: roleFirst.icon + ' ' + roleFirst.name }];

    const roleSecond = getRoleFromSlot(captainSecond.id);
    teamB = [{ name: captainSecond.name, id: captainSecond.id, img: captainSecond.img, role: roleSecond.icon + ' ' + roleSecond.name }];

    draftPool = todayMembers.filter(m => m.id !== captainFirst.id && m.id !== captainSecond.id);

    // í’€ì´ ë¹„ì—ˆìœ¼ë©´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ
    if(draftPool.length === 0){
      setTimeout(() => showTeamComplete(), 800);
      return;
    }
  }

  document.getElementById('draftSection').style.display = '';
  // ì„ /í›„ ì¹´ë“œ(ladderSetupArea)ëŠ” ìœ ì§€, ì‚¬ë‹¤ë¦¬ ìº”ë²„ìŠ¤ë§Œ ìˆ¨ê¸°ê¸°
  document.getElementById('ladderSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('runLadderBtn').style.display = 'none';
  document.getElementById('showAllBtn').style.display = 'none';

  document.getElementById('captainALabel').textContent = '(íŒ€ì¥: ' + teamA[0].name + ')';
  document.getElementById('captainBLabel').textContent = '(íŒ€ì¥: ' + teamB[0].name + ')';
  // ì„ /í›„ ì¹´ë“œ ì œëª© ì—…ë°ì´íŠ¸
  const setupTitle = document.getElementById('ladderSetupTitle');
  if(setupTitle) setupTitle.textContent = 'ë¼ìš´ë“œ ' + draftRound + ' â€” ' + captainFirst.name + '(ì„ ) vs ' + captainSecond.name + '(í›„)';

  // ì„ í”½ê¶Œ ìœ íš¨ ì—¬ë¶€ íŒë‹¨ (1ë²ˆë§Œì´ê³  ì´ë¯¸ ì‚¬ìš©í–ˆìœ¼ë©´ ë¬´íš¨)
  const isFirstPickActive = firstPickId && !(firstPickCount === 'once' && firstPickUsed);

  if(isFirstPickActive){
    // ì„ í”½ê¶Œìê°€ ë¨¼ì € ë½‘ê¸°
    if(firstPickId === teamA[0].id){
      currentPickTeam = 'A';
    } else if(firstPickId === teamB[0].id){
      currentPickTeam = 'B';
    } else {
      currentPickTeam = captainFirst.id === teamA[0].id ? 'A' : 'B';
    }
  } else {
    // ì‚¬ë‹¤ë¦¬ ì„  ê±¸ë¦° ì‚¬ëŒì´ ë½‘ê¸°
    currentPickTeam = captainFirst.id === teamA[0].id ? 'A' : 'B';
  }
  renderDraft();

  const whoPicksName = currentPickTeam === 'A' ? teamA[0].name : teamB[0].name;
  const pickReason = isFirstPickActive ? 'ì„ í”½ê¶Œ' : 'ì„ ';
  logEvent('ë¼ìš´ë“œ ' + draftRound + ': ' + whoPicksName + '(' + pickReason + ', ' + currentPickTeam + 'íŒ€)ì´ 1ëª…ì„ ë½‘ìŠµë‹ˆë‹¤!');
}

// ========== ë“œë˜í”„íŠ¸ ë Œë”ë§ ==========
function renderDraft(){
  // ë‚¨ì€ ë©¤ë²„
  const poolDiv = document.getElementById('draftPool');
  poolDiv.innerHTML = '';
  document.getElementById('remainingMembers').textContent = draftPool.length;

  if(draftPool.length === 0){
    poolDiv.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;font-size:14px">ëª¨ë“  ë©¤ë²„ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
  } else {
    draftPool.forEach(member => {
      const card = document.createElement('div');
      card.className = 'member-card';
      card.style.cursor = 'pointer';
      card.onclick = () => draftPick(member);

      const img = document.createElement('img');
      img.src = member.profileImage || 'icon.png';
      img.onerror = function(){ this.src = 'icon.png'; };

      const info = document.createElement('div');
      info.className = 'info';
      info.innerHTML = '<div class="name">' + member.name + '</div><div class="id">@' + member.id + '</div>';

      card.appendChild(img);
      card.appendChild(info);
      poolDiv.appendChild(card);
    });
  }

  // ë“œë˜í”„íŠ¸ ìˆœì„œ ì •ë³´
  const aName = teamA.length > 0 ? teamA[0].name : '?';
  const bName = teamB.length > 0 ? teamB[0].name : '?';
  const teamALabel = document.getElementById('teamAName')?.textContent || 'AíŒ€';
  const teamBLabel = document.getElementById('teamBName')?.textContent || 'BíŒ€';
  let orderHtml = 'ë¼ìš´ë“œ ' + draftRound + ' | ' + teamALabel + ': ' + aName + ' | ' + teamBLabel + ': ' + bName;
  const fpActive = firstPickId && !(firstPickCount === 'once' && firstPickUsed);
  if(firstPickId){
    if(fpActive){
      orderHtml += ' | <span style="color:var(--yellow);font-weight:700">â­ì„ í”½ê¶Œ</span>';
    } else {
      orderHtml += ' | <span style="color:var(--muted)">ì„ í”½ê¶Œ ì‚¬ìš©ì™„ë£Œ</span>';
    }
  }
  document.getElementById('draftOrderInfo').innerHTML = orderHtml;

  const pickName = currentPickTeam === 'A' ? aName : bName;
  const pickLabel = firstPickId ? 'ì„ í”½' : 'ì„ ';
  document.getElementById('draftTurnInfo').innerHTML =
    draftPool.length > 0
      ? 'ğŸŸ¢ ' + pickName + '(' + (currentPickTeam === 'A' ? teamALabel : teamBLabel) + ') 1ëª… ë½‘ê¸°!'
      : 'âœ… ë“œë˜í”„íŠ¸ ì™„ë£Œ!';

  // íŒ€ ìŠ¬ë¡¯
  renderDraftTeamSlots();

  // í˜„ì¬ ë½‘ëŠ” íŒ€ í•˜ì´ë¼ì´íŠ¸ (ì§„ì˜ ìƒ‰ìƒ ë°˜ì˜)
  const panelA = document.querySelector('#draftSection .team-panel.team-a');
  const panelB = document.querySelector('#draftSection .team-panel.team-b');
  if(panelA && panelB){
    const aPicking = currentPickTeam === 'A' && draftPool.length > 0;
    const bPicking = currentPickTeam === 'B' && draftPool.length > 0;
    const aPulse = getTeamPulse('A');
    const bPulse = getTeamPulse('B');
    panelA.classList.remove('picking');
    panelB.classList.remove('picking');
    if(aPicking){
      const rgb = aPulse==='blue'?'59,130,246':'239,68,68';
      panelA.style.borderColor = 'rgba('+rgb+',1)';
      panelA.style.boxShadow = '0 0 20px rgba('+rgb+',.35)';
      panelA.style.animation = 'pickPulse-'+aPulse+' 1.5s infinite';
    } else {
      const rgb = getTeamPulse('A')==='blue'?'59,130,246':'239,68,68';
      panelA.style.borderColor = 'rgba('+rgb+',.3)';
      panelA.style.boxShadow = '';
      panelA.style.animation = '';
    }
    if(bPicking){
      const rgb = bPulse==='blue'?'59,130,246':'239,68,68';
      panelB.style.borderColor = 'rgba('+rgb+',1)';
      panelB.style.boxShadow = '0 0 20px rgba('+rgb+',.35)';
      panelB.style.animation = 'pickPulse-'+bPulse+' 1.5s infinite';
    } else {
      const rgb = getTeamPulse('B')==='blue'?'59,130,246':'239,68,68';
      panelB.style.borderColor = 'rgba('+rgb+',.3)';
      panelB.style.boxShadow = '';
      panelB.style.animation = '';
    }
  }
}

function getTeamColor(team){
  const side = teamSide[team];
  if(side === 'red') return 'var(--team-red)';
  if(side === 'blue') return 'var(--team-blue)';
  return team === 'A' ? 'var(--team-blue)' : 'var(--team-red)';
}
function getTeamPulse(team){
  const side = teamSide[team];
  if(side === 'red') return 'red';
  if(side === 'blue') return 'blue';
  return team === 'A' ? 'blue' : 'red';
}
function renderDraftTeamSlots(){
  ['A', 'B'].forEach(team => {
    const arr = team === 'A' ? teamA : teamB;
    const container = document.getElementById('team' + team + 'Slots');
    container.innerHTML = '';
    const isPicking = currentPickTeam === team && draftPool.length > 0;
    const tColor = getTeamColor(team);
    const tPulse = getTeamPulse(team);
    const countEl = document.getElementById('team' + team + 'Count');
    countEl.innerHTML = arr.length + 'ëª…' + (isPicking ? ' <span style="color:' + tColor + ';font-weight:900;animation:pickPulse-' + tPulse + ' 1.5s infinite;font-size:11px"> PICK!</span>' : '');
    arr.forEach(m => {
      container.innerHTML += '<div class="team-slot filled" style="border-color:' + tColor + ';background:rgba(' + (tPulse==='blue'?'59,130,246':'239,68,68') + ',.05)">' +
        '<img src="' + (m.img || 'icon.png') + '" onerror="this.src=\'icon.png\'" style="border-color:' + tColor + '">' +
        '<div><div class="slot-name">' + m.name + '</div>' +
        '<div class="slot-role" style="color:' + tColor + '">' + (m.role === 'PICK' ? 'PICK' : m.role || 'PICK') + '</div></div></div>';
    });
  });
}

// ========== ë¼ìš´ë“œ ë‚´ í”½ ì¹´ìš´íŠ¸ ==========
let picksThisRound = 0; // ì´ë²ˆ ë¼ìš´ë“œì—ì„œ ë½‘ì€ íšŸìˆ˜


// ========== ë“œë˜í”„íŠ¸ ë©¤ë²„ ì„ íƒ ==========
async function draftPick(member){
  if(draftPool.length === 0) return;

  // í¬ì§€ì…˜ ìë™ ë°°ì • (ìŠ¬ë¡¯ ê¸°ë°˜)
  const role = getRoleFromSlot(member.id);

  let imgUrl = member.profileImage || 'icon.png';
  if(imgUrl && !imgUrl.startsWith('http') && imgUrl !== 'icon.png') imgUrl = 'https://res.sooplive.co.kr' + imgUrl;

  const pickMember = { name: member.name, id: member.id, img: imgUrl, role: role.icon + ' ' + role.name };
  const teamColor = currentPickTeam === 'A' ? 'var(--team-blue)' : 'var(--team-red)';
  const teamLabel = currentPickTeam === 'A' ? (document.getElementById('teamAName')?.textContent || 'AíŒ€') : (document.getElementById('teamBName')?.textContent || 'BíŒ€');

  // í”½ ì• ë‹ˆë©”ì´ì…˜
  await showPickAnimation(pickMember, teamLabel, teamColor);

  if(currentPickTeam === 'A'){
    teamA.push(pickMember);
  } else {
    teamB.push(pickMember);
  }
  logEvent(teamLabel + 'ì´(ê°€) ' + member.name + 'ì„(ë¥¼) ' + role.name + 'ìœ¼ë¡œ ì„ íƒ!');

  // í’€ì—ì„œ ì œê±°
  draftPool = draftPool.filter(m => m.id !== member.id);

  // ë§ë²¨ ì²˜ë¦¬: íŒŒíŠ¸ë„ˆëŠ” ë°˜ëŒ€íŒ€ìœ¼ë¡œ ê°™ì€ í¬ì§€ì…˜ ìë™ ë°°ì •
  const partnerId = matchedPairs.get(member.id);
  if(partnerId){
    const partnerInPool = draftPool.find(m => m.id === partnerId);
    if(partnerInPool){
      let pImgUrl = partnerInPool.profileImage || 'icon.png';
      if(pImgUrl && !pImgUrl.startsWith('http') && pImgUrl !== 'icon.png') pImgUrl = 'https://res.sooplive.co.kr' + pImgUrl;
      const partnerMember = { name: partnerInPool.name, id: partnerInPool.id, img: pImgUrl, role: role.icon + ' ' + role.name };

      const oppositeTeam = currentPickTeam === 'A' ? 'B' : 'A';
      if(oppositeTeam === 'A'){ teamA.push(partnerMember); usedRolesA.push(role.key); }
      else { teamB.push(partnerMember); usedRolesB.push(role.key); }
      draftPool = draftPool.filter(m => m.id !== partnerId);
      logEvent('ë§ë²¨! ' + partnerInPool.name + ' â†’ ' + oppositeTeam + 'íŒ€ ' + role.name + ' ìë™ ë°°ì •');
    }
  }

  picksThisRound++;

  // ë§ˆì§€ë§‰ 1ëª… ë‚¨ìœ¼ë©´ ì¸ì› ì ì€ íŒ€ìœ¼ë¡œ ìë™ ë°°ì •
  if(draftPool.length === 1){
    const lastMember = draftPool[0];
    let lImgUrl = lastMember.profileImage || 'icon.png';
    if(lImgUrl && !lImgUrl.startsWith('http') && lImgUrl !== 'icon.png') lImgUrl = 'https://res.sooplive.co.kr' + lImgUrl;
    const smallerTeam = teamA.length <= teamB.length ? 'A' : 'B';
    const remainRole = getRoleFromSlot(lastMember.id);
    const lastPick = { name: lastMember.name, id: lastMember.id, img: lImgUrl, role: remainRole.icon + ' ' + remainRole.name };
    if(smallerTeam === 'A'){ teamA.push(lastPick); usedRolesA.push(remainRole.key); }
    else { teamB.push(lastPick); usedRolesB.push(remainRole.key); }
    draftPool = [];
    logEvent('ë§ˆì§€ë§‰ 1ëª…! ' + lastMember.name + ' â†’ ' + smallerTeam + 'íŒ€ ' + remainRole.name + ' ìë™ ë°°ì •');
  }

  renderDraft();

  // ë“œë˜í”„íŠ¸ ì™„ë£Œ ì²´í¬
  if(draftPool.length === 0){
    if(draftMethod === 'custom'){ onCustomPickDone(); return; }
    setTimeout(() => showTeamComplete(), 1000);
    return;
  }

  // ì»¤ìŠ¤í…€ ëª¨ë“œ
  if(draftMethod === 'custom'){
    // ì‚¬ë‹¤ë¦¬ ìŠ¬ë¡¯: ì„  1ëª… + í›„ 1ëª… = 2ëª… ë½‘ê¸° (2ìŠ¬ë¡¯ ì†Œë¹„)
    if(customSlots[customStep] && customSlots[customStep].type === 'ladder'){
      if(picksThisRound < 2){
        currentPickTeam = currentPickTeam === 'A' ? 'B' : 'A';
        renderDraft();
        const nextName = currentPickTeam === 'A' ? teamA[0].name : teamB[0].name;
        logEvent(nextName + '(í›„) ì°¨ë¡€! 1ëª…ì„ ë½‘ìœ¼ì„¸ìš”.');
        return;
      }
      // 2ëª… ë‹¤ ë½‘ìŒ â†’ 2ìŠ¬ë¡¯ ì†Œë¹„
      customStep++; // í˜„ì¬ ì‚¬ë‹¤ë¦¬ ìŠ¬ë¡¯ + ë‹¤ìŒ ìŠ¬ë¡¯
      onCustomPickDone();
      return;
    }
    // ì¼ë°˜ ì„ /í›„ ìŠ¬ë¡¯: 1ëª…ë§Œ
    onCustomPickDone();
    return;
  }

  // ì„ í”½ê¶Œ ìœ íš¨ ì—¬ë¶€ (1ë²ˆë§Œì´ê³  ì´ë¯¸ ì‚¬ìš©í–ˆìœ¼ë©´ ë¬´íš¨)
  const isFirstPickActive = firstPickId && !(firstPickCount === 'once' && firstPickUsed);

  if(isFirstPickActive){
    // ì„ í”½ê¶Œ ëª¨ë“œ: 2ëª…ì´ ë²ˆê°ˆì•„ ë½‘ìŒ (ì„ í”½ê¶Œì â†’ ìƒëŒ€ â†’ ì‚¬ë‹¤ë¦¬)
    if(picksThisRound < 2){
      // ìƒëŒ€ ì°¨ë¡€
      currentPickTeam = currentPickTeam === 'A' ? 'B' : 'A';
      renderDraft();
      const nextName = currentPickTeam === 'A' ? teamA[0].name : teamB[0].name;
      logEvent(nextName + '(' + currentPickTeam + 'íŒ€) ì°¨ë¡€! 1ëª…ì„ ë½‘ìœ¼ì„¸ìš”.');
    } else {
      // 2ëª… ë‹¤ ë½‘ìŒ â†’ ì„ í”½ê¶Œ ì‚¬ìš© ì™„ë£Œ í‘œì‹œ
      if(firstPickCount === 'once') firstPickUsed = true;
      setTimeout(() => returnToLadder(), 800);
    }
  } else {
    // ì¼ë°˜ ëª¨ë“œ: ì„  1ëª… â†’ í›„ 1ëª… â†’ ë‹¤ì‹œ ì‚¬ë‹¤ë¦¬
    if(picksThisRound < 2){
      currentPickTeam = currentPickTeam === 'A' ? 'B' : 'A';
      renderDraft();
      const nextName = currentPickTeam === 'A' ? teamA[0].name : teamB[0].name;
      logEvent(nextName + '(' + currentPickTeam + 'íŒ€, í›„) ì°¨ë¡€! 1ëª…ì„ ë½‘ìœ¼ì„¸ìš”.');
    } else {
      setTimeout(() => returnToLadder(), 800);
    }
  }
}

// ========== ì†”ë­: ë‹¤ìŒ í˜ì–´ ìë™ ì‚¬ë‹¤ë¦¬ ==========
function startNextSoloLadder(){
  const nextLine = availableLines.find(l => !l.drafted);
  if(!nextLine){
    showTeamComplete();
    return;
  }

  currentLine = nextLine;
  currentLine.drafted = true;
  firstPickId = '';
  firstPickCount = 'always';
  firstPickUsed = false;
  picksThisRound = 0;
  draftInitialized = false;
  captainFirst = null;
  captainSecond = null;

  const m0 = nextLine.a;
  const m1 = nextLine.b;

  let img0 = m0.profileImage || 'icon.png';
  if(img0 && !img0.startsWith('http') && img0 !== 'icon.png') img0 = 'https://res.sooplive.co.kr' + img0;
  let img1 = m1.profileImage || 'icon.png';
  if(img1 && !img1.startsWith('http') && img1 !== 'icon.png') img1 = 'https://res.sooplive.co.kr' + img1;

  ladderPlayers[0] = { name: m0.name, id: m0.id, img: img0 };
  ladderPlayers[1] = { name: m1.name, id: m1.id, img: img1 };

  // ì´ í˜ì–´ì˜ 2ëª…ì„ draftPoolì— ë„£ê¸°
  draftPool = [m0, m1];

  document.getElementById('draftArea').style.display = '';
  document.getElementById('ladderSetupArea').style.display = '';
  document.getElementById('ladderSetupTitle').style.display = 'none';
  document.getElementById('ladderSection').style.display = '';
  document.getElementById('draftSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';
  const runBtn = document.getElementById('runLadderBtn');
  runBtn.style.display = '';
  runBtn.disabled = false;
  const swapBtn = document.getElementById('swapLadderBtn');
  if(swapBtn) swapBtn.style.display = '';

  bottomLabels = ['X', 'ì„ ', 'í›„'];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;

  renderLadderSlots();
  renderBottomLabels();
  drawLadder();

  const pairNum = availableLines.filter(l => l.drafted).length;
  const totalPairs = availableLines.length;
  logEvent('í˜ì–´ ' + pairNum + '/' + totalPairs + ': ' + m0.name + ' vs ' + m1.name + ' ì‚¬ë‹¤ë¦¬! â–¶ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
}

// ========== 1ëª… ë½‘ì€ í›„ ë‹¤ì‹œ ì‚¬ë‹¤ë¦¬ë¡œ ==========
function returnToLadder(){
  document.getElementById('draftSection').style.display = 'none';

  // ì‚¬ë‹¤ë¦¬ ìƒíƒœ ë¦¬ì…‹
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  skipAnimation = false;
  bottomLabels = ['X', 'ì„ ', 'í›„'];

  // ì„ í”½ê¶Œ ìœ íš¨ ì—¬ë¶€ í™•ì¸
  const isFirstPickActive = firstPickId && !(firstPickCount === 'once' && firstPickUsed);

  if(isFirstPickActive){
    // ì„ í”½ê¶Œ ìœ íš¨ â†’ ì‚¬ë‹¤ë¦¬ ìƒëµ, ë°”ë¡œ ë‹¤ìŒ í”½
    logEvent('ì„ í”½ê¶Œ ìœ íš¨! ' + captainFirst.name + 'ì´(ê°€) ë‹¤ì‹œ ë¨¼ì € ë½‘ìŠµë‹ˆë‹¤. (ë‚¨ì€: ' + draftPool.length + 'ëª…)');
    startDraft();
  } else {
    // ì‚¬ë‹¤ë¦¬ ë‹¤ì‹œ ë³´ì´ê¸°
    document.getElementById('ladderSetupArea').style.display = '';
    document.getElementById('ladderSetupTitle').style.display = 'none';
    document.getElementById('ladderSection').style.display = '';
    document.getElementById('draftSection').style.display = 'none';
    document.getElementById('ladderResult').style.display = 'none';
    const runBtn = document.getElementById('runLadderBtn');
    runBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘';
    runBtn.onclick = function(){ runLadder(); };
    runBtn.style.display = '';
    runBtn.disabled = false;
    draftStarted = false;
    picksThisRound = 0;
    const swapBtn = document.getElementById('swapLadderBtn');
    if(swapBtn) swapBtn.style.display = '';

    renderLadderSlots();
    renderBottomLabels();
    drawLadder();

    logEvent('ë¼ìš´ë“œ ' + (draftRound + 1) + ' ì¤€ë¹„! â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘ì„ ëˆŒëŸ¬ ì„ /í›„ë¥¼ ë‹¤ì‹œ ì •í•˜ì„¸ìš”. (ë‚¨ì€ ë©¤ë²„: ' + draftPool.length + 'ëª…)');
  }
}

// ========== ë‹¤ì‹œ ëŒë¦¬ê¸° (ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¬ì‹œì‘) ==========
function redraft(){
  const savedMode = gameMode;
  const savedMethod = draftMethod;
  const savedMembers = [...todayMembers];

  // ë“œë˜í”„íŠ¸ ìƒíƒœë§Œ ì´ˆê¸°í™”
  document.getElementById('teamCompleteArea').style.display = 'none';
  document.getElementById('draftArea').style.display = 'none';
  const sideLadderArea = document.getElementById('sideLadderArea');
  if(sideLadderArea) sideLadderArea.style.display = 'none';
  const sideLadderBtn = document.getElementById('startSideLadderBtn');
  if(sideLadderBtn) sideLadderBtn.style.display = 'none';
  const sideSelectArea = document.getElementById('sideSelectArea');
  if(sideSelectArea) sideSelectArea.style.display = 'none';

  captainFirst = null;
  captainSecond = null;
  teamA = [];
  teamB = [];
  draftPool = [];
  draftStarted = false;
  draftRound = 0;
  draftInitialized = false;
  firstPickId = '';
  firstPickCount = 'always';
  firstPickUsed = false;
  currentLine = null;
  picksThisRound = 0;
  currentPickTeam = 'A';
  teamSide = { A: 'blue', B: 'red' };
  isSideLadder = false;
  customPicker = null;
  customPickTeam = 'A';
  customSlots = [];
  customStep = 0;
  customCounterPicker = null;
  usedRolesA = [];
  usedRolesB = [];
  ladderPlayers = [null, null];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  bottomLabels = ['X', 'ì„ ', 'í›„'];

  // ì‚¬ë‹¤ë¦¬ ë²„íŠ¼ ë³µì›
  const rdBtn = document.getElementById('runLadderBtn');
  if(rdBtn){ rdBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘'; rdBtn.onclick = function(){ runLadder(); }; rdBtn.disabled = true; }

  // íŒ€ ì´ë¦„ ë³µì›
  const teamANameEl = document.getElementById('teamAName');
  const teamBNameEl = document.getElementById('teamBName');
  if(teamANameEl) teamANameEl.textContent = 'AíŒ€';
  if(teamBNameEl) teamBNameEl.textContent = 'BíŒ€';
  const fAName = document.getElementById('finalTeamAName');
  const fBName = document.getElementById('finalTeamBName');
  if(fAName) fAName.textContent = 'AíŒ€';
  if(fBName) fBName.textContent = 'BíŒ€';

  // ë¼ì¸ ì¬ìƒì„±
  availableLines = [];
  for(let i = 0; i < todayMembers.length; i += 2){
    availableLines.push({ idx: i / 2, a: todayMembers[i], b: todayMembers[i + 1], drafted: false });
  }

  // ë©¤ë²„ ì„¹ì…˜ ë³µì›
  const memberSection = document.getElementById('memberSection');
  if(memberSection){ memberSection.style.maxHeight = ''; memberSection.style.overflow = ''; memberSection.style.opacity = ''; }

  draftMethod = savedMethod;

  if(savedMethod === 'random'){
    startRandomTeamDraft();
  } else if(savedMethod === 'custom'){
    openCustomPickerModal();
  } else {
    autoSelectFirstLine();
  }
  logEvent('ë‹¤ì‹œ ëŒë¦¬ê¸°! ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¬ì‹œì‘í•©ë‹ˆë‹¤.');
}

// ========== ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸° (ë©¤ë²„ í™•ì • ìƒíƒœë¡œ) ==========
function goBackToMembers(){
  const savedMode = gameMode;

  // ë“œë˜í”„íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
  document.getElementById('teamCompleteArea').style.display = 'none';
  document.getElementById('draftArea').style.display = 'none';
  document.getElementById('customDraftArea').style.display = 'none';
  const sideLadderArea2 = document.getElementById('sideLadderArea');
  if(sideLadderArea2) sideLadderArea2.style.display = 'none';
  const sideLadderBtn2 = document.getElementById('startSideLadderBtn');
  if(sideLadderBtn2) sideLadderBtn2.style.display = 'none';
  const sideSelectArea2 = document.getElementById('sideSelectArea');
  if(sideSelectArea2) sideSelectArea2.style.display = 'none';

  captainFirst = null;
  captainSecond = null;
  teamA = [];
  teamB = [];
  draftPool = [];
  draftStarted = false;
  draftRound = 0;
  draftInitialized = false;
  firstPickId = '';
  firstPickCount = 'always';
  firstPickUsed = false;
  currentLine = null;
  picksThisRound = 0;
  currentPickTeam = 'A';
  teamSide = { A: 'blue', B: 'red' };
  isSideLadder = false;
  draftMethod = 'normal';
  customPicker = null;
  customPickTeam = 'A';
  customSlots = [];
  customStep = 0;
  customCounterPicker = null;
  usedRolesA = [];
  usedRolesB = [];
  ladderPlayers = [null, null];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  bottomLabels = ['X', 'ì„ ', 'í›„'];

  // ì‚¬ë‹¤ë¦¬ ë²„íŠ¼ ë³µì›
  const goBackRunBtn = document.getElementById('runLadderBtn');
  if(goBackRunBtn){ goBackRunBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘'; goBackRunBtn.onclick = function(){ runLadder(); }; goBackRunBtn.disabled = true; }

  // íŒ€ ì´ë¦„ ë³µì›
  const teamANameEl = document.getElementById('teamAName');
  const teamBNameEl = document.getElementById('teamBName');
  if(teamANameEl) teamANameEl.textContent = 'AíŒ€';
  if(teamBNameEl) teamBNameEl.textContent = 'BíŒ€';
  const fAName = document.getElementById('finalTeamAName');
  const fBName = document.getElementById('finalTeamBName');
  if(fAName) fAName.textContent = 'AíŒ€';
  if(fBName) fBName.textContent = 'BíŒ€';

  membersConfirmed = false;
  availableLines.forEach(l => l.drafted = false);

  // ìŠ¬ë¡¯ ë³µì›
  if(savedMode === 'land'){
    landSlots = [null,null,null,null,null,null,null,null,null,null];
    for(let i = 0; i < todayMembers.length && i < 10; i++){
      landSlots[i] = todayMembers[i];
    }
  } else if(savedMode === 'solo'){
    soloNumPairs = Math.max(2, Math.ceil(todayMembers.length / 2));
    soloSlots = Array(soloNumPairs * 2).fill(null);
    for(let i = 0; i < todayMembers.length && i < soloSlots.length; i++){
      soloSlots[i] = todayMembers[i];
    }
  }

  // ë©¤ë²„ ì„¹ì…˜ ë³µì› & í‘œì‹œ
  const memberSection = document.getElementById('memberSection');
  if(memberSection){
    memberSection.style.display = '';
    memberSection.style.maxHeight = '';
    memberSection.style.overflow = '';
    memberSection.style.opacity = '';
  }

  updateTodayMembersList();
  logEvent('ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤. ë©¤ë²„ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ í™•ì •í•˜ì„¸ìš”!');
}

// ========== íŒ€ ê²°ì„± ì™„ë£Œ ==========
function showTeamComplete(){
  document.getElementById('draftArea').style.display = 'none';
  document.getElementById('teamCompleteArea').style.display = '';

  const renderFinalTeam = (arr, containerId) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    arr.forEach(m => {
      c.innerHTML += '<div class="team-slot filled">' +
        '<img src="' + (m.img || 'icon.png') + '" onerror="this.src=\'icon.png\'">' +
        '<div><div class="slot-name">' + m.name + '</div>' +
        '<div class="slot-role">' + (m.role === 'PICK' ? 'PICK' : m.role || 'PICK') + '</div></div></div>';
    });
  };
  renderFinalTeam(teamA, 'finalTeamA');
  renderFinalTeam(teamB, 'finalTeamB');

  // ì§„ì˜ì´ ì´ë¯¸ ì •í•´ì¡Œìœ¼ë©´ ìƒ‰ìƒ ë°˜ì˜
  if(teamSide.A !== 'blue' || teamSide.B !== 'red'){
    applyTeamColors();
  }

  // ì˜¤ëŠ˜ì˜ ëŒ€ê²°ë©¤ë²„ ì¶•ì†Œ
  const memberSection = document.getElementById('memberSection');
  if(memberSection){
    memberSection.style.maxHeight = '200px';
    memberSection.style.overflow = 'hidden';
    memberSection.style.opacity = '0.6';
    memberSection.style.transition = 'all .3s';
  }

  gameHistory.unshift({ timestamp: new Date().toISOString(), teamA: [...teamA], teamB: [...teamB] });
  if(gameHistory.length > 50) gameHistory.pop();
  localStorage.setItem('mk_pick_history', JSON.stringify(gameHistory));
  updateStats();

  // ëœë“œ/CK ëª¨ë“œ: ì§„ì˜ ì„ íƒ í‘œì‹œ (ëœë¤Â·ì»¤ìŠ¤í…€ì€ ë³„ë„ ì²˜ë¦¬ì´ë¯€ë¡œ ì œì™¸)
  if(gameMode === 'land' && draftMethod !== 'random' && draftMethod !== 'custom'){
    const sideArea = document.getElementById('sideSelectArea');
    const captA = teamA.length > 0 ? teamA[0].name : 'A';
    const captB = teamB.length > 0 ? teamB[0].name : 'B';
    sideArea.innerHTML =
      '<div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:12px">ğŸ® ì§„ì˜ ì„ íƒ</div>' +
      '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">' + captA + 'íŒ€ì˜ ì§„ì˜ì„ ì„ íƒí•˜ì„¸ìš”</div>' +
      '<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap">' +
        '<button onclick="directSideSelect(\'blue\')" class="game-btn" style="padding:16px 32px;background:var(--team-blue);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”µ ' + captA + 'íŒ€ = ë¸”ë£¨</button>' +
        '<button onclick="directSideSelect(\'red\')" class="game-btn" style="padding:16px 32px;background:var(--team-red);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”´ ' + captA + 'íŒ€ = ë ˆë“œ</button>' +
        '<button onclick="startSideLadder()" class="game-btn secondary" style="padding:16px 24px;font-size:14px;font-weight:700;border-radius:12px">ğŸªœ ì‚¬ë‹¤ë¦¬ë¡œ ê²°ì •</button>' +
      '</div>';
    sideArea.style.display = '';
  }
}

// ========== ì‚¬ë‹¤ë¦¬ ì´ˆê¸°í™” ==========
function resetLadder(){
  ladderPlayers = [null, null];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  skipAnimation = false;
  bottomLabels = ['X', 'ì„ ', 'í›„'];
  renderLadderSlots();
  renderBottomLabels();
  drawLadder();
  checkLadderReady();
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('runLadderBtn').disabled = true;
  document.getElementById('showAllBtn').style.display = 'none';
  logEvent('ì‚¬ë‹¤ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ========== ì „ì²´ ì´ˆê¸°í™” ==========
function resetAll(){
  document.getElementById('draftArea').style.display = 'none';
  document.getElementById('teamCompleteArea').style.display = 'none';
  document.getElementById('draftSection').style.display = 'none';
  document.getElementById('ladderSetupArea').style.display = '';
  document.getElementById('ladderSetupTitle').style.display = '';
  document.getElementById('ladderSection').style.display = '';
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('gameModeSelector').style.display = '';
  document.getElementById('memberSection').style.display = 'none';
  const runBtn = document.getElementById('runLadderBtn');
  if(runBtn){ runBtn.style.display = ''; runBtn.disabled = true; runBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘'; runBtn.onclick = function(){ runLadder(); }; }
  const showAllBtn = document.getElementById('showAllBtn');
  if(showAllBtn) showAllBtn.style.display = 'none';
  const swapBtn = document.getElementById('swapLadderBtn');
  if(swapBtn) swapBtn.style.display = 'none';

  // ë¼ì¸ ëª¨ë‹¬ ë‹«ê¸°
  closeLineSelectModal();

  gameMode = '';
  ladderPlayers = [null, null];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  bottomLabels = ['X', 'ì„ ', 'í›„'];
  captainFirst = null;
  captainSecond = null;
  teamA = [];
  teamB = [];
  draftPool = [];
  draftStarted = false;
  draftRound = 0;
  draftInitialized = false;
  firstPickId = '';
  firstPickCount = 'always';
  firstPickUsed = false;
  membersConfirmed = false;
  availableLines = [];
  currentLine = null;
  landSlots = [null,null,null,null,null,null,null,null,null,null];
  soloNumPairs = 5;
  soloSlots = Array(soloNumPairs * 2).fill(null);
  activeSlotIdx = -1;
  picksThisRound = 0;
  matchedPairs.clear();
  currentPickTeam = 'A';
  teamSide = { A: 'blue', B: 'red' };
  isSideLadder = false;
  draftMethod = 'normal';
  customPicker = null;
  customPickTeam = 'A';
  customSlots = [];
  customStep = 0;
  customCounterPicker = null;
  usedRolesA = [];
  usedRolesB = [];
  pendingPickMember = null;
  pendingPickResolve = null;

  // ì»¤ìŠ¤í…€ / ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
  document.getElementById('customDraftArea').style.display = 'none';
  closeDraftMethodModal();
  closeCustomPickerModal();
  document.getElementById('diceOverlay').classList.remove('show');
  const sideLadderArea2 = document.getElementById('sideLadderArea');
  if(sideLadderArea2) sideLadderArea2.style.display = 'none';

  // ì§„ì˜ ê´€ë ¨ UI ìˆ¨ê¸°ê¸°
  const sideLadderBtn = document.getElementById('startSideLadderBtn');
  if(sideLadderBtn) sideLadderBtn.style.display = 'none';
  const sideSelectArea = document.getElementById('sideSelectArea');
  if(sideSelectArea) sideSelectArea.style.display = 'none';

  // íŒ€ ì´ë¦„ ë³µì›
  const teamANameEl = document.getElementById('teamAName');
  const teamBNameEl = document.getElementById('teamBName');
  if(teamANameEl) teamANameEl.textContent = 'AíŒ€';
  if(teamBNameEl) teamBNameEl.textContent = 'BíŒ€';
  const teamAH = document.getElementById('teamAHeader');
  const teamBH = document.getElementById('teamBHeader');
  if(teamAH) teamAH.style.color = 'var(--team-blue)';
  if(teamBH) teamBH.style.color = 'var(--team-red)';
  const fAName = document.getElementById('finalTeamAName');
  const fBName = document.getElementById('finalTeamBName');
  if(fAName) fAName.textContent = 'AíŒ€';
  if(fBName) fBName.textContent = 'BíŒ€';

  // ë©¤ë²„ ì„¹ì…˜ ë³µì› (ì¶•ì†Œ í•´ì œ)
  const memberSection2 = document.getElementById('memberSection');
  if(memberSection2){
    memberSection2.style.maxHeight = '';
    memberSection2.style.overflow = '';
    memberSection2.style.opacity = '';
  }

  renderLadderSlots();
  renderBottomLabels();
  checkLadderReady();
  updateTodayMembersList();
  logEvent('ê²Œì„ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// ========== ì´ë²¤íŠ¸ ë¡œê·¸ ==========
function logEvent(text){
  const bar = document.getElementById('eventBar');
  if(bar) bar.innerHTML = '<span class="event-icon">ğŸ’¡</span><span class="event-text">' + text + '</span>';
}

// ========== í†µê³„ ==========
function updateStats(){
  // ìƒíƒœ ì¹´ë“œ ì œê±°ë¨
}

// ========== ì˜¤ëŠ˜ì˜ ë©¤ë²„ ê´€ë¦¬ ==========
let memberSearchTimeout = null;
let searchHighlightIdx = -1; // ê²€ìƒ‰ ê²°ê³¼ ë°©í–¥í‚¤ í•˜ì´ë¼ì´íŠ¸ ì¸ë±ìŠ¤
let memberInputComposing = false; // IME í•œê¸€ ì…ë ¥ ì¡°í•© ì¤‘ ì—¬ë¶€
let liveStatusCache = {}; // { bid: { live: bool, bno: '', title: '' } }
let liveCheckInterval = null;

async function checkLiveStatus(){
  const slots = gameMode === 'solo' ? soloSlots : landSlots;
  const bids = slots.filter(s => s && s.id).map(s => s.id);
  if(!bids.length) return;
  try {
    const resp = await fetch('/api/live-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bids })
    });
    const data = await resp.json();
    if(data.results){
      liveStatusCache = { ...liveStatusCache, ...data.results };
      // DOM ì—…ë°ì´íŠ¸ (ë¦¬ë Œë” ì—†ì´)
      document.querySelectorAll('.live-indicator[data-bid]').forEach(el => {
        const bid = el.dataset.bid;
        const status = liveStatusCache[bid];
        if(status && status.live){
          el.className = 'live-indicator on-air';
          el.title = 'ë°©ì†¡ ì¤‘ - í´ë¦­í•˜ì—¬ ì´ë™';
          el.onclick = (e) => { e.stopPropagation(); window.open('https://play.sooplive.co.kr/' + bid, '_blank'); };
        } else {
          el.className = 'live-indicator off-air';
          el.title = 'ë°©ì†¡ ì•ˆ í•¨';
          el.onclick = null;
        }
      });
    }
  } catch(e){ console.error('ë°©ì†¡ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', e); }
}

function startLiveCheck(){
  if(liveCheckInterval) clearInterval(liveCheckInterval);
  checkLiveStatus();
  liveCheckInterval = setInterval(checkLiveStatus, 30000); // 30ì´ˆë§ˆë‹¤
}

function stopLiveCheck(){
  if(liveCheckInterval){ clearInterval(liveCheckInterval); liveCheckInterval = null; }
}

// ê²€ìƒ‰ í´ë¼ì´ì–¸íŠ¸ ìºì‹œ
const _searchClientCache = {};
async function searchStreamerForMember(input) {
  const query = input.value.trim();
  if(memberSearchTimeout) clearTimeout(memberSearchTimeout);
  if(query.length < 1) { hideMemberSearchResults(); return; }
  memberSearchTimeout = setTimeout(async () => {
    if(searchByKeyboard) return;
    // í´ë¼ì´ì–¸íŠ¸ ìºì‹œ í™•ì¸
    const cKey = query.toLowerCase();
    if(_searchClientCache[cKey]) { showMemberSearchResults(_searchClientCache[cKey]); return; }
    try {
      const response = await fetch('/api/search-streamer?q=' + encodeURIComponent(query));
      const data = await response.json();
      if(data.streamers && data.streamers.length > 0) {
        _searchClientCache[cKey] = data.streamers;
        showMemberSearchResults(data.streamers);
      }
      else hideMemberSearchResults();
    } catch(e) { console.error('ë©¤ë²„ ê²€ìƒ‰ ì‹¤íŒ¨:', e); }
  }, 400);
}

let searchByKeyboard = false; // í‚¤ë³´ë“œë¡œ íƒìƒ‰ ì¤‘ì¸ì§€ ì—¬ë¶€

function showMemberSearchResults(streamers) {
  hideMemberSearchResults();
  searchHighlightIdx = 0; // ì²« ë²ˆì§¸ ê²°ê³¼ ìë™ í•˜ì´ë¼ì´íŠ¸
  searchByKeyboard = false;
  const input = document.getElementById('newMemberInput');
  const container = input.parentElement;
  const resultsContainer = document.createElement('div');
  resultsContainer.id = 'memberSearchResults';
  resultsContainer.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:var(--card);border:2px solid var(--green);border-radius:8px;max-height:300px;overflow-y:auto;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.15);margin-top:4px';

  streamers.forEach((streamer, sIdx) => {
    const item = document.createElement('div');
    item.className = 'search-result-item';
    item.dataset.idx = sIdx;
    item.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;border-bottom:1px solid rgba(74,222,128,0.1);transition:all .15s;border-radius:6px;margin:4px';
    item.onmouseover = () => { if(!searchByKeyboard){ searchHighlightIdx = sIdx; updateSearchHighlight(); } };
    item.onmouseout = () => { if(!searchByKeyboard && searchHighlightIdx === sIdx){ searchHighlightIdx = -1; updateSearchHighlight(); } };

    const img = document.createElement('img');
    img.src = streamer.profileImage || 'icon.png';
    img.style.cssText = 'width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--green)';
    img.onerror = function(){ this.src='icon.png'; };

    const info = document.createElement('div');
    info.style.flex = '1';
    info.innerHTML = '<div style="font-size:16px;font-weight:700">' + streamer.name + '</div><div style="font-size:12px;color:var(--muted)">@' + streamer.id + '</div>';

    item.appendChild(img);
    item.appendChild(info);
    item.onclick = () => {
      if(membersConfirmed){ alert('ë©¤ë²„ê°€ í™•ì •ëœ ìƒíƒœì…ë‹ˆë‹¤.'); return; }
      const member = { id: streamer.id, name: streamer.name, profileImage: streamer.profileImage };
      if(gameMode === 'land' || gameMode === 'solo'){
        const slots = gameMode === 'solo' ? soloSlots : landSlots;
        if(slots.some(s => s && s.id === streamer.id)){ input.value = ''; hideMemberSearchResults(); return; }
        let nextEmpty = slots.indexOf(null);
        if(nextEmpty === -1){
          if(gameMode === 'solo'){ addSoloPair(); nextEmpty = soloSlots.indexOf(null); }
          else { alert('ëª¨ë“  ìŠ¬ë¡¯ì´ ì±„ì›Œì ¸ ìˆìŠµë‹ˆë‹¤.'); return; }
        }
        if(gameMode === 'solo') soloSlots[nextEmpty] = member;
        else slots[nextEmpty] = member;
        syncTodayMembersFromSlots();
      }
      updateTodayMembersList();
      input.value = '';
      hideMemberSearchResults();
    };
    resultsContainer.appendChild(item);
  });

  container.style.position = 'relative';
  container.appendChild(resultsContainer);
  updateSearchHighlight(); // ì²« ë²ˆì§¸ ê²°ê³¼ ìë™ í•˜ì´ë¼ì´íŠ¸
}

function hideMemberSearchResults() {
  const existing = document.getElementById('memberSearchResults');
  if(existing) existing.remove();
  searchHighlightIdx = -1;
  searchByKeyboard = false;
}

function updateSearchHighlight(){
  const results = document.getElementById('memberSearchResults');
  if(!results) return;
  const items = results.querySelectorAll('.search-result-item');
  items.forEach((item, i) => {
    if(i === searchHighlightIdx){
      item.style.background = 'rgba(74,222,128,0.15)';
      item.style.borderColor = 'var(--green)';
      item.scrollIntoView({ block: 'nearest' });
    } else {
      item.style.background = 'transparent';
      item.style.borderColor = 'transparent';
    }
  });
}

function addTodayMember() {
  if(membersConfirmed){ alert('ë©¤ë²„ê°€ í™•ì •ëœ ìƒíƒœì…ë‹ˆë‹¤.'); return; }
  const input = document.getElementById('newMemberInput');
  const query = input.value.trim();
  if(!query) return;

  if(gameMode === 'land' || gameMode === 'solo'){
    const slots = gameMode === 'solo' ? soloSlots : landSlots;
    let nextEmpty = slots.indexOf(null);
    if(nextEmpty === -1){
      if(gameMode === 'solo'){ addSoloPair(); nextEmpty = soloSlots.indexOf(null); }
      else { alert('ëª¨ë“  ìŠ¬ë¡¯ì´ ì±„ì›Œì ¸ ìˆìŠµë‹ˆë‹¤.'); return; }
    }
    if(slots.some(s => s && s.name === query)) return;
    if(gameMode === 'solo') soloSlots[nextEmpty] = { id: query, name: query, profileImage: 'icon.png' };
    else slots[nextEmpty] = { id: query, name: query, profileImage: 'icon.png' };
    syncTodayMembersFromSlots();
    updateTodayMembersList();
    input.value = '';
    hideMemberSearchResults();
  }
}

// ëœë“œ ìŠ¬ë¡¯ì— ë©¤ë²„ ë°°ì¹˜ (íŠ¹ì • ìŠ¬ë¡¯ ì§€ì •)
function addMemberToSlot(slotIdx, member){
  if(membersConfirmed) return;
  const slots = gameMode === 'solo' ? soloSlots : landSlots;
  if(slots[slotIdx]) return;
  // ì´ë¯¸ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ìˆìœ¼ë©´ ë¬´ì‹œ
  if(slots.some(s => s && s.id === member.id)) return;
  slots[slotIdx] = member;
  syncTodayMembersFromSlots();
  updateTodayMembersList();
}

function removeTodayMember(memberId) {
  if(membersConfirmed) return;
  if(matchedPairs.has(memberId)){
    const partnerId = matchedPairs.get(memberId);
    matchedPairs.delete(partnerId);
    matchedPairs.delete(memberId);
  }

  if(gameMode === 'land' || gameMode === 'solo'){
    const slots = gameMode === 'solo' ? soloSlots : landSlots;
    // ìŠ¬ë¡¯ì—ì„œ í•´ë‹¹ ë©¤ë²„ë§Œ nullë¡œ
    for(let i = 0; i < 10; i++){
      if(slots[i] && slots[i].id === memberId){
        slots[i] = null;
        break;
      }
    }
    syncTodayMembersFromSlots();
  }
  if(gameMode === 'land' || gameMode === 'solo') updateMatchPairs();
  updateTodayMembersList();
}

function clearTodayMembers() {
  if(membersConfirmed){
    alert('ë©¤ë²„ê°€ í™•ì •ëœ ìƒíƒœì…ë‹ˆë‹¤. ìƒˆ ë“œë˜í”„íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì´ˆê¸°í™”í•˜ì„¸ìš”.');
    return;
  }
  if(confirm('ëª¨ë“  ì˜¤ëŠ˜ ë©¤ë²„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
    todayMembers = [];
    landSlots = [null,null,null,null,null,null,null,null,null,null];
    soloSlots = Array(soloNumPairs * 2).fill(null);
    matchedPairs.clear();
    saveTodayMembers();
    updateTodayMembersList();
  }
}

function fullReset(){
  if(!confirm('ì „ì²´ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë©¤ë²„, ë“œë˜í”„íŠ¸ ìƒíƒœ ëª¨ë‘ ë¦¬ì…‹ë©ë‹ˆë‹¤.')) return;
  todayMembers = [];
  landSlots = [null,null,null,null,null,null,null,null,null,null];
  soloNumPairs = 5;
  soloSlots = Array(soloNumPairs * 2).fill(null);
  matchedPairs.clear();
  saveTodayMembers();
  resetAll();
}

function saveTodayMembers() { localStorage.setItem('mk_pick_members', JSON.stringify(todayMembers)); }

// ë“œë˜ê·¸ ìƒíƒœ
let dragSrcIdx = null;

// ìŠ¬ë¡¯ ì¸ë¼ì¸ ê²€ìƒ‰ ìƒíƒœ
let slotSearchTimeout = null;
let activeSlotIdx = -1; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¬ë¡¯ ì¸ë±ìŠ¤

function updateTodayMembersList() {
  const container = document.getElementById('todayMembersList');
  const confirmBtn = document.getElementById('confirmMembersBtn');

  container.className = 'member-grid';
  container.style.cssText = '';
  container.innerHTML = '';

  if(gameMode === 'land') updateMatchPairs();

  // ====== ëœë“œ/CK: ê³ ì • 5í¬ì§€ì…˜ ìŠ¬ë¡¯ (landSlots ê¸°ë°˜) ======
  if(gameMode === 'land'){
    for(let posIdx = 0; posIdx < ROLES.length; posIdx++){
      const role = ROLES[posIdx];
      const row = document.createElement('div');
      row.className = 'member-pair';

      const label = document.createElement('div');
      label.className = 'pair-label';
      label.textContent = mapMode === 'aram' ? (posIdx + 1) : role.name;
      row.appendChild(label);

      row.appendChild(createLandSlot(posIdx * 2));

      const vs = document.createElement('div');
      vs.className = 'pair-vs';
      vs.textContent = 'VS';
      row.appendChild(vs);

      row.appendChild(createLandSlot(posIdx * 2 + 1));

      // ë¬¶ë°¸ ì²´í¬ë°•ìŠ¤
      if(!membersConfirmed){
        const chk = document.createElement('label');
        chk.style.cssText = 'display:flex;align-items:center;gap:3px;margin-left:6px;cursor:pointer;font-size:10px;color:' + (bundleChecked[posIdx] ? 'var(--yellow)' : 'var(--muted)') + ';font-weight:600;white-space:nowrap';
        chk.innerHTML = '<input type="checkbox" ' + (bundleChecked[posIdx] ? 'checked' : '') + ' style="accent-color:var(--yellow);cursor:pointer" onchange="event.stopPropagation();toggleBundleCheck(' + posIdx + ')">ë¬¶ë°¸';
        row.appendChild(chk);
      } else if(bundleChecked[posIdx]){
        const tag = document.createElement('span');
        tag.textContent = 'ğŸ”—';
        tag.style.cssText = 'font-size:11px;margin-left:4px';
        row.appendChild(tag);
      }

      container.appendChild(row);
    }

    // ë©¤ë²„í™•ì •: í˜ì–´ê°€ ìµœì†Œ 2ìŒ(4ëª…) ì´ìƒ ì™„ì„±ë˜ì–´ì•¼
    if(confirmBtn){
      let completePairs = 0;
      for(let i = 0; i < 10; i += 2){
        if(landSlots[i] && landSlots[i+1]) completePairs++;
      }
      if(!membersConfirmed && completePairs >= 2){
        confirmBtn.style.display = '';
      } else {
        confirmBtn.style.display = 'none';
      }
    }
  } else {
    // ====== ì†”ë­ ëª¨ë“œ (ë™ì  í˜ì–´) ======
    for(let posIdx = 0; posIdx < soloNumPairs; posIdx++){
      const row = document.createElement('div');
      row.className = 'member-pair';

      // í˜ì–´ ë²ˆí˜¸ ë¼ë²¨
      const label = document.createElement('div');
      label.className = 'pair-label';
      label.innerHTML = '<span style="font-size:16px;font-weight:900;color:var(--green)">' + (posIdx + 1) + '</span>';
      label.style.cssText = 'min-width:32px;text-align:center';
      row.appendChild(label);

      row.appendChild(createSoloSlot(posIdx * 2));
      row.appendChild(createSoloSlot(posIdx * 2 + 1));

      // ë§ë²¨ ì²´í¬ë°•ìŠ¤ (ìˆ˜ë™)
      if(!membersConfirmed){
        const memberA = soloSlots[posIdx * 2];
        const memberB = soloSlots[posIdx * 2 + 1];
        if(memberA && memberB){
          const isMatched = matchedPairs.get(memberA.id) === memberB.id;
          const matchCheck = document.createElement('div');
          matchCheck.className = 'match-check';
          matchCheck.innerHTML = '<input type="checkbox" ' + (isMatched ? 'checked' : '') +
            ' onchange="event.stopPropagation();toggleManualMatch(\'' + memberA.id + '\', \'' + memberB.id + '\', this.checked)">' +
            '<span class="match-label">ë§ë²¨</span>';
          row.appendChild(matchCheck);
        }

        // ë§ˆì§€ë§‰ í˜ì–´ë©´ ì‚­ì œ ë²„íŠ¼ (ë¹ˆ í˜ì–´ë§Œ)
        if(posIdx === soloNumPairs - 1 && soloNumPairs > 2 && !memberA && !memberB){
          const delBtn = document.createElement('button');
          delBtn.textContent = 'âˆ’';
          delBtn.title = 'í˜ì–´ ì‚­ì œ';
          delBtn.style.cssText = 'padding:4px 8px;border-radius:4px;border:1px solid var(--red);background:transparent;color:var(--red);font-size:14px;font-weight:700;cursor:pointer;margin-left:4px';
          delBtn.onclick = () => removeSoloPair();
          row.appendChild(delBtn);
        }
      }

      container.appendChild(row);
    }

    // í˜ì–´ ì¶”ê°€ ë²„íŠ¼
    if(!membersConfirmed){
      const addRow = document.createElement('div');
      addRow.style.cssText = 'display:flex;justify-content:center;margin-top:8px';
      const addBtn = document.createElement('button');
      addBtn.innerHTML = '+ í˜ì–´ ì¶”ê°€';
      addBtn.style.cssText = 'padding:8px 20px;border-radius:6px;border:1px dashed var(--green);background:transparent;color:var(--green);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s';
      addBtn.onmouseover = () => { addBtn.style.background = 'rgba(74,222,128,.1)'; };
      addBtn.onmouseout = () => { addBtn.style.background = 'transparent'; };
      addBtn.onclick = () => addSoloPair();
      addRow.appendChild(addBtn);
      container.appendChild(addRow);
    }

    // ë©¤ë²„í™•ì •: í˜ì–´ê°€ ìµœì†Œ 2ìŒ(4ëª…) ì´ìƒ ì™„ì„±ë˜ì–´ì•¼
    if(confirmBtn){
      let completePairs = 0;
      for(let i = 0; i < soloNumPairs; i++){
        if(soloSlots[i * 2] && soloSlots[i * 2 + 1]) completePairs++;
      }
      if(!membersConfirmed && completePairs >= 2){
        confirmBtn.style.display = '';
      } else {
        confirmBtn.style.display = 'none';
      }
    }
  }

  // ìŠ¬ë¡¯ì— ë©¤ë²„ê°€ ìˆìœ¼ë©´ ë°©ì†¡ ìƒíƒœ ì²´í¬ ì‹œì‘
  const anySlots = (gameMode === 'solo' ? soloSlots : landSlots).some(s => s);
  if(anySlots) startLiveCheck();
  else stopLiveCheck();
}

// ====== ëœë“œ ìŠ¬ë¡¯ ìƒì„± ======
function createLandSlot(slotIdx){
  const member = landSlots[slotIdx];
  const slot = document.createElement('div');
  slot.dataset.slotIdx = slotIdx;

  if(member){
    // --- ì±„ì›Œì§„ ìŠ¬ë¡¯ ---
    slot.className = 'member-slot filled';
    slot.draggable = !membersConfirmed;

    const img = document.createElement('img');
    img.src = member.profileImage || 'icon.png';
    img.alt = member.name;
    img.onerror = function(){ this.src='icon.png'; };
    slot.appendChild(img);

    const info = document.createElement('div');
    info.className = 'info';
    info.innerHTML = '<div class="name">' + member.name + '</div>';
    slot.appendChild(info);

    // ë°©ì†¡ ìƒíƒœ ì¸ë””ì¼€ì´í„°
    const liveIndicator = document.createElement('div');
    liveIndicator.className = 'live-indicator';
    liveIndicator.dataset.bid = member.id;
    const liveStatus = liveStatusCache[member.id];
    if(liveStatus && liveStatus.live){
      liveIndicator.classList.add('on-air');
      liveIndicator.title = 'ë°©ì†¡ ì¤‘ - í´ë¦­í•˜ì—¬ ì´ë™';
      liveIndicator.onclick = (e) => { e.stopPropagation(); window.open('https://play.sooplive.co.kr/' + member.id, '_blank'); };
    } else {
      liveIndicator.classList.add('off-air');
      liveIndicator.title = 'ë°©ì†¡ ì•ˆ í•¨';
    }
    slot.appendChild(liveIndicator);

    if(!membersConfirmed){
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove';
      removeBtn.textContent = '\u2715';
      removeBtn.onclick = (e) => { e.stopPropagation(); removeTodayMember(member.id); };
      slot.appendChild(removeBtn);

      // ë“œë˜ê·¸
      slot.addEventListener('dragstart', (e) => {
        dragSrcIdx = slotIdx;
        slot.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      slot.addEventListener('dragend', () => {
        slot.classList.remove('dragging');
        document.querySelectorAll('.member-slot').forEach(c => c.classList.remove('drag-over'));
        dragSrcIdx = null;
      });
    }
  } else {
    // --- ë¹ˆ ìŠ¬ë¡¯: í´ë¦­í•˜ë©´ ì¸ë¼ì¸ ê²€ìƒ‰ ---
    slot.className = 'member-slot empty';
    const placeholder = document.createElement('div');
    placeholder.className = 'slot-placeholder';
    placeholder.textContent = 'í´ë¦­í•˜ì—¬ ì…ë ¥';
    slot.appendChild(placeholder);

    if(!membersConfirmed){
      slot.addEventListener('click', () => {
        if(activeSlotIdx === slotIdx) return; // ì´ë¯¸ í¸ì§‘ ì¤‘
        activateSlotInput(slot, slotIdx, 'land');
      });
    }
  }

  // ë“œë¡­ ëŒ€ìƒ (ì±„ì›Œì§„/ë¹ˆ ìŠ¬ë¡¯ ëª¨ë‘)
  if(!membersConfirmed){
    slot.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      slot.classList.add('drag-over');
    });
    slot.addEventListener('dragleave', () => { slot.classList.remove('drag-over'); });
    slot.addEventListener('drop', (e) => {
      e.preventDefault();
      slot.classList.remove('drag-over');
      const targetSlotIdx = parseInt(slot.dataset.slotIdx);
      if(dragSrcIdx !== null && dragSrcIdx !== targetSlotIdx){
        // landSlots ê°„ êµí™˜/ì´ë™
        const temp = landSlots[targetSlotIdx];
        landSlots[targetSlotIdx] = landSlots[dragSrcIdx];
        landSlots[dragSrcIdx] = temp;
        syncTodayMembersFromSlots();
        updateTodayMembersList();
      }
    });
  }

  return slot;
}

// ====== ì†”ë­ ìŠ¬ë¡¯ ìƒì„± (createLandSlotê³¼ ë™ì¼ êµ¬ì¡°, soloSlots ì‚¬ìš©) ======
function createSoloSlot(slotIdx){
  const member = soloSlots[slotIdx];
  const slot = document.createElement('div');
  slot.dataset.slotIdx = slotIdx;

  if(member){
    slot.className = 'member-slot filled';
    slot.draggable = !membersConfirmed;

    const img = document.createElement('img');
    img.src = member.profileImage || 'icon.png';
    img.alt = member.name;
    img.onerror = function(){ this.src='icon.png'; };
    slot.appendChild(img);

    const info = document.createElement('div');
    info.className = 'info';
    info.innerHTML = '<div class="name">' + member.name + '</div>';
    slot.appendChild(info);

    // ë°©ì†¡ ìƒíƒœ ì¸ë””ì¼€ì´í„°
    const liveIndicator = document.createElement('div');
    liveIndicator.className = 'live-indicator';
    liveIndicator.dataset.bid = member.id;
    const liveStatus = liveStatusCache[member.id];
    if(liveStatus && liveStatus.live){
      liveIndicator.classList.add('on-air');
      liveIndicator.title = 'ë°©ì†¡ ì¤‘ - í´ë¦­í•˜ì—¬ ì´ë™';
      liveIndicator.onclick = (e) => { e.stopPropagation(); window.open('https://play.sooplive.co.kr/' + member.id, '_blank'); };
    } else {
      liveIndicator.classList.add('off-air');
      liveIndicator.title = 'ë°©ì†¡ ì•ˆ í•¨';
    }
    slot.appendChild(liveIndicator);

    if(!membersConfirmed){
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove';
      removeBtn.textContent = '\u2715';
      removeBtn.onclick = (e) => { e.stopPropagation(); removeTodayMember(member.id); };
      slot.appendChild(removeBtn);

      slot.addEventListener('dragstart', (e) => {
        dragSrcIdx = slotIdx;
        slot.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      slot.addEventListener('dragend', () => {
        slot.classList.remove('dragging');
        document.querySelectorAll('.member-slot').forEach(c => c.classList.remove('drag-over'));
        dragSrcIdx = null;
      });
    }
  } else {
    slot.className = 'member-slot empty';
    const placeholder = document.createElement('div');
    placeholder.className = 'slot-placeholder';
    placeholder.textContent = 'í´ë¦­í•˜ì—¬ ì…ë ¥';
    slot.appendChild(placeholder);

    if(!membersConfirmed){
      slot.addEventListener('click', () => {
        if(activeSlotIdx === slotIdx) return;
        activateSlotInput(slot, slotIdx, 'solo');
      });
    }
  }

  if(!membersConfirmed){
    slot.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      slot.classList.add('drag-over');
    });
    slot.addEventListener('dragleave', () => { slot.classList.remove('drag-over'); });
    slot.addEventListener('drop', (e) => {
      e.preventDefault();
      slot.classList.remove('drag-over');
      const targetSlotIdx = parseInt(slot.dataset.slotIdx);
      if(dragSrcIdx !== null && dragSrcIdx !== targetSlotIdx){
        const temp = soloSlots[targetSlotIdx];
        soloSlots[targetSlotIdx] = soloSlots[dragSrcIdx];
        soloSlots[dragSrcIdx] = temp;
        syncTodayMembersFromSlots();
        updateTodayMembersList();
      }
    });
  }

  return slot;
}

// ====== ë¹ˆ ìŠ¬ë¡¯ â†’ ì¸ë¼ì¸ ì…ë ¥ í™œì„±í™” ======
function activateSlotInput(slot, slotIdx, slotMode){
  const useSoloSlots = slotMode === 'solo';
  const slots = useSoloSlots ? soloSlots : landSlots;
  activeSlotIdx = slotIdx;
  slot.className = 'member-slot editing';
  slot.innerHTML = '';

  const input = document.createElement('input');
  input.className = 'slot-input';
  input.placeholder = 'ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ ì…ë ¥...';
  input.type = 'text';
  slot.appendChild(input);

  let slotHighlightIdx = -1;
  let slotResults = null;
  let isComposing = false; // IME í•œê¸€ ì…ë ¥ ì¡°í•© ì¤‘ ì—¬ë¶€

  setTimeout(() => input.focus(), 50);

  // IME ì¡°í•© ì‹œì‘/ì¢…ë£Œ ì¶”ì 
  input.addEventListener('compositionstart', () => { isComposing = true; });
  input.addEventListener('compositionend', () => {
    isComposing = false;
    doSlotSearch(); // ì¡°í•© ì™„ë£Œ í›„ ê²€ìƒ‰ íŠ¸ë¦¬ê±°
  });

  function doSlotSearch(){
    const q = input.value.trim();
    if(slotSearchTimeout) clearTimeout(slotSearchTimeout);
    if(q.length < 1){ hideSlotResults(); return; }
    slotSearchTimeout = setTimeout(async () => {
      const cKey = q.toLowerCase();
      if(_searchClientCache[cKey]) { showSlotResults(_searchClientCache[cKey]); return; }
      try {
        const resp = await fetch('/api/search-streamer?q=' + encodeURIComponent(q));
        const data = await resp.json();
        if(data.streamers && data.streamers.length > 0) {
          _searchClientCache[cKey] = data.streamers;
          showSlotResults(data.streamers);
        }
        else hideSlotResults();
      } catch(e){ console.error(e); }
    }, 400);
  }

  input.addEventListener('input', () => {
    doSlotSearch();
  });

  input.addEventListener('keydown', (e) => {
    if(e.isComposing || isComposing) return; // IME ì¡°í•© ì¤‘ì´ë©´ ë¬´ì‹œ
    if(e.key === 'ArrowDown'){
      e.preventDefault();
      if(slotResults){
        const items = slotResults.querySelectorAll('.slot-search-item');
        slotHighlightIdx = Math.min(slotHighlightIdx + 1, items.length - 1);
        updateSlotHighlight(items);
      }
    } else if(e.key === 'ArrowUp'){
      e.preventDefault();
      if(slotResults){
        const items = slotResults.querySelectorAll('.slot-search-item');
        slotHighlightIdx = Math.max(slotHighlightIdx - 1, -1);
        updateSlotHighlight(items);
      }
    } else if(e.key === 'Enter'){
      e.preventDefault();
      if(slotResults && slotHighlightIdx >= 0){
        const items = slotResults.querySelectorAll('.slot-search-item');
        if(items[slotHighlightIdx]) items[slotHighlightIdx].click();
      } else if(input.value.trim()){
        // ì§ì ‘ ì´ë¦„ ì…ë ¥
        const name = input.value.trim();
        if(!slots.some(s => s && s.name === name)){
          slots[slotIdx] = { id: name, name: name, profileImage: 'icon.png' };
          syncTodayMembersFromSlots();
          activeSlotIdx = -1;
          updateTodayMembersList();
        }
      }
    } else if(e.key === 'Escape'){
      activeSlotIdx = -1;
      updateTodayMembersList();
    }
  });

  input.addEventListener('blur', () => {
    // í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¨¹íˆë„ë¡ ì•½ê°„ ë”œë ˆì´
    setTimeout(() => {
      if(activeSlotIdx === slotIdx){
        activeSlotIdx = -1;
        updateTodayMembersList();
      }
    }, 200);
  });

  function showSlotResults(streamers){
    hideSlotResults();
    slotHighlightIdx = 0; // ì²« ë²ˆì§¸ ìë™ í•˜ì´ë¼ì´íŠ¸
    slotResults = document.createElement('div');
    slotResults.className = 'slot-search-results';
    streamers.forEach((streamer, sIdx) => {
      const item = document.createElement('div');
      item.className = 'slot-search-item' + (sIdx === 0 ? ' highlighted' : '');
      item.innerHTML = '<img src="' + (streamer.profileImage || 'icon.png') + '" onerror="this.src=\'icon.png\'">' +
        '<div><div class="si-name">' + streamer.name + '</div><div class="si-id">@' + streamer.id + '</div></div>';
      function selectStreamer(){
        if(slots.some(s => s && s.id === streamer.id)) return;
        slots[slotIdx] = { id: streamer.id, name: streamer.name, profileImage: streamer.profileImage };
        syncTodayMembersFromSlots();
        activeSlotIdx = -1;
        updateTodayMembersList();
      }
      item.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectStreamer();
      });
      item.addEventListener('click', () => {
        selectStreamer();
      });
      slotResults.appendChild(item);
    });
    slot.appendChild(slotResults);
  }

  function hideSlotResults(){
    if(slotResults){ slotResults.remove(); slotResults = null; }
    slotHighlightIdx = -1;
  }

  function updateSlotHighlight(items){
    items.forEach((item, i) => {
      item.classList.toggle('highlighted', i === slotHighlightIdx);
      if(i === slotHighlightIdx) item.scrollIntoView({ block: 'nearest' });
    });
  }
}

// ========== ë©¤ë²„í™•ì • ==========
function confirmMembers(){
  if(gameMode === 'land'){
    // ëœë“œ: ì™„ì„±ëœ í˜ì–´ë§Œ ì‚¬ìš© (ì›ë˜ posIdx ê¸°ì–µ)
    let pairs = [];
    for(let i = 0; i < 10; i += 2){
      if(landSlots[i] && landSlots[i+1]){
        pairs.push({ a: landSlots[i], b: landSlots[i+1], posIdx: i / 2 });
      }
    }
    if(pairs.length < 2){
      alert('ìµœì†Œ 2ê°œ í¬ì§€ì…˜(4ëª…)ì´ ì™„ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    membersConfirmed = true;
    // todayMembers ë™ê¸°í™” (ì™„ì„±ëœ í˜ì–´ë§Œ ìˆœì„œëŒ€ë¡œ)
    todayMembers = [];
    pairs.forEach(p => { todayMembers.push(p.a); todayMembers.push(p.b); });
    saveTodayMembers();
    availableLines = pairs.map((p, i) => ({ idx: i, a: p.a, b: p.b, drafted: false }));
    // ë¬¶ë°¸ ì •ë³´ë¥¼ í™•ì •ëœ ë¼ì¸ ê¸°ì¤€ìœ¼ë¡œ ì¬ë§¤í•‘
    var newBundle = pairs.map(p => bundleChecked[p.posIdx] || false);
    bundleChecked = newBundle;
  } else {
    // ì†”ë­: soloSlotsì—ì„œ ì™„ì„±ëœ í˜ì–´ë§Œ ì‚¬ìš© (ë™ì )
    let pairs = [];
    for(let i = 0; i < soloNumPairs; i++){
      if(soloSlots[i * 2] && soloSlots[i * 2 + 1]){
        pairs.push({ a: soloSlots[i * 2], b: soloSlots[i * 2 + 1] });
      }
    }
    if(pairs.length < 2){
      alert('ìµœì†Œ 2ê°œ í¬ì§€ì…˜(4ëª…)ì´ ì™„ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    membersConfirmed = true;
    todayMembers = [];
    pairs.forEach(p => { todayMembers.push(p.a); todayMembers.push(p.b); });
    saveTodayMembers();
    availableLines = pairs.map((p, i) => ({ idx: i, a: p.a, b: p.b, drafted: false }));
  }

  updateTodayMembersList();

  // ë©¤ë²„ ì„¹ì…˜ ì¶•ì†Œ (íƒ€ì´í‹€ í´ë¦­ìœ¼ë¡œ í† ê¸€)
  const memberSection = document.getElementById('memberSection');
  if(memberSection){
    memberSection.style.maxHeight = '50px';
    memberSection.style.overflow = 'hidden';
    memberSection.style.opacity = '0.7';
    memberSection.style.transition = 'all 0.3s';
    const toggleHint = document.getElementById('memberToggleHint');
    if(toggleHint) toggleHint.style.display = '';
    const titleEl = document.getElementById('memberSectionTitle');
    if(titleEl){
      titleEl.style.cursor = 'pointer';
      titleEl.onclick = function(){
        if(memberSection.style.maxHeight === '50px'){
          memberSection.style.maxHeight = '';
          memberSection.style.overflow = '';
          memberSection.style.opacity = '1';
          if(toggleHint) toggleHint.textContent = 'â–² ì ‘ê¸°';
        } else {
          memberSection.style.maxHeight = '50px';
          memberSection.style.overflow = 'hidden';
          memberSection.style.opacity = '0.7';
          if(toggleHint) toggleHint.textContent = 'â–¼ í¼ì¹˜ê¸°';
        }
      };
    }
  }

  // ë“œë˜í”„íŠ¸ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
  setTimeout(() => {
    const draftArea = document.getElementById('draftArea');
    if(draftArea) draftArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);

  // ì†”ë­/ëœë“œ ëª¨ë‘ ë“œë˜í”„íŠ¸ ë°©ì‹ ì„ íƒ
  openDraftMethodModal();
  logEvent('ë©¤ë²„ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. íŒ€ ë½‘ê¸° ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”!');
}

// ========== ë¼ì¸ ì„ íƒ ëª¨ë‹¬ ==========
function confirmLineSelection(){
  if(!currentLine) return;

  currentLine.drafted = true;

  // ì„ í”½ê¶Œ ì„¤ì •
  firstPickId = document.getElementById('lineFirstPickSelect')?.value || '';
  firstPickCount = document.getElementById('lineFirstPickCountSelect')?.value || 'always';
  firstPickUsed = false;

  closeLineSelectModal();

  if(firstPickId){
    // ì„ í”½ê¶Œ ìˆìŒ â†’ ì‚¬ë‹¤ë¦¬ ìƒëµ, ë°”ë¡œ í”½
    skipLadderAndStartDraft();
  } else {
    // ì„ í”½ê¶Œ ì—†ìŒ â†’ ì‚¬ë‹¤ë¦¬ íƒ€ê¸°
    goToLadderFromLine();
  }
}

function closeLineSelectModal(){
  document.getElementById('lineSelectOverlay').classList.remove('active');
  // ì•„ì§ ë“œë˜í”„íŠ¸ ì‹œì‘ ì•ˆ í–ˆìœ¼ë©´ í™•ì • í•´ì œ
  if(teamA.length === 0 && teamB.length === 0){
    membersConfirmed = false;
    updateTodayMembersList();
  }
}

// ========== ì„ í”½ê¶Œ â†’ ì‚¬ë‹¤ë¦¬ ìƒëµ, ë°”ë¡œ ë“œë˜í”„íŠ¸ ==========
function skipLadderAndStartDraft(){
  const memberA = currentLine.a;
  const memberB = currentLine.b;

  let imgA = memberA.profileImage || 'icon.png';
  if(imgA && !imgA.startsWith('http') && imgA !== 'icon.png') imgA = 'https://res.sooplive.co.kr' + imgA;
  let imgB = memberB.profileImage || 'icon.png';
  if(imgB && !imgB.startsWith('http') && imgB !== 'icon.png') imgB = 'https://res.sooplive.co.kr' + imgB;

  // ì‚¬ë‹¤ë¦¬ ì°¸ê°€ìë„ ì„¸íŒ… (ì„ í”½ê¶Œ ë§Œë£Œ í›„ ì‚¬ë‹¤ë¦¬ ë³µê·€ ì‹œ í•„ìš”)
  ladderPlayers[0] = { name: memberA.name, id: memberA.id, img: imgA };
  ladderPlayers[1] = { name: memberB.name, id: memberB.id, img: imgB };

  // ì„ í”½ê¶Œì = captainFirst (ì„ )
  if(firstPickId === memberA.id){
    captainFirst = { name: memberA.name, id: memberA.id, img: imgA };
    captainSecond = { name: memberB.name, id: memberB.id, img: imgB };
  } else {
    captainFirst = { name: memberB.name, id: memberB.id, img: imgB };
    captainSecond = { name: memberA.name, id: memberA.id, img: imgA };
  }

  // draftArea í‘œì‹œ, ì‚¬ë‹¤ë¦¬ ìˆ¨ê¸°ê¸°
  document.getElementById('draftArea').style.display = '';
  document.getElementById('ladderSetupArea').style.display = 'none';
  document.getElementById('ladderSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('runLadderBtn').style.display = 'none';
  document.getElementById('showAllBtn').style.display = 'none';

  logEvent('ì„ í”½ê¶Œ: ' + captainFirst.name + 'ì´(ê°€) ë¨¼ì € ë½‘ìŠµë‹ˆë‹¤! (ì‚¬ë‹¤ë¦¬ ìƒëµ)');
  startDraft();
}

// ========== íŒ€ë½‘ê¸°ë¡œ ì´ë™ (ë¼ì¸ ê¸°ë°˜) ==========
function autoSelectFirstLine(){
  const remaining = availableLines.filter(l => !l.drafted);
  if(remaining.length === 0){
    showTeamComplete();
    return;
  }

  if(!draftInitialized){
    // ì²« ë¼ìš´ë“œ: íŒ€ì¥(ë¼ì¸) ì„ íƒ + ì„ í”½ê¶Œ ì„¤ì • ëª¨ë‹¬
    openFirstPickModal();
  } else {
    // ì´í›„ ë¼ìš´ë“œ: ë‹¤ìŒ ë¼ì¸ ìë™ ì„ íƒ â†’ ë°”ë¡œ ì‚¬ë‹¤ë¦¬
    const nextLine = remaining[0];
    currentLine = nextLine;
    currentLine.drafted = true;
    goToLadderFromLine();
  }
}

function openFirstPickModal(){
  const overlay = document.getElementById('lineSelectOverlay');
  const options = document.getElementById('lineSelectOptions');
  const fpArea = document.getElementById('lineFirstPickArea');
  const confirmBtn = document.getElementById('lineConfirmBtn');
  const ROLES = gameMode === 'solo' ? availableLines.map((_,i) => (i+1) + 'ë²ˆ') : (mapMode === 'aram' ? availableLines.map((_,i) => (i+1) + 'ë²ˆ') : ['íƒ‘','ì •ê¸€','ë¯¸ë“œ','ì›ë”œ','ì„œí¿']);

  // ë¼ì¸(í¬ì§€ì…˜) ì„ íƒ ëª©ë¡
  options.innerHTML = '';
  currentLine = null;
  fpArea.style.display = 'none';
  confirmBtn.style.display = 'none';
  document.getElementById('lineSelectTitle').textContent = 'ëˆ„ê°€ íŒ€ì„ ë½‘ì„ê¹Œìš”?';

  availableLines.forEach((line, i) => {
    if(!line.a || !line.b) return; // ë¹ˆ í˜ì–´ ê±´ë„ˆë›°ê¸°
    const opt = document.createElement('div');
    opt.className = 'line-option';
    opt.dataset.lineIdx = i;
    opt.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;border:2px solid var(--border);border-radius:10px;margin-bottom:8px;transition:all .2s';

    let imgA = line.a.profileImage || 'icon.png';
    if(imgA && !imgA.startsWith('http') && imgA !== 'icon.png') imgA = 'https://res.sooplive.co.kr' + imgA;
    let imgB = line.b.profileImage || 'icon.png';
    if(imgB && !imgB.startsWith('http') && imgB !== 'icon.png') imgB = 'https://res.sooplive.co.kr' + imgB;

    opt.innerHTML =
      '<div style="min-width:44px;font-size:13px;font-weight:700;color:var(--green)">' + ROLES[i] + '</div>' +
      '<img src="' + imgA + '" onerror="this.src=\'icon.png\'" style="width:36px;height:36px;border-radius:50%;object-fit:cover">' +
      '<span style="font-weight:700">' + line.a.name + '</span>' +
      '<span style="color:var(--muted);font-size:12px">VS</span>' +
      '<img src="' + imgB + '" onerror="this.src=\'icon.png\'" style="width:36px;height:36px;border-radius:50%;object-fit:cover">' +
      '<span style="font-weight:700">' + line.b.name + '</span>';

    opt.onclick = () => selectLineForDraft(i);
    options.appendChild(opt);
  });

  overlay.classList.add('active');
}

function selectLineForDraft(lineIdx){
  // ì„ íƒ í‘œì‹œ
  document.querySelectorAll('#lineSelectOptions .line-option').forEach(o => {
    o.style.borderColor = 'var(--border)';
    o.style.background = '';
  });
  const opt = document.querySelector('#lineSelectOptions .line-option[data-line-idx="' + lineIdx + '"]');
  if(opt){
    opt.style.borderColor = 'var(--green)';
    opt.style.background = 'rgba(74,222,128,0.1)';
  }

  currentLine = availableLines[lineIdx];

  // ì„ í”½ê¶Œ ì„¤ì • í‘œì‹œ
  const fpArea = document.getElementById('lineFirstPickArea');
  fpArea.style.display = '';

  const sel = document.getElementById('lineFirstPickSelect');
  sel.innerHTML = '<option value="">ì—†ìŒ (ì‚¬ë‹¤ë¦¬ë¡œ ê²°ì •)</option>';
  sel.innerHTML += '<option value="' + currentLine.a.id + '">' + currentLine.a.name + '</option>';
  sel.innerHTML += '<option value="' + currentLine.b.id + '">' + currentLine.b.name + '</option>';

  document.getElementById('lineConfirmBtn').style.display = '';
}

function goToLadderFromLine(){
  const m0 = currentLine.a;
  const m1 = currentLine.b;

  let img0 = m0.profileImage || 'icon.png';
  if(img0 && !img0.startsWith('http') && img0 !== 'icon.png') img0 = 'https://res.sooplive.co.kr' + img0;
  let img1 = m1.profileImage || 'icon.png';
  if(img1 && !img1.startsWith('http') && img1 !== 'icon.png') img1 = 'https://res.sooplive.co.kr' + img1;

  ladderPlayers[0] = { name: m0.name, id: m0.id, img: img0 };
  ladderPlayers[1] = { name: m1.name, id: m1.id, img: img1 };

  document.getElementById('draftArea').style.display = '';
  document.getElementById('ladderSetupArea').style.display = '';
  document.getElementById('ladderSection').style.display = '';
  document.getElementById('draftSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';
  const setupTitle2 = document.getElementById('ladderSetupTitle');
  if(setupTitle2) setupTitle2.textContent = 'STEP 1: ì‚¬ë‹¤ë¦¬ ì°¸ê°€ì ì„ íƒ';
  // ì‚¬ë‹¤ë¦¬ ë²„íŠ¼ ë³µì›
  const runBtn = document.getElementById('runLadderBtn');
  runBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘';
  runBtn.onclick = function(){ runLadder(); };
  runBtn.style.display = '';
  runBtn.disabled = false;
  draftStarted = false;
  picksThisRound = 0;
  // ì‚¬ë‹¤ë¦¬ ìƒíƒœ ë¦¬ì…‹
  bottomLabels = ['X', 'ì„ ', 'í›„'];
  ladderRungs = [];
  ladderAnimResults = null;
  isLadderRunning = false;
  skipAnimation = false;
  // ìŠ¤ì™‘ ë²„íŠ¼ í‘œì‹œ
  const swapBtn = document.getElementById('swapLadderBtn');
  if(swapBtn) swapBtn.style.display = '';

  renderLadderSlots();
  renderBottomLabels();
  drawLadder();
  checkLadderReady();
  logEvent(m0.name + ' vs ' + m1.name + ' ì‚¬ë‹¤ë¦¬! â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
}

// ========== ì‚¬ë‹¤ë¦¬ ìë¦¬ êµí™˜ ==========
function swapLadderPlayers(){
  if(isLadderRunning) return;
  if(!ladderPlayers[0] || !ladderPlayers[1]) return;
  [ladderPlayers[0], ladderPlayers[1]] = [ladderPlayers[1], ladderPlayers[0]];
  renderLadderSlots();
  drawLadder();
  logEvent('ìë¦¬ê°€ êµí™˜ë˜ì—ˆìŠµë‹ˆë‹¤: ' + ladderPlayers[0].name + ' â†” ' + ladderPlayers[1].name);
}

// ========== ì§„ì˜ ê²°ì • ì‚¬ë‹¤ë¦¬ (ëœë“œ/CK) ==========
function startSideLadder(){
  isSideLadder = true;
  document.getElementById('startSideLadderBtn').style.display = 'none';
  document.getElementById('sideSelectArea').style.display = 'none';

  // AíŒ€ì¥ê³¼ BíŒ€ì¥ì„ ì‚¬ë‹¤ë¦¬ì— ë°°ì¹˜
  ladderPlayers[0] = { name: teamA[0].name, id: teamA[0].id, img: teamA[0].img };
  ladderPlayers[1] = { name: teamB[0].name, id: teamB[0].id, img: teamB[0].img };

  // í•˜ë‹¨ ë¼ë²¨: X, ğŸ”µë¸”ë£¨, ğŸ”´ë ˆë“œ
  bottomLabels = ['X', 'ğŸ”µ', 'ğŸ”´'];
  ladderRungs = [];
  rungCount = 0; // drawLadderì—ì„œ ìë™ ìƒì„±ë¨
  ladderAnimResults = null;
  isLadderRunning = false;
  skipAnimation = false;

  // ì‚¬ë‹¤ë¦¬ ì˜ì—­ í‘œì‹œ
  document.getElementById('draftArea').style.display = '';
  document.getElementById('ladderSetupArea').style.display = '';
  document.getElementById('ladderSetupTitle').style.display = 'none';
  document.getElementById('ladderSection').style.display = '';
  document.getElementById('ladderResult').style.display = 'none';
  document.getElementById('draftSection').style.display = 'none';
  const runBtn = document.getElementById('runLadderBtn');
  runBtn.style.display = '';
  runBtn.disabled = false;
  runBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘';
  runBtn.onclick = function(){ runLadder(); };
  const swapBtn = document.getElementById('swapLadderBtn');
  if(swapBtn) swapBtn.style.display = '';

  renderLadderSlots();
  renderBottomLabels();
  drawLadder();
  logEvent('ì§„ì˜ ê²°ì • ì‚¬ë‹¤ë¦¬! ' + teamA[0].name + ' vs ' + teamB[0].name + ' â€” â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
}

function applyTeamColors(){
  const aIsBlue = teamSide.A === 'blue';
  const aColor = aIsBlue ? 'var(--team-blue)' : 'var(--team-red)';
  const bColor = aIsBlue ? 'var(--team-red)' : 'var(--team-blue)';
  const aName = aIsBlue ? 'ë¸”ë£¨íŒ€' : 'ë ˆë“œíŒ€';
  const bName = aIsBlue ? 'ë ˆë“œíŒ€' : 'ë¸”ë£¨íŒ€';

  // ë“œë˜í”„íŠ¸ í—¤ë”
  const teamANameEl = document.getElementById('teamAName');
  const teamBNameEl = document.getElementById('teamBName');
  if(teamANameEl) teamANameEl.textContent = aName;
  if(teamBNameEl) teamBNameEl.textContent = bName;
  const teamAH = document.getElementById('teamAHeader');
  const teamBH = document.getElementById('teamBHeader');
  if(teamAH) teamAH.style.color = aColor;
  if(teamBH) teamBH.style.color = bColor;

  // ìµœì¢… ê²°ê³¼ í—¤ë”
  const fAName = document.getElementById('finalTeamAName');
  const fBName = document.getElementById('finalTeamBName');
  if(fAName) fAName.textContent = aName;
  if(fBName) fBName.textContent = bName;
  const fAH = document.getElementById('finalTeamAHeader');
  const fBH = document.getElementById('finalTeamBHeader');
  if(fAH) fAH.style.color = aColor;
  if(fBH) fBH.style.color = bColor;

  // íŒ¨ë„ í…Œë‘ë¦¬/ë°°ê²½ìƒ‰ ë™ì  ì ìš©
  const aRgb = aIsBlue ? '59,130,246' : '239,68,68';
  const bRgb = aIsBlue ? '239,68,68' : '59,130,246';
  document.querySelectorAll('.team-panel.team-a').forEach(p => {
    p.style.borderColor = 'rgba(' + aRgb + ',.3)';
  });
  document.querySelectorAll('.team-panel.team-b').forEach(p => {
    p.style.borderColor = 'rgba(' + bRgb + ',.3)';
  });
  // ì¹´ë“œ ìƒ‰ìƒ - ID ê¸°ë°˜ ì§ì ‘ ì„ íƒ (finalTeam + draft ì–‘ìª½)
  ['finalTeamA', 'teamASlots'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.querySelectorAll('.team-slot').forEach(s => {
      s.style.borderColor = 'rgb(' + aRgb + ')'; s.style.borderStyle = 'solid'; s.style.background = 'rgba(' + aRgb + ',.05)';
    });
    el.querySelectorAll('.team-slot img').forEach(img => { img.style.borderColor = 'rgb(' + aRgb + ')'; });
    el.querySelectorAll('.team-slot .slot-role').forEach(r => { r.style.color = 'rgb(' + aRgb + ')'; });
  });
  ['finalTeamB', 'teamBSlots'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.querySelectorAll('.team-slot').forEach(s => {
      s.style.borderColor = 'rgb(' + bRgb + ')'; s.style.borderStyle = 'solid'; s.style.background = 'rgba(' + bRgb + ',.05)';
    });
    el.querySelectorAll('.team-slot img').forEach(img => { img.style.borderColor = 'rgb(' + bRgb + ')'; });
    el.querySelectorAll('.team-slot .slot-role').forEach(r => { r.style.color = 'rgb(' + bRgb + ')'; });
  });

  // ë¶€ì œëª©
  const sub = document.getElementById('teamCompleteSubtitle');
  if(sub) sub.textContent = aName + ' vs ' + bName + ' íŒ€ í¸ì„± ì™„ë£Œ!';
}

// ========== ì§ì ‘ ì§„ì˜ ì„ íƒ ==========
function directSideSelect(side){
  if(side === 'blue'){
    teamSide = { A: 'blue', B: 'red' };
  } else {
    teamSide = { A: 'red', B: 'blue' };
  }
  document.getElementById('sideSelectArea').style.display = 'none';

  const aIsBlue = teamSide.A === 'blue';
  const aRgb = aIsBlue ? '59,130,246' : '239,68,68';
  const bRgb = aIsBlue ? '239,68,68' : '59,130,246';

  const renderFinalTeam = (arr, containerId, rgb) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    arr.forEach(m => {
      c.innerHTML += '<div class="team-slot filled" style="border:2px solid rgb(' + rgb + ');background:rgba(' + rgb + ',.05)">' +
        '<img src="' + (m.img || 'icon.png') + '" style="border-color:rgb(' + rgb + ')" onerror="this.src=\'icon.png\'">' +
        '<div><div class="slot-name">' + m.name + '</div>' +
        '<div class="slot-role" style="color:rgb(' + rgb + ')">' + (m.role === 'PICK' ? 'PICK' : m.role || 'PICK') + '</div></div></div>';
    });
  };
  renderFinalTeam(teamA, 'finalTeamA', aRgb);
  renderFinalTeam(teamB, 'finalTeamB', bRgb);
  applyTeamColors();

  const aName = aIsBlue ? 'ë¸”ë£¨íŒ€' : 'ë ˆë“œíŒ€';
  const bName = aIsBlue ? 'ë ˆë“œíŒ€' : 'ë¸”ë£¨íŒ€';
  logEvent('ì§„ì˜ ì„ íƒ! ' + teamA[0].name + 'íŒ€ = ' + aName + ', ' + teamB[0].name + 'íŒ€ = ' + bName);
}

// ========== í”½ ì• ë‹ˆë©”ì´ì…˜ ==========
function showPickAnimation(member, teamLabel, teamColor){
  return new Promise(resolve => {
    const overlay = document.getElementById('pickAnimOverlay');
    const card = document.getElementById('pickAnimCard');
    const img = document.getElementById('pickAnimImg');
    const name = document.getElementById('pickAnimName');
    const team = document.getElementById('pickAnimTeam');

    img.src = member.img || 'icon.png';
    img.onerror = function(){ this.src = 'icon.png'; };
    name.textContent = member.name;
    team.textContent = teamLabel + ' í•©ë¥˜!';
    team.style.color = teamColor;

    card.className = 'pick-anim-card';
    if(teamColor.includes('blue')) card.classList.add('blue');
    else if(teamColor.includes('red')) card.classList.add('red');

    overlay.classList.add('show');
    setTimeout(() => {
      overlay.classList.remove('show');
      setTimeout(resolve, 200);
    }, 1000);
  });
}

// ========== ë“œë˜í”„íŠ¸ ë°©ì‹ ì„ íƒ ==========
function openDraftMethodModal(){
  if(gameMode === 'solo'){
    // ì†”ë­ì€ ì¼ë°˜ ë“œë˜í”„íŠ¸ë§Œ
    selectDraftMethod('normal');
    return;
  }
  document.getElementById('draftMethodOverlay').classList.add('active');
  // ëœë¤ ì…”í”Œ ì˜µì…˜ í‘œì‹œ
  document.getElementById('randomShuffleOptions').style.display = '';
  // ì¹¼ë°”ëŒì´ë©´ í¬ì§€ì…˜ ì˜µì…˜ ìˆ¨ê¸°ê¸°
  document.getElementById('lblShufflePosition').style.display = mapMode === 'aram' ? 'none' : '';
  document.getElementById('chkShufflePosition').checked = false;
  document.getElementById('chkShuffleStreamer').checked = true;
}
function closeDraftMethodModal(){
  document.getElementById('draftMethodOverlay').classList.remove('active');
  // ì•„ì§ ë“œë˜í”„íŠ¸ ì‹œì‘ ì•ˆ í–ˆìœ¼ë©´ í™•ì • í•´ì œ
  if(teamA.length === 0 && teamB.length === 0){
    membersConfirmed = false;
    updateTodayMembersList();
  }
}
function selectDraftMethod(method){
  draftMethod = method;
  closeDraftMethodModal();
  if(method === 'normal'){
    // ì²« ë²ˆì§¸ ë¼ì¸ ìë™ ì„ íƒ + ì„ í”½ê¶Œ ì„¤ì •
    autoSelectFirstLine();
  } else if(method === 'random'){
    startRandomTeamDraft();
  } else if(method === 'custom'){
    openCustomPickerModal();
  }
}

// ========== ëœë¤ íŒ€ë½‘ê¸° ==========
async function startRandomTeamDraft(){
  const diceOverlay = document.getElementById('diceOverlay');
  const diceContainer = document.getElementById('diceContainer');
  const diceResultText = document.getElementById('diceResultText');
  const randomAssignArea = document.getElementById('randomAssignArea');

  diceContainer.innerHTML = '';
  diceResultText.textContent = '';
  diceResultText.style.animation = 'none';
  randomAssignArea.innerHTML = '';
  diceOverlay.classList.add('show');

  // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
  const diceEmojis = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];
  const rollInterval = setInterval(() => {
    diceContainer.innerHTML = diceEmojis[Math.floor(Math.random() * 6)];
  }, 100);

  await sleep(2000);
  clearInterval(rollInterval);

  const finalDice = Math.floor(Math.random() * 6);
  diceContainer.innerHTML = diceEmojis[finalDice];
  diceContainer.style.animation = 'none';
  void diceContainer.offsetWidth;
  diceContainer.style.animation = '';

  // ì…”í”Œ ì˜µì…˜ ì½ê¸°
  const shufflePosition = document.getElementById('chkShufflePosition') && document.getElementById('chkShufflePosition').checked;
  const shuffleStreamer = document.getElementById('chkShuffleStreamer') && document.getElementById('chkShuffleStreamer').checked;

  // í¬ì§€ì…˜ ëª©ë¡ (5ì¸ ê¸°ì¤€, ì¹¼ë°”ëŒì€ ë²ˆí˜¸)
  const roles = mapMode === 'aram' ? ['1ë²ˆ','2ë²ˆ','3ë²ˆ','4ë²ˆ','5ë²ˆ'] : ['íƒ‘', 'ì •ê¸€', 'ë¯¸ë“œ', 'ì›ë”œ', 'ì„œí¿'];

  // ë¼ì¸(ìŒ) ë‹¨ìœ„ë¡œ êµ¬ì„± + ì›ë˜ posIdx ê¸°ì–µ
  let lines = [];
  for(let i = 0; i < todayMembers.length; i += 2){
    lines.push({ a: todayMembers[i], b: todayMembers[i + 1], origIdx: i / 2 });
  }

  // í¬ì§€ì…˜ ì…”í”Œ: ë¬¶ë°¸ ê·¸ë£¹ì€ ë¸”ë¡ ë‹¨ìœ„ë¡œ ì…”í”Œ
  if(shufflePosition){
    const used = new Set();
    const blocks = [];
    for(let i = 0; i < lines.length; i++){
      if(used.has(i)) continue;
      const gk = getLineGroupKey(i);
      if(gk.startsWith('solo_')){
        blocks.push([lines[i]]);
        used.add(i);
      } else {
        const block = [];
        for(let j = 0; j < lines.length; j++){
          if(getLineGroupKey(j) === gk){ block.push(lines[j]); used.add(j); }
        }
        blocks.push(block);
      }
    }
    for(let i = blocks.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [blocks[i], blocks[j]] = [blocks[j], blocks[i]];
    }
    lines = blocks.flat();
  }
  teamA = [];
  teamB = [];

  // ë‹¨ê³„ë³„ ì• ë‹ˆë©”ì´ì…˜ í…ìŠ¤íŠ¸
  if(shufflePosition && shuffleStreamer){
    diceResultText.textContent = 'í¬ì§€ì…˜ ì„ëŠ” ì¤‘...';
    diceResultText.style.animation = 'none'; void diceResultText.offsetWidth;
    diceResultText.style.animation = 'fadeInUp .5s forwards';
    await sleep(1200);
    diceResultText.textContent = 'ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ëŠ” ì¤‘...';
    diceResultText.style.animation = 'none'; void diceResultText.offsetWidth;
    diceResultText.style.animation = 'fadeInUp .5s forwards';
    await sleep(800);
  } else if(shufflePosition){
    diceResultText.textContent = 'í¬ì§€ì…˜ ì„ëŠ” ì¤‘...';
    diceResultText.style.animation = 'none'; void diceResultText.offsetWidth;
    diceResultText.style.animation = 'fadeInUp .5s forwards';
    await sleep(800);
  } else if(shuffleStreamer){
    diceResultText.textContent = 'ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ëŠ” ì¤‘...';
    diceResultText.style.animation = 'none'; void diceResultText.offsetWidth;
    diceResultText.style.animation = 'fadeInUp .5s forwards';
    await sleep(800);
  } else {
    diceResultText.textContent = 'ë°°ì • ì¤‘...';
    diceResultText.style.animation = 'none'; void diceResultText.offsetWidth;
    diceResultText.style.animation = 'fadeInUp .5s forwards';
    await sleep(800);
  }

  // ë¬¶ë°¸ ê·¸ë£¹ë³„ A/B ê²°ì • (ê°™ì€ ê·¸ë£¹ì€ ê°™ì€ ë°©í–¥)
  const groupFlip = {};
  for(let i = 0; i < lines.length; i++){
    const gk = getLineGroupKey(lines[i].origIdx);
    if(!(gk in groupFlip)){
      groupFlip[gk] = shuffleStreamer ? Math.random() < 0.5 : true;
    }
  }

  for(let i = 0; i < lines.length; i++){
    const line = lines[i];
    const role = i < roles.length ? roles[i] : 'PICK';
    const aGoesA = groupFlip[getLineGroupKey(line.origIdx)];

    const m1 = aGoesA ? line.a : line.b; // AíŒ€ ë©¤ë²„
    const m2 = aGoesA ? line.b : line.a; // BíŒ€ ë©¤ë²„

    let img1 = m1.profileImage || 'icon.png';
    if(img1 && !img1.startsWith('http') && img1 !== 'icon.png') img1 = 'https://res.sooplive.co.kr' + img1;
    let img2 = m2.profileImage || 'icon.png';
    if(img2 && !img2.startsWith('http') && img2 !== 'icon.png') img2 = 'https://res.sooplive.co.kr' + img2;

    teamA.push({ name: m1.name, id: m1.id, img: img1, role: role });
    teamB.push({ name: m2.name, id: m2.id, img: img2, role: role });

    // ì¹´ë“œ: í¬ì§€ì…˜ | AíŒ€ ë©¤ë²„ | VS | BíŒ€ ë©¤ë²„
    const card = document.createElement('div');
    card.className = 'random-assign-card';
    card.innerHTML =
      '<div class="ra-role">' + role + '</div>' +
      '<div class="ra-member team-a">' +
        '<img src="' + img1 + '" onerror="this.src=\'icon.png\'">' +
        '<div><div class="ra-name">' + m1.name + '</div><div class="ra-team">AíŒ€</div></div>' +
      '</div>' +
      '<div class="ra-vs">VS</div>' +
      '<div class="ra-member team-b">' +
        '<img src="' + img2 + '" onerror="this.src=\'icon.png\'">' +
        '<div><div class="ra-name">' + m2.name + '</div><div class="ra-team">BíŒ€</div></div>' +
      '</div>';
    randomAssignArea.appendChild(card);

    await sleep(500);
    card.classList.add('show');
  }

  diceResultText.textContent = (shufflePosition && shuffleStreamer) ? 'í¬ì§€ì…˜ & ìŠ¤íŠ¸ë¦¬ë¨¸ ë°°ì • ì™„ë£Œ!' : shufflePosition ? 'í¬ì§€ì…˜ ë°°ì • ì™„ë£Œ!' : shuffleStreamer ? 'ìŠ¤íŠ¸ë¦¬ë¨¸ ë°°ì • ì™„ë£Œ!' : 'ë°°ì • ì™„ë£Œ!';
  diceResultText.style.animation = 'none';
  void diceResultText.offsetWidth;
  diceResultText.style.animation = 'fadeInUp .5s forwards';

  await sleep(1500);
  diceOverlay.classList.remove('show');

  await sleep(300);

  // ëœë¤ì€ ìë™ìœ¼ë¡œ A=ë¸”ë£¨, B=ë ˆë“œ ì§„ì˜ ë°°ì •
  teamSide = { A: 'blue', B: 'red' };
  showTeamComplete();
  applyTeamColors();
}

// ========== ì»¤ìŠ¤í…€ â€” í”½ì»¤ ì„ íƒ ==========
function openCustomPickerModal(){
  const overlay = document.getElementById('customPickerOverlay');
  const options = document.getElementById('customPickerOptions');
  options.innerHTML = '';

  todayMembers.forEach(m => {
    let imgUrl = m.profileImage || 'icon.png';
    if(imgUrl && !imgUrl.startsWith('http') && imgUrl !== 'icon.png') imgUrl = 'https://res.sooplive.co.kr' + imgUrl;

    const opt = document.createElement('div');
    opt.className = 'pick-option';
    opt.innerHTML = '<img src="' + imgUrl + '" onerror="this.src=\'icon.png\'">' +
      '<div><div class="pick-name">' + m.name + '</div><div class="pick-id">@' + m.id + '</div></div>';
    opt.onclick = () => selectCustomPicker(m);
    options.appendChild(opt);
  });

  overlay.classList.add('active');
}
function closeCustomPickerModal(){
  document.getElementById('customPickerOverlay').classList.remove('active');
}
function selectCustomPicker(member){
  customPicker = member;
  closeCustomPickerModal();
  showCustomSettings();
}

// ========== ì»¤ìŠ¤í…€ â€” ì„¤ì • í™”ë©´ ==========
let customSlots = []; // [{label, type:'pick'|'counter'|'ladder'}]

function showCustomSettings(){
  // ë¼ì¸(ìŒ) ìˆ˜ = ì„ ìˆ˜ ìŠ¬ë¡¯ ìˆ˜, + ì§„ì˜ì„ íƒê¶Œ (ëœë“œ/CKë§Œ)
  const otherLines = availableLines.filter(l => l.a.id !== customPicker.id && l.b.id !== customPicker.id);
  const pairCount = otherLines.length; // ì»¤ìŠ¤í…€ í”½ì»¤ ë³¸ì¸ ë¼ì¸ ì œì™¸
  customSlots = [];
  for(let i = 0; i < pairCount; i++){
    customSlots.push({ label: 'ì„ ìˆ˜ ' + (i + 1), type: 'pick' });
  }
  if(gameMode === 'land'){
    customSlots.push({ label: 'ì§„ì˜ì„ íƒê¶Œ', type: 'pick', isSide: true });
  }

  document.getElementById('customPickerName').textContent = customPicker.name;
  document.getElementById('customDraftSubtitle').textContent = 'ê° ìŠ¬ë¡¯ì˜ ì„ íƒ ë°©ì‹ì„ ì •í•˜ì„¸ìš”';

  document.getElementById('memberSection').style.maxHeight = '200px';
  document.getElementById('memberSection').style.overflow = 'hidden';
  document.getElementById('memberSection').style.opacity = '0.6';
  document.getElementById('memberSection').style.transition = 'all .3s';

  document.getElementById('customDraftArea').style.display = '';
  renderCustomSlotSettings();
  logEvent('ğŸ‘‘ ' + customPicker.name + ' ì»¤ìŠ¤í…€! ê° ìŠ¬ë¡¯ì˜ ì„ /í›„/ì‚¬ë‹¤ë¦¬ë¥¼ ì„¤ì •í•˜ì„¸ìš”.');
}

function renderCustomSlotSettings(){
  const container = document.getElementById('customSlotSettings');
  container.innerHTML = '';
  const pickerName = customPicker.name;
  const pickerPartnerId = matchedPairs.get(customPicker.id);
  const pickerPartner = pickerPartnerId ? todayMembers.find(m => m.id === pickerPartnerId) : null;
  const counterName = pickerPartner ? pickerPartner.name : 'ìƒëŒ€';

  customSlots.forEach((slot, i) => {
    const row = document.createElement('div');
    row.className = 'custom-slot-row';
    row.innerHTML =
      '<div class="cs-label' + (slot.isSide ? ' side' : '') + '">' + (slot.isSide ? 'ğŸ® ' : '') + slot.label + '</div>' +
      '<div class="custom-slot-btns">' +
        '<button data-slot="' + i + '" data-type="pick" class="' + (slot.type === 'pick' ? 'active-pick' : '') + '" onclick="setCustomSlot(' + i + ',\'pick\')">' + pickerName + ' (ì„ )</button>' +
        '<button data-slot="' + i + '" data-type="counter" class="' + (slot.type === 'counter' ? 'active-counter' : '') + '" onclick="setCustomSlot(' + i + ',\'counter\')">' + counterName + ' (í›„)</button>' +
        '<button data-slot="' + i + '" data-type="ladder" class="' + (slot.type === 'ladder' ? 'active-ladder' : '') + '" onclick="setCustomSlot(' + i + ',\'ladder\')">ğŸªœ ì‚¬ë‹¤ë¦¬</button>' +
      '</div>';
    container.appendChild(row);
  });
}

function setCustomSlot(idx, type){
  customSlots[idx].type = type;
  // ì‚¬ë‹¤ë¦¬ ì„ íƒ ì‹œ ë‹¤ìŒ ìŠ¬ë¡¯ë„ ìë™ìœ¼ë¡œ ì‚¬ë‹¤ë¦¬ (ì„ /í›„ ê° 1ëª… = 2ìŠ¬ë¡¯ ì†Œë¹„, ì§„ì˜ì„ íƒê¶Œì€ ì œì™¸)
  if(type === 'ladder' && !customSlots[idx].isSide && idx + 1 < customSlots.length && !customSlots[idx + 1].isSide){
    customSlots[idx + 1].type = 'ladder';
  }
  renderCustomSlotSettings();
}

function setAllCustomSlots(type){
  customSlots.forEach(s => { s.type = type; });
  renderCustomSlotSettings();
}

// ========== ì»¤ìŠ¤í…€ â€” ë“œë˜í”„íŠ¸ ì‹¤í–‰ ==========
let customStep = 0; // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì»¤ìŠ¤í…€ ìŠ¬ë¡¯ ì¸ë±ìŠ¤
let customCounterPicker = null; // ì»¤ìŠ¤í…€ ìƒëŒ€ (í›„ ì„ íƒì)

async function confirmCustomSettings(){
  document.getElementById('customDraftArea').style.display = 'none';

  // íŒ€ ì´ˆê¸°í™”
  let pickerImg = customPicker.profileImage || 'icon.png';
  if(pickerImg && !pickerImg.startsWith('http') && pickerImg !== 'icon.png') pickerImg = 'https://res.sooplive.co.kr' + pickerImg;

  // ì»¤ìŠ¤í…€ í”½ì»¤ í¬ì§€ì…˜ ìë™ ë°°ì •
  currentPickTeam = 'A';
  const pickerRole = getRoleFromSlot(customPicker.id);

  teamA = [{ name: customPicker.name, id: customPicker.id, img: pickerImg, role: pickerRole.icon + ' ' + pickerRole.name }];
  teamB = [];

  // ì»¤ìŠ¤í…€ í”½ì»¤ì˜ ë§ë²¨ íŒŒíŠ¸ë„ˆ â†’ BíŒ€ (ê°™ì€ í¬ì§€ì…˜)
  const pickerPartnerId = matchedPairs.get(customPicker.id);
  if(pickerPartnerId){
    const partner = todayMembers.find(m => m.id === pickerPartnerId);
    if(partner){
      let pImg = partner.profileImage || 'icon.png';
      if(pImg && !pImg.startsWith('http') && pImg !== 'icon.png') pImg = 'https://res.sooplive.co.kr' + pImg;
      teamB.push({ name: partner.name, id: partner.id, img: pImg, role: pickerRole.icon + ' ' + pickerRole.name });
      usedRolesB.push(pickerRole.key);
      customCounterPicker = partner;
    }
  }

  // ë‚˜ë¨¸ì§€ ë¼ì¸ì—ì„œ ë“œë˜í”„íŠ¸ í’€ ìƒì„± (ì»¤ìŠ¤í…€ í”½ì»¤ ë¼ì¸ ì œì™¸)
  draftPool = todayMembers.filter(m => m.id !== customPicker.id && m.id !== (pickerPartnerId || ''));

  customStep = 0;
  draftRound = 0;
  draftInitialized = true;
  captainFirst = { name: customPicker.name, id: customPicker.id, img: pickerImg };
  captainSecond = customCounterPicker ? { name: customCounterPicker.name, id: customCounterPicker.id, img: customCounterPicker.profileImage || 'icon.png' } : null;

  // ê¸°ì¡´ ë“œë˜í”„íŠ¸ UI ì‚¬ìš©
  document.getElementById('draftArea').style.display = '';
  document.getElementById('ladderSetupArea').style.display = 'none';
  document.getElementById('ladderSection').style.display = 'none';
  document.getElementById('draftSection').style.display = 'none';
  document.getElementById('ladderResult').style.display = 'none';

  processNextCustomStep();
}

async function processNextCustomStep(){
  if(customStep >= customSlots.length){
    // ëª¨ë“  ìŠ¬ë¡¯ ì™„ë£Œ, ì§„ì˜ ì²˜ë¦¬ ì œì™¸ (ë³„ë„)
    setTimeout(() => showTeamComplete(), 500);
    return;
  }

  const slot = customSlots[customStep];

  // ì§„ì˜ì„ íƒê¶Œ ìŠ¬ë¡¯
  if(slot.isSide){
    customStep++;
    if(slot.type === 'pick'){
      // ì»¤ìŠ¤í…€ í”½ì»¤ê°€ ì§ì ‘ ì„ íƒ
      showTeamComplete();
      setTimeout(() => {
        document.getElementById('startSideLadderBtn').style.display = 'none';
        const sideArea = document.getElementById('sideLadderArea');
        sideArea.style.display = '';
        sideArea.innerHTML =
          '<div style="font-size:16px;font-weight:700;color:var(--yellow);margin-bottom:12px">ğŸ‘‘ ' + customPicker.name + ' ì§„ì˜ ì„ íƒ</div>' +
          '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">' + customPicker.name + 'ë‹˜ì´ ì§„ì˜ì„ ì§ì ‘ ì„ íƒí•©ë‹ˆë‹¤!</div>' +
          '<div style="display:flex;gap:16px;justify-content:center">' +
            '<button onclick="customSideSelect(\'blue\')" class="game-btn" style="padding:16px 32px;background:var(--team-blue);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”µ ë¸”ë£¨ ì§„ì˜</button>' +
            '<button onclick="customSideSelect(\'red\')" class="game-btn" style="padding:16px 32px;background:var(--team-red);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”´ ë ˆë“œ ì§„ì˜</button>' +
          '</div>';
      }, 300);
    } else if(slot.type === 'counter'){
      // ìƒëŒ€ê°€ ì§ì ‘ ì„ íƒ
      showTeamComplete();
      const counterName = customCounterPicker ? customCounterPicker.name : 'ìƒëŒ€';
      setTimeout(() => {
        document.getElementById('startSideLadderBtn').style.display = 'none';
        const sideArea = document.getElementById('sideLadderArea');
        sideArea.style.display = '';
        sideArea.innerHTML =
          '<div style="font-size:16px;font-weight:700;color:var(--team-red);margin-bottom:12px">ğŸ¯ ' + counterName + ' ì§„ì˜ ì„ íƒ</div>' +
          '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">' + counterName + 'ë‹˜ì´ ì§„ì˜ì„ ì§ì ‘ ì„ íƒí•©ë‹ˆë‹¤!</div>' +
          '<div style="display:flex;gap:16px;justify-content:center">' +
            '<button onclick="customSideSelect(\'blue\')" class="game-btn" style="padding:16px 32px;background:var(--team-blue);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”µ ë¸”ë£¨ ì§„ì˜</button>' +
            '<button onclick="customSideSelect(\'red\')" class="game-btn" style="padding:16px 32px;background:var(--team-red);color:#fff;font-size:16px;font-weight:900;border-radius:12px">ğŸ”´ ë ˆë“œ ì§„ì˜</button>' +
          '</div>';
      }, 300);
    } else if(slot.type === 'ladder'){
      // ì‚¬ë‹¤ë¦¬ë¡œ ì§„ì˜ ê²°ì •
      showTeamComplete();
      setTimeout(() => {
        document.getElementById('startSideLadderBtn').style.display = 'none';
        document.getElementById('sideLadderArea').style.display = 'none';
        startSideLadder();
      }, 300);
    }
    return;
  }

  // ì„ ìˆ˜ ìŠ¬ë¡¯
  if(draftPool.length === 0){
    setTimeout(() => showTeamComplete(), 500);
    return;
  }

  if(slot.type === 'pick'){
    // ì»¤ìŠ¤í…€ í”½ì»¤(ì„ )ê°€ ë½‘ê¸°
    currentPickTeam = 'A';
    draftRound++;
    picksThisRound = 0;
    document.getElementById('draftSection').style.display = '';
    document.getElementById('ladderSetupArea').style.display = 'none';
    document.getElementById('ladderSection').style.display = 'none';
    document.getElementById('ladderResult').style.display = 'none';
    document.getElementById('runLadderBtn').style.display = 'none';
    document.getElementById('captainALabel').textContent = '(íŒ€ì¥: ' + teamA[0].name + ')';
    document.getElementById('captainBLabel').textContent = teamB.length > 0 ? '(íŒ€ì¥: ' + teamB[0].name + ')' : '';
    renderDraft();
    logEvent('ğŸ‘‘ ì»¤ìŠ¤í…€ ì„ ìˆ˜' + (customStep + 1) + ': ' + customPicker.name + '(ì„ )ì´ ë½‘ìŠµë‹ˆë‹¤!');
  } else if(slot.type === 'counter'){
    // ìƒëŒ€(í›„)ê°€ ë½‘ê¸°
    currentPickTeam = 'B';
    draftRound++;
    picksThisRound = 0;
    document.getElementById('draftSection').style.display = '';
    document.getElementById('ladderSetupArea').style.display = 'none';
    document.getElementById('ladderSection').style.display = 'none';
    document.getElementById('ladderResult').style.display = 'none';
    document.getElementById('runLadderBtn').style.display = 'none';
    document.getElementById('captainALabel').textContent = '(íŒ€ì¥: ' + teamA[0].name + ')';
    document.getElementById('captainBLabel').textContent = teamB.length > 0 ? '(íŒ€ì¥: ' + teamB[0].name + ')' : '';
    renderDraft();
    const counterName = customCounterPicker ? customCounterPicker.name : 'ìƒëŒ€';
    logEvent('ì»¤ìŠ¤í…€ ì„ ìˆ˜' + (customStep + 1) + ': ' + counterName + '(í›„)ì´ ë½‘ìŠµë‹ˆë‹¤!');
  } else if(slot.type === 'ladder'){
    // ì‚¬ë‹¤ë¦¬ë¡œ ê²°ì • â€” íŒ€ì¥ 2ëª…ì´ ì‚¬ë‹¤ë¦¬ë¥¼ íƒ€ì„œ ì„ /í›„ ê²°ì •
    if(draftPool.length === 0){
      customStep++;
      processNextCustomStep();
      return;
    }
    const pickerImg = teamA[0].img || 'icon.png';
    const counterImg = teamB.length > 0 ? (teamB[0].img || 'icon.png') : 'icon.png';
    ladderPlayers[0] = { name: teamA[0].name, id: teamA[0].id, img: pickerImg };
    ladderPlayers[1] = teamB.length > 0 ? { name: teamB[0].name, id: teamB[0].id, img: counterImg } : null;

    firstPickId = '';
    firstPickCount = 'always';
    firstPickUsed = false;

    document.getElementById('draftArea').style.display = '';
    document.getElementById('ladderSetupArea').style.display = '';
    document.getElementById('ladderSection').style.display = '';
    document.getElementById('draftSection').style.display = 'none';
    document.getElementById('ladderResult').style.display = 'none';
    const runBtn = document.getElementById('runLadderBtn');
    runBtn.style.display = '';
    runBtn.disabled = false;
    runBtn.textContent = 'â–¶ ì‚¬ë‹¤ë¦¬ ì‹œì‘';
    runBtn.onclick = function(){ runLadder(); };
    draftStarted = false;
    const swapBtn = document.getElementById('swapLadderBtn');
    if(swapBtn) swapBtn.style.display = '';

    bottomLabels = ['X', 'ì„ ', 'í›„'];
    ladderRungs = [];
    ladderAnimResults = null;
    isLadderRunning = false;

    renderLadderSlots();
    renderBottomLabels();
    drawLadder();
    checkLadderReady();
    logEvent('ì»¤ìŠ¤í…€ ì„ ìˆ˜' + (customStep + 1) + ': ' + teamA[0].name + ' vs ' + (teamB.length > 0 ? teamB[0].name : '?') + ' ì‚¬ë‹¤ë¦¬ë¡œ ì„ /í›„ ê²°ì •!');
  }
}

// ì»¤ìŠ¤í…€ ëª¨ë“œì—ì„œ í”½ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ
function onCustomPickDone(){
  customStep++;
  if(draftPool.length === 0){
    setTimeout(() => {
      // ì§„ì˜ì„ íƒê¶Œ ìŠ¬ë¡¯ì´ ë‚¨ì•„ìˆìœ¼ë©´ ê·¸ê²ƒ ë¨¼ì € ì²˜ë¦¬
      const sideSlot = customSlots.find(s => s.isSide);
      if(sideSlot && customStep <= customSlots.indexOf(sideSlot)){
        customStep = customSlots.indexOf(sideSlot);
        processNextCustomStep();
      } else {
        showTeamComplete();
      }
    }, 500);
  } else {
    setTimeout(() => processNextCustomStep(), 500);
  }
}

function customSideSelect(side){
  if(side === 'blue'){
    teamSide = { A: 'blue', B: 'red' };
  } else {
    teamSide = { A: 'red', B: 'blue' };
  }

  const aIsBlue = teamSide.A === 'blue';
  const aName = aIsBlue ? 'ë¸”ë£¨íŒ€' : 'ë ˆë“œíŒ€';
  logEvent('ì§„ì˜ ì„ íƒ! AíŒ€ = ' + aName);

  document.getElementById('sideLadderArea').style.display = 'none';

  const aRgb = aIsBlue ? '59,130,246' : '239,68,68';
  const bRgb = aIsBlue ? '239,68,68' : '59,130,246';

  const renderFinalTeam = (arr, containerId, rgb) => {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    arr.forEach(m => {
      c.innerHTML += '<div class="team-slot filled" style="border:2px solid rgb(' + rgb + ');background:rgba(' + rgb + ',.05)">' +
        '<img src="' + (m.img || 'icon.png') + '" style="border-color:rgb(' + rgb + ')" onerror="this.src=\'icon.png\'">' +
        '<div><div class="slot-name">' + m.name + '</div>' +
        '<div class="slot-role" style="color:rgb(' + rgb + ')">' + (m.role || 'PICK') + '</div></div></div>';
    });
  };
  renderFinalTeam(teamA, 'finalTeamA', aRgb);
  renderFinalTeam(teamB, 'finalTeamB', bRgb);
  applyTeamColors();
}

// ========== í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ==========
// IME ì¡°í•© ì¶”ì 
document.getElementById('newMemberInput').addEventListener('compositionstart', () => { memberInputComposing = true; });
document.getElementById('newMemberInput').addEventListener('compositionend', () => {
  memberInputComposing = false;
  searchStreamerForMember(document.getElementById('newMemberInput'));
});

document.getElementById('newMemberInput').addEventListener('keydown', e => {
  if(e.isComposing || memberInputComposing) return; // IME ì¡°í•© ì¤‘ì´ë©´ ë¬´ì‹œ
  const results = document.getElementById('memberSearchResults');
  if(results){
    const items = results.querySelectorAll('.search-result-item');
    if(e.key === 'ArrowDown'){
      e.preventDefault();
      searchByKeyboard = true;
      searchHighlightIdx = Math.min(searchHighlightIdx + 1, items.length - 1);
      updateSearchHighlight();
    } else if(e.key === 'ArrowUp'){
      e.preventDefault();
      searchByKeyboard = true;
      searchHighlightIdx = Math.max(searchHighlightIdx - 1, -1);
      if(searchHighlightIdx === -1) searchByKeyboard = false;
      updateSearchHighlight();
    } else if(e.key === 'Enter'){
      e.preventDefault();
      if(searchHighlightIdx >= 0 && searchHighlightIdx < items.length){
        items[searchHighlightIdx].click();
      } else {
        addTodayMember();
      }
      return;
    } else if(e.key === 'Escape'){
      hideMemberSearchResults();
      return;
    }
  } else if(e.key === 'Enter'){
    addTodayMember();
  }
});

document.addEventListener('click', (e) => {
  if(!e.target.closest('#newMemberInput') && !e.target.closest('#memberSearchResults')) hideMemberSearchResults();
});

// ========== ì´ˆê¸°í™” ==========
document.addEventListener('DOMContentLoaded', () => {
  updateTodayMembersList();
});
</script>

</body>
</html>