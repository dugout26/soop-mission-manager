<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MK ëŒ€ê²°ë¯¸ì…˜ ë§¤ë‹ˆì €</title>
<link rel="icon" href="icon.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#080f0a;--card:#0f1a12;--card2:#162219;--blue:#4ade80;--orange:#f97316;--green:#22c55e;--red:#ef4444;--purple:#86efac;--cyan:#6ee7b7;--yellow:#eab308;--text:#f1f4f1;--text2:#88a090;--muted:#557060;--border:#1e3625}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:linear-gradient(rgba(74,222,128,.04)1px,transparent 1px),linear-gradient(90deg,rgba(74,222,128,.04)1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:16px}

.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.logo{font-family:'Black Han Sans';font-size:22px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px}
.logo img{width:32px;height:32px;border-radius:6px}
.logo-sub{font-size:10px;color:var(--muted)}

.conn{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:11px;flex-wrap:wrap}
.dot{width:8px;height:8px;border-radius:50%}
.dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.dot.wait{background:var(--orange);animation:p 1s infinite}
.dot.off{background:var(--red)}
@keyframes p{0%,100%{opacity:1}50%{opacity:.3}}
.ci{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;width:130px;font-family:inherit}
.ci:focus{outline:none;border-color:var(--blue)}
.cb{padding:4px 10px;border-radius:4px;border:1px solid var(--blue);background:rgba(74,222,128,.1);color:var(--blue);font-size:10px;font-weight:700;cursor:pointer;font-family:inherit}

.stats{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.st{flex:1;min-width:100px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
.st-l{font-size:9px;color:var(--muted);font-weight:600}
.st-v{font-size:18px;font-weight:900;margin-top:1px}

.sec{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.sec h2{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.sec h2 .sub{font-size:10px;color:var(--muted);font-weight:400}

/* ìë™ë“±ë¡ ì„ê³„ê°’ */
.auto-box{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(234,179,8,.06);border:1px solid rgba(234,179,8,.2);border-radius:8px;margin-bottom:12px;flex-wrap:wrap}
.auto-box label{font-size:11px;font-weight:700;color:var(--yellow)}
.auto-box input{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;width:80px;font-family:inherit;text-align:center}
.auto-box input:focus{outline:none;border-color:var(--yellow)}
.auto-box .desc{font-size:9px;color:var(--muted)}
.auto-box button{padding:4px 10px;border-radius:4px;border:1px solid var(--yellow);background:rgba(234,179,8,.1);color:var(--yellow);font-size:10px;font-weight:700;cursor:pointer;font-family:inherit}

/* ë¯¸ì…˜ ë“±ë¡ */
.tpl-form{display:flex;gap:6px;align-items:flex-end;flex-wrap:wrap}
.fg{display:flex;flex-direction:column;gap:2px}
.fg label{font-size:8px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select{padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;font-family:inherit}
.fg input:focus{outline:none;border-color:var(--blue)}
.chk-group{display:flex;gap:10px;align-items:center}
.chk-group label{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2);cursor:pointer;user-select:none}
.chk-group input[type=checkbox]{accent-color:var(--blue);width:14px;height:14px}
.btn-add{padding:6px 14px;background:linear-gradient(135deg,#4ade80,#22c55e);border:none;border-radius:4px;color:#fff;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap}

/* ë“±ë¡ëœ í…œí”Œë¦¿ */
.tpl-list{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.tpl-card{background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;display:flex;align-items:center;gap:10px;position:relative}
.tpl-card.inactive{opacity:.35}
.tpl-card.editing{border-color:var(--blue)}
.tpl-star{font-size:16px;font-weight:900;color:var(--orange);font-family:'Black Han Sans';white-space:nowrap}
.tpl-name{font-size:12px;font-weight:700}
.tpl-tags{display:flex;gap:3px;margin-top:2px}
.tpl-tag{font-size:8px;padding:1px 5px;border-radius:2px;font-weight:600}
.tpl-tag.domain{background:rgba(59,130,246,.12);color:var(--blue)}
.tpl-tag.msg{background:rgba(249,115,22,.12);color:var(--orange)}
.tpl-cond{font-size:9px;color:var(--cyan);margin-top:1px}
.tpl-actions{margin-left:auto;display:flex;gap:3px}
.tpl-btn{padding:3px 6px;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:9px;cursor:pointer;font-family:inherit}
.tpl-btn:hover{border-color:var(--muted)}
.tpl-btn.del{color:var(--red);border-color:rgba(239,68,68,.3)}
.tpl-btn.edit{color:var(--blue);border-color:rgba(59,130,246,.3)}

/* í¸ì§‘ ì¸ë¼ì¸ */
.edit-inline{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.edit-inline input{padding:3px 6px;background:var(--bg);border:1px solid var(--blue);border-radius:3px;color:var(--text);font-size:10px;font-family:inherit}
.edit-inline input:focus{outline:none}
.edit-inline button{padding:3px 8px;border-radius:3px;border:none;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit}
.edit-inline .save{background:var(--blue);color:#fff}
.edit-inline .cancel{background:var(--border);color:var(--text2)}

/* ê²°ê³¼ */
.filters{display:flex;gap:3px;margin-bottom:8px}
.ft{padding:3px 8px;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:9px;font-weight:600;cursor:pointer;font-family:inherit}
.ft.active{background:var(--blue);color:#fff;border-color:var(--blue)}

.results{display:flex;flex-direction:column;gap:4px}
.r-card{background:var(--card2);border:1px solid var(--border);border-radius:7px;padding:10px 12px;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;transition:all .15s}
.r-card:hover{border-color:var(--muted)}
.r-card.done{background:rgba(239,68,68,.05);border-color:rgba(239,68,68,.15)}
.r-card.done .r-info *{text-decoration:line-through;opacity:.35}

.r-badge{padding:3px 7px;border-radius:3px;font-size:9px;font-weight:800;white-space:nowrap;letter-spacing:.3px}
.r-badge.balloon{background:rgba(74,222,128,.1);color:var(--blue)}
.r-badge.adballoon{background:rgba(168,85,247,.1);color:var(--purple)}
.r-badge.video{background:rgba(6,182,212,.1);color:var(--cyan)}
.r-badge.mission{background:rgba(234,179,8,.1);color:var(--yellow);border:1px solid rgba(234,179,8,.3)}
.r-badge.auto{background:rgba(234,179,8,.1);color:var(--yellow)}

.r-info{flex:1;min-width:0}
.r-user{font-size:13px;font-weight:700;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.r-user .tag{font-size:7px;padding:1px 4px;border-radius:2px;font-weight:600}
.r-user .tag.auto{background:rgba(34,197,94,.15);color:var(--green)}
.r-user .tag.thresh{background:rgba(234,179,8,.15);color:var(--yellow)}
.r-msg{font-size:13px;color:var(--orange);font-weight:800;max-width:350px;overflow:hidden;text-overflow:ellipsis}
.r-detail{font-size:10px;color:var(--text2);margin-top:2px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.r-link{color:var(--blue);text-decoration:none;font-weight:600;font-size:10px}
.r-link:hover{text-decoration:underline}
.r-memo{padding:2px 5px;background:var(--bg);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:10px;width:180px;font-family:inherit}
.r-memo:focus{outline:none;border-color:var(--orange)}
.r-time{font-size:8px;color:var(--muted);white-space:nowrap}
.r-acts{display:flex;gap:3px}
.rb{padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:9px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .12s}
.rb:hover{border-color:var(--muted);color:var(--text)}
.rb.go{border-color:var(--blue);color:var(--blue)}
.rb.ok{border-color:var(--green);color:var(--green)}
.rb.undo{border-color:var(--orange);color:var(--orange)}
.rb.del{border-color:var(--red);color:var(--red);padding:4px 6px}

.stamp{display:none;position:absolute;right:50px;top:50%;transform:translateY(-50%) rotate(-12deg);border:2px solid var(--red);color:var(--red);font-family:'Black Han Sans';font-size:16px;padding:1px 12px;border-radius:3px;letter-spacing:2px;opacity:.45;pointer-events:none}
.r-card.done .stamp{display:block}

/* ë¡œê·¸ */
.blog{max-height:160px;overflow-y:auto;font-size:10px}
.blog::-webkit-scrollbar{width:3px}
.blog::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.be{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:6px}
.be .a{font-weight:800;color:var(--orange);min-width:40px}
.be .n{color:var(--text);font-weight:600}
.be .t{color:var(--muted);margin-left:auto;font-size:8px}
.be .tp{font-size:8px;padding:1px 4px;border-radius:2px;font-weight:600}

.empty{text-align:center;padding:24px 14px;color:var(--muted);font-size:11px}
.empty .icon{font-size:28px;margin-bottom:4px}

/* íƒ€ì… ì¹© ë²„íŠ¼ */
.type-chips{display:flex;gap:3px}
.tc{padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .12s;white-space:nowrap}
.tc:hover{border-color:var(--muted);color:var(--text2)}
.tc.active{background:rgba(74,222,128,.15);border-color:var(--blue);color:var(--blue)}
.tc[data-val="mission"].active{background:rgba(234,179,8,.15);border-color:var(--yellow);color:var(--yellow)}
.tc[data-val="balloon"].active{background:rgba(74,222,128,.15);border-color:var(--blue);color:var(--blue)}
.tc[data-val="adballoon"].active{background:rgba(134,239,172,.15);border-color:var(--purple);color:var(--purple)}

@media(max-width:768px){.header{flex-direction:column}.stats .st{min-width:calc(50% - 3px)}.tpl-form{flex-direction:column}.r-card{flex-wrap:wrap}}
</style>
</head>
<body>
<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="loginScreen" style="position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:32px;text-align:center;width:320px">
    <img src="icon.png" style="width:64px;height:64px;border-radius:10px;margin-bottom:12px">
    <div style="font-family:'Black Han Sans';font-size:20px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px">MK ëŒ€ê²°ë¯¸ì…˜ ë§¤ë‹ˆì €</div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:20px">ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;text-align:center;margin-bottom:10px">
    <div id="loginErr" style="font-size:10px;color:var(--red);margin-bottom:8px;min-height:14px"></div>
    <button onclick="doLogin()" style="width:100%;padding:10px;background:linear-gradient(135deg,#4ade80,#22c55e);border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">ì…ì¥</button>
  </div>
</div>

<div class="app" id="mainApp" style="display:none">
  <div class="header">
    <div><div class="logo"><img src="icon.png" alt="MK">MK ëŒ€ê²°ë¯¸ì…˜ ë§¤ë‹ˆì €</div><div class="logo-sub">SOOP ë³„í’ì„  ìë™ê°ì§€ Â· v4.0 Â· phonics1</div></div>
    <div class="conn">
      <div class="dot off" id="dot"></div>
      <span id="connTxt">ì—°ê²° ì•ˆë¨</span>
      <input class="ci" id="sInput" value="phonics1" readonly style="opacity:.6;cursor:default">
      <button class="cb" onclick="setStreamer()">ì—°ê²°</button>
      <button class="cb" onclick="doReconnect()">ğŸ”„</button>
      <button class="cb" onclick="changePw()" style="border-color:var(--muted);color:var(--muted)">ğŸ”‘</button>
    </div>
  </div>

  <div class="stats">
    <div class="st"><div class="st-l">ì „ì²´</div><div class="st-v" style="color:var(--blue)" id="s1">0</div></div>
    <div class="st"><div class="st-l">ì§„í–‰ì¤‘</div><div class="st-v" style="color:var(--orange)" id="s2">0</div></div>
    <div class="st"><div class="st-l">ì™„ë£Œ</div><div class="st-v" style="color:var(--green)" id="s3">0</div></div>
    <div class="st"><div class="st-l">ëŒ€ê¸°(ì—­íŒ¬)</div><div class="st-v" style="color:var(--red)" id="s4">0</div></div>
  </div>

  <!-- ë¯¸ì…˜ ë“±ë¡ -->
  <div class="sec">
    <h2>ğŸ“‹ ë¯¸ì…˜ ë“±ë¡</h2>

    <!-- ìë™ë“±ë¡ ì„ê³„ê°’ -->
    <div class="auto-box">
      <label>âš¡ ìë™ë“±ë¡</label>
      <input id="autoVal" type="number" placeholder="0" value="0" min="0" step="100">
      <span style="font-size:11px;color:var(--text2)">ê°œ ì´ìƒì´ë©´ í…œí”Œë¦¿ ì—†ì–´ë„ ìë™ë“±ë¡</span>
      <button onclick="setAutoThreshold()">ì ìš©</button>
      <button onclick="document.getElementById('autoVal').value='0';setAutoThreshold()" style="border-color:var(--red);color:var(--red)">ë„ê¸°</button>
      <div class="desc" id="autoDesc">í˜„ì¬: ë¹„í™œì„±</div>
    </div>

    <!-- ë“±ë¡ í¼ -->
    <div class="tpl-form">
      <div class="fg"><label>ë¯¸ì…˜ ì´ë¦„</label><input id="tName" placeholder="ì—­íŒ¬, ë°©ì…€ ë“±" style="width:100px"></div>
      <div class="fg"><label>ê°œìˆ˜ (ì •í™•íˆ)</label><input id="tCount" type="number" value="500" style="width:80px"></div>
      <div class="fg"><label>íƒ€ì…</label>
        <div class="type-chips" id="tTypeChips">
          <button class="tc active" data-val="all" onclick="pickType(this)">ì „ì²´</button>
          <button class="tc" data-val="balloon" onclick="pickType(this)">â­ë³„í’</button>
          <button class="tc" data-val="adballoon" onclick="pickType(this)">ğŸˆì• ë“œ</button>
          <button class="tc" data-val="mission" onclick="pickType(this)">âš”ëŒ€ê²°</button>
        </div>
      </div>
      <div class="chk-group">
        <label><input type="checkbox" id="tDomain" checked> ğŸ”— ë„ë©”ì¸</label>
        <label><input type="checkbox" id="tMsg" checked> ğŸ’¬ ë©”ì‹œì§€</label>
      </div>
      <button class="btn-add" onclick="addTemplate()">+ ë“±ë¡</button>
    </div>

    <div class="tpl-list" id="tplList"></div>
  </div>

  <!-- ë¯¸ì…˜ í˜„í™© -->
  <div class="sec">
    <h2>ğŸ¯ ë¯¸ì…˜ í˜„í™©</h2>
    <div class="filters">
      <button class="ft active" onclick="setF('all',this)">ì „ì²´</button>
      <button class="ft" onclick="setF('pending',this)">ì§„í–‰ì¤‘</button>
      <button class="ft" onclick="setF('done',this)">ì™„ë£Œ</button>
      <span style="width:1px;height:16px;background:var(--border);margin:0 4px"></span>
      <button class="ft type-ft" onclick="setTF('all',this)" style="border-color:rgba(74,222,128,.3);color:var(--blue)">ëª¨ë“ íƒ€ì…</button>
      <button class="ft type-ft" onclick="setTF('mission',this)" style="border-color:rgba(234,179,8,.3);color:var(--yellow)">ëŒ€ê²°ë¯¸ì…˜</button>
      <button class="ft type-ft" onclick="setTF('balloon',this)" style="border-color:rgba(74,222,128,.3);color:var(--blue)">ë³„í’ì„ </button>
      <button class="ft type-ft" onclick="setTF('adballoon',this)" style="border-color:rgba(134,239,172,.3);color:var(--purple)">ì• ë“œë²Œë£¬</button>
      <button class="ft" id="sheetBtn" style="margin-left:auto;border-color:rgba(74,222,128,.3);color:var(--blue)" onclick="exportSheets()">ğŸ“Š êµ¬ê¸€ì‹œíŠ¸</button>
      <button class="ft" style="border-color:rgba(110,231,183,.3);color:var(--cyan)" onclick="exportCSV()">ğŸ“„ CSV</button>
      <button class="ft" style="border-color:rgba(239,68,68,.3);color:var(--red)" onclick="resetResults()">ğŸ—‘ ì´ˆê¸°í™”</button>
    </div>
    <div class="results" id="resList">
      <div class="empty"><div class="icon">ğŸ®</div>ë³„í’ì„ ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
    </div>
  </div>

  <!-- ë¡œê·¸ -->
  <div class="sec">
    <h2>â­ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
    <div class="blog" id="bLog"><div class="empty" style="padding:12px"><div class="icon">â³</div>ëŒ€ê¸° ì¤‘...</div></div>
  </div>

</div>

<script>
let templates=[], results=[], filter='all', typeFilter='all', autoThreshold=0, es=null, editingId=null;
let authToken=sessionStorage.getItem('mk_token')||'';

// ì¸ì¦
async function doLogin(){
  const pw=document.getElementById('loginPw').value;
  if(!pw){document.getElementById('loginErr').textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';return}
  try{
    const r=await fetch('/api/auth',{method:'POST',headers:authHeaders(),body:JSON.stringify({password:pw})});
    const d=await r.json();
    if(d.ok){authToken=d.token;sessionStorage.setItem('mk_token',authToken);showMain()}
    else{document.getElementById('loginErr').textContent=d.error||'í‹€ë ¸ìŠµë‹ˆë‹¤'}
  }catch(e){document.getElementById('loginErr').textContent='ì„œë²„ ì—°ê²° ì‹¤íŒ¨'}
}
function showMain(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';loadCfg();connectSSE()}
function authHeaders(){return{'Content-Type':'application/json','X-Auth':authToken}}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
async function changePw(){
  const np=prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ):');
  if(!np||np.length<4){if(np!==null)alert('4ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');return}
  const r=await fetch('/api/change-password',{method:'POST',headers:authHeaders(),body:JSON.stringify({newPassword:np})});
  const d=await r.json();
  if(d.ok){authToken=d.token;sessionStorage.setItem('mk_token',authToken);alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤')}
  else{alert(d.error||'ë³€ê²½ ì‹¤íŒ¨')}
}

document.getElementById('loginPw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});

// ì´ì „ í† í°ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì‹œë„
if(authToken){fetch('/api/config',{headers:{'X-Auth':authToken}}).then(r=>{if(r.ok)showMain();else{sessionStorage.removeItem('mk_token');authToken=''}}).catch(()=>{});}


function connectSSE(){
  if(es)es.close();
  es=new EventSource('/api/events');
  es.addEventListener('status',e=>{const d=JSON.parse(e.data);updConn(d.status,d.streamerId,d.error)});
  es.addEventListener('templates',e=>{templates=JSON.parse(e.data);renderTpl()});
  es.addEventListener('autoThreshold',e=>{autoThreshold=JSON.parse(e.data).value;updAutoDesc()});
  es.addEventListener('result',e=>{const r=JSON.parse(e.data);if(!results.find(x=>x.id===r.id)){results.unshift(r);renderRes();updStats();playSound()}});
  es.addEventListener('resultUpdate',e=>{const r=JSON.parse(e.data);const i=results.findIndex(x=>x.id===r.id);if(i>=0)results[i]=r;renderRes();updStats()});
  es.addEventListener('resultDelete',e=>{results=results.filter(r=>r.id!==JSON.parse(e.data).id);renderRes();updStats()});
  es.addEventListener('resetResults',()=>{results=[];renderRes();updStats()});
  es.addEventListener('balloon',e=>{addBLog(JSON.parse(e.data))});
  es.addEventListener('donationMsg',e=>{
    const d=JSON.parse(e.data);
    addBLog({...d, type:'tts'});
  });
}

function updConn(s,id,err){
  const d=document.getElementById('dot'),t=document.getElementById('connTxt');
  d.className='dot';
  if(s==='connected'){d.classList.add('on');t.textContent=`${id} ì—°ê²°ë¨`}
  else if(s==='connecting'){d.classList.add('wait');t.textContent='ì—°ê²° ì¤‘...'}
  else if(s==='error'){d.classList.add('off');t.textContent=`ì˜¤ë¥˜: ${err||''}`}
  else if(s==='no_config'){d.classList.add('off');t.textContent='ìŠ¤íŠ¸ë¦¬ë¨¸ ID ì…ë ¥'}
  else{d.classList.add('off');t.textContent='ì—°ê²° ì•ˆë¨'}
}

async function setStreamer(){const id=document.getElementById('sInput').value.trim();if(!id)return;await fetch('/api/config',{method:'POST',headers:authHeaders(),body:JSON.stringify({streamerId:id})})}
async function doReconnect(){await fetch('/api/reconnect',{method:'POST'})}

// ìë™ë“±ë¡ ì„ê³„ê°’
async function setAutoThreshold(){
  const v=parseInt(document.getElementById('autoVal').value)||0;
  await fetch('/api/auto-threshold',{method:'POST',headers:authHeaders(),body:JSON.stringify({value:v})});
}
function updAutoDesc(){
  document.getElementById('autoVal').value=autoThreshold;
  document.getElementById('autoDesc').textContent=autoThreshold>0?`í˜„ì¬: ${autoThreshold}ê°œ ì´ìƒ ìë™ë“±ë¡ í™œì„± âœ…`:'í˜„ì¬: ë¹„í™œì„±';
}

// íƒ€ì… ì¹©
let selectedType='all';
function pickType(btn){
  selectedType=btn.dataset.val;
  btn.closest('.type-chips').querySelectorAll('.tc').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// í…œí”Œë¦¿
async function addTemplate(){
  const name=document.getElementById('tName').value.trim()||'ë¯¸ì…˜';
  const starCount=parseInt(document.getElementById('tCount').value)||500;
  const eventType=selectedType;
  const collectDomain=document.getElementById('tDomain').checked;
  const collectMessage=document.getElementById('tMsg').checked;
  await fetch('/api/templates',{method:'POST',headers:authHeaders(),body:JSON.stringify({name,starCount,eventType,collectDomain,collectMessage})});
  document.getElementById('tName').value='';
}

function renderTpl(){
  const el=document.getElementById('tplList');
  if(!templates.length){el.innerHTML='<div class="empty" style="padding:12px;width:100%"><div class="icon">ğŸ“‹</div>ë¯¸ì…˜ì„ ë“±ë¡í•´ì£¼ì„¸ìš”!</div>';return}
  el.innerHTML=templates.map(t=>{
    if(editingId===t.id){
      const et=t.eventType||'all';
      return`<div class="tpl-card editing">
        <div class="edit-inline">
          <input id="eName" value="${t.name}" style="width:80px" placeholder="ì´ë¦„">
          <input id="eCount" type="number" value="${t.starCount}" style="width:70px">
          <div class="type-chips" id="eTypeChips">
            <button class="tc ${et==='all'?'active':''}" data-val="all" onclick="pickEditType(this)">ì „ì²´</button>
            <button class="tc ${et==='balloon'?'active':''}" data-val="balloon" onclick="pickEditType(this)">â­ë³„í’</button>
            <button class="tc ${et==='adballoon'?'active':''}" data-val="adballoon" onclick="pickEditType(this)">ğŸˆì• ë“œ</button>
            <button class="tc ${et==='mission'?'active':''}" data-val="mission" onclick="pickEditType(this)">âš”ëŒ€ê²°</button>
          </div>
          <label style="font-size:10px;color:var(--text2);display:flex;align-items:center;gap:3px"><input type="checkbox" id="eDomain" ${t.collectDomain?'checked':''} style="width:12px;height:12px">ğŸ”—</label>
          <label style="font-size:10px;color:var(--text2);display:flex;align-items:center;gap:3px"><input type="checkbox" id="eMsg" ${t.collectMessage?'checked':''} style="width:12px;height:12px">ğŸ’¬</label>
          <button class="save" onclick="saveEdit(${t.id})">ì €ì¥</button>
          <button class="cancel" onclick="editingId=null;renderTpl()">ì·¨ì†Œ</button>
        </div>
      </div>`;
    }
    return`<div class="tpl-card ${t.active?'':'inactive'}">
      <div class="tpl-star">â­${t.starCount}</div>
      <div>
        <div class="tpl-name">${t.name}</div>
        <div class="tpl-cond">${t.starCount}ê°œ Â· ${({all:'ì „ì²´',balloon:'ë³„í’ì„ ',adballoon:'ì• ë“œë²Œë£¬',mission:'ëŒ€ê²°ë¯¸ì…˜'})[t.eventType||'all']}</div>
        <div class="tpl-tags">
          <span class="tpl-tag" style="background:rgba(74,222,128,.12);color:var(--blue)">${({all:'ì „ì²´',balloon:'â­ë³„í’',adballoon:'ğŸˆì• ë“œ',mission:'âš”ëŒ€ê²°'})[t.eventType||'all']}</span>
          ${t.collectDomain?'<span class="tpl-tag domain">ğŸ”—ë„ë©”ì¸</span>':''}
          ${t.collectMessage?'<span class="tpl-tag msg">ğŸ’¬ë©”ì‹œì§€</span>':''}
        </div>
      </div>
      <div class="tpl-actions">
        <button class="tpl-btn edit" onclick="startEdit(${t.id})">âœ</button>
        <button class="tpl-btn" onclick="toggleTpl(${t.id})">${t.active?'â¸':'â–¶'}</button>
        <button class="tpl-btn del" onclick="delTpl(${t.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

let editType='all';
function pickEditType(btn){
  editType=btn.dataset.val;
  btn.closest('.type-chips').querySelectorAll('.tc').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function startEdit(id){editingId=id;const t=templates.find(x=>x.id===id);editType=t?.eventType||'all';renderTpl()}
async function saveEdit(id){
  const name=document.getElementById('eName').value.trim();
  const starCount=parseInt(document.getElementById('eCount').value);
  const eventType=editType;
  const collectDomain=document.getElementById('eDomain').checked;
  const collectMessage=document.getElementById('eMsg').checked;
  await fetch('/api/templates/update',{method:'POST',headers:authHeaders(),body:JSON.stringify({id,name,starCount,eventType,collectDomain,collectMessage})});
  editingId=null;
}
async function toggleTpl(id){await fetch('/api/templates/toggle',{method:'POST',headers:authHeaders(),body:JSON.stringify({id})})}
async function delTpl(id){if(!confirm('ì‚­ì œ?'))return;await fetch('/api/templates/delete',{method:'POST',headers:authHeaders(),body:JSON.stringify({id})})}

// ê²°ê³¼
function renderRes(){
  const el=document.getElementById('resList');
  let list=results;
  if(filter==='pending')list=list.filter(r=>!r.completed);
  else if(filter==='done')list=list.filter(r=>r.completed);
  if(typeFilter!=='all')list=list.filter(r=>(r.eventType||'balloon')===typeFilter);
  if(!list.length){el.innerHTML='<div class="empty"><div class="icon">ğŸ®</div>ë¯¸ì…˜ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>';return}
  el.innerHTML=list.map(r=>{
    const et=r.eventType||'balloon';
    const isAuto=r.isAutoThreshold;
    const badgeClass=isAuto?'auto':et;
    const linkBtn=r.channelUrl&&!r.completed?`<a href="${r.channelUrl}" target="_blank" class="rb go">ë°©ì†¡êµ­â†’</a>`:'';
    const memoField=r.collectMessage?`<input class="r-memo" value="${r.message||''}" placeholder="ë©”ëª¨..." onchange="updMemo(${r.id},this.value)" onclick="event.stopPropagation()">`:'';
    const tagHtml=isAuto?'<span class="tag thresh">ìë™ë“±ë¡</span>':'<span class="tag auto">ë§¤ì¹­</span>';
    const msgDisplay=r.message?`<span class="r-msg">"${r.message}"</span>`:'';
    const memoLine=r.collectMessage&&!r.message?`<div class="r-detail">${memoField}</div>`:'';
    return`<div class="r-card ${r.completed?'done':''}">
      <span class="r-badge ${badgeClass}">â­${r.amount} ${r.templateName}</span>
      <div class="r-info">
        <div class="r-user">${r.userNickname||r.userId||'?'} ${msgDisplay} ${tagHtml}</div>
        ${memoLine}
      </div>
      <div class="stamp">ì™„ë£Œ</div>
      <div class="r-time">${r.createdAt}</div>
      <div class="r-acts">
        ${linkBtn}
        <button class="rb ${r.completed?'undo':'ok'}" onclick="toggleRes(${r.id})">${r.completed?'â†©':'âœ…'}</button>
        <button class="rb del" onclick="delRes(${r.id})">âœ•</button>
      </div>
    </div>`
  }).join('');
}

function setF(f,btn){filter=f;document.querySelectorAll('.ft:not(.type-ft)').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderRes()}
function setTF(f,btn){typeFilter=f;document.querySelectorAll('.type-ft').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderRes()}
function updStats(){
  const t=results.length,d=results.filter(r=>r.completed).length;
  document.getElementById('s1').textContent=t;
  document.getElementById('s2').textContent=t-d;
  document.getElementById('s3').textContent=d;
  document.getElementById('s4').textContent=results.filter(r=>r.collectDomain&&!r.completed).length;
}

async function toggleRes(id){await fetch('/api/results/toggle',{method:'POST',headers:authHeaders(),body:JSON.stringify({id})})}
async function delRes(id){await fetch('/api/results/delete',{method:'POST',headers:authHeaders(),body:JSON.stringify({id})})}
async function updMemo(id,message){await fetch('/api/results/memo',{method:'POST',headers:authHeaders(),body:JSON.stringify({id,message})})}
async function resetResults(){if(confirm('ì „ì²´ ì´ˆê¸°í™”?'))await fetch('/api/results/reset',{method:'POST'})}

// Google Sheets ì¶”ì¶œ (ì§ì ‘ API)
async function exportSheets(){
  if(!results.length){alert('ì¶”ì¶œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
  const btn=document.getElementById('sheetBtn');
  btn.textContent='â³ ìƒì„±ì¤‘...';btn.disabled=true;
  try{
    const r=await fetch('/api/export-sheets',{method:'POST',headers:authHeaders(),body:JSON.stringify({})});
    const d=await r.json();
    btn.textContent='ğŸ“Š êµ¬ê¸€ì‹œíŠ¸';btn.disabled=false;
    if(d.ok!==false&&d.url){window.open(d.url,'_blank')}
    else{alert(d.error||'ì „ì†¡ ì‹¤íŒ¨')}
  }catch(e){btn.textContent='ğŸ“Š êµ¬ê¸€ì‹œíŠ¸';btn.disabled=false;alert('ì˜¤ë¥˜: '+e.message)}
}

// CSV ì¶”ì¶œ (Google Sheets í˜¸í™˜)
function exportCSV(){
  if(!results.length){alert('ì¶”ì¶œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
  const typeName={balloon:'ë³„í’ì„ ',adballoon:'ì• ë“œë²Œë£¬',video:'ì˜ìƒí’ì„ ',mission:'ëŒ€ê²°ë¯¸ì…˜'};
  const header=['ë¯¸ì…˜ëª…','íƒ€ì…','ê°œìˆ˜','ë‹‰ë„¤ì„','ìœ ì €ID','ë„ë©”ì¸','ë©”ì‹œì§€','ìƒíƒœ','ì‹œê°„'];
  const rows=results.map(r=>[
    r.templateName||'',
    typeName[r.eventType||'balloon']||r.eventType||'',
    r.amount||'',
    r.userNickname||'',
    r.userId||'',
    r.channelUrl||'',
    (r.message||'').replace(/"/g,'""'),
    r.completed?'ì™„ë£Œ':'ì§„í–‰ì¤‘',
    r.createdAt||''
  ]);
  const bom='\uFEFF';
  const csv=bom+[header,...rows].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const d=new Date();
  a.download=`MKë¯¸ì…˜_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ë¡œê·¸
let blogFirst=true;
function addBLog(b){
  const el=document.getElementById('bLog');
  if(blogFirst){el.innerHTML='';blogFirst=false}
  const tc={balloon:'color:var(--blue)',adballoon:'color:var(--purple)',video:'color:var(--cyan)',mission:'color:var(--yellow);font-weight:800',tts:'color:var(--orange);font-weight:800'};
  const tn={balloon:'ë³„í’',adballoon:'ì• ë“œ',video:'ì˜ìƒ',mission:'ëŒ€ê²°',tts:'ğŸ’¬TTS'};
  const tp=b.type||'balloon';
  const mTitle=b.missionTitle?` [${b.missionTitle}]`:'';
  const msgHtml=b.message?`<span style="color:var(--orange);font-weight:600;margin-left:4px">"${b.message}"</span>`:'';
  el.insertAdjacentHTML('afterbegin',`<div class="be"><span class="a">â­${b.amount}</span><span class="tp" style="${tc[tp]||''}">${tn[tp]||tp}${mTitle}</span><span class="n">${b.userNickname}</span>${msgHtml}<span class="t">${b.time}</span></div>`);
  while(el.children.length>100)el.lastChild.remove();
}


function playSound(){try{const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=880;o.type='sine';g.gain.value=.12;o.start();g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.25);o.stop(c.currentTime+.25)}catch(e){}}

async function loadCfg(){try{const r=await fetch('/api/config');const c=await r.json();if(c.streamerId)document.getElementById('sInput').value=c.streamerId;if(c.autoThreshold){autoThreshold=c.autoThreshold;updAutoDesc()}}catch(e){}}

document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.target.id==='sInput')setStreamer();
  if(e.key==='Enter'&&['tName','tCount'].includes(e.target.id))addTemplate();
  if(e.key==='Enter'&&e.target.id==='autoVal')setAutoThreshold();
});

// loadCfg, connectSSEëŠ” ë¡œê·¸ì¸ ì„±ê³µ ì‹œ showMain()ì—ì„œ í˜¸ì¶œ
</script>
</body>
</html>
