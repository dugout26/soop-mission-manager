<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MK ëŒ€ê²°ë¯¸ì…˜ ë§¤ë‹ˆì €</title>
<link rel="icon" href="icon.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#080f0a;--card:#0f1a12;--card2:#162219;--blue:#4ade80;--orange:#f97316;--green:#22c55e;--red:#ef4444;--purple:#86efac;--cyan:#6ee7b7;--yellow:#eab308;--text:#f1f4f1;--text2:#88a090;--muted:#557060;--border:#1e3625}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:linear-gradient(rgba(74,222,128,.04)1px,transparent 1px),linear-gradient(90deg,rgba(74,222,128,.04)1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.app{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:16px}

.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.logo{font-family:'Black Han Sans';font-size:22px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px}
.logo img{width:32px;height:32px;border-radius:6px}
.logo-sub{font-size:10px;color:var(--muted)}

.conn{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:12px;flex-wrap:wrap}
.dot{width:8px;height:8px;border-radius:50%}
.dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.dot.wait{background:var(--orange);animation:p 1s infinite}
.dot.off{background:var(--red)}
@keyframes p{0%,100%{opacity:1}50%{opacity:.3}}
.ci{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;width:130px;font-family:inherit}
.ci:focus{outline:none;border-color:var(--blue)}
.cb{padding:4px 10px;border-radius:4px;border:1px solid var(--blue);background:rgba(74,222,128,.1);color:var(--blue);font-size:10px;font-weight:700;cursor:pointer;font-family:inherit}

.stats{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.st{flex:1;min-width:120px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px 16px}
.st-l{font-size:11px;color:var(--muted);font-weight:600}
.st-v{font-size:28px;font-weight:900;margin-top:2px}

.sec{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px 24px;margin-bottom:16px}
.sec h2{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:6px}
.sec h2 .sub{font-size:11px;color:var(--muted);font-weight:400}

/* ìë™ë“±ë¡ ì„ê³„ê°’ */
.auto-box{display:flex;align-items:center;gap:10px;padding:14px 18px;background:rgba(234,179,8,.06);border:1px solid rgba(234,179,8,.2);border-radius:8px;margin-bottom:14px;flex-wrap:wrap}
.auto-box label{font-size:13px;font-weight:700;color:var(--yellow)}
.auto-box input{padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:14px;width:90px;font-family:inherit;text-align:center}
.auto-box input:focus{outline:none;border-color:var(--yellow)}
.auto-box .desc{font-size:10px;color:var(--muted)}
.auto-box button{padding:6px 14px;border-radius:4px;border:1px solid var(--yellow);background:rgba(234,179,8,.1);color:var(--yellow);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}

/* ë¯¸ì…˜ ë“±ë¡ */
.tpl-form{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.fg{display:flex;flex-direction:column;gap:3px}
.fg label{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select{padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:inherit}
.fg input:focus{outline:none;border-color:var(--blue)}
.chk-group{display:flex;gap:12px;align-items:center}
.chk-group label{display:flex;align-items:center;gap:5px;font-size:13px;color:var(--text2);cursor:pointer;user-select:none}
.chk-group input[type=checkbox]{accent-color:var(--blue);width:16px;height:16px}
.btn-add{padding:8px 20px;background:linear-gradient(135deg,#4ade80,#22c55e);border:none;border-radius:6px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap}

/* ë“±ë¡ëœ í…œí”Œë¦¿ */
.tpl-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.tpl-card{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;display:flex;align-items:center;gap:12px;position:relative}
.tpl-card.inactive{opacity:.35}
.tpl-card.editing{border-color:var(--blue)}
.tpl-star{font-size:22px;font-weight:900;color:var(--orange);font-family:'Black Han Sans';white-space:nowrap}
.tpl-name{font-size:15px;font-weight:700}
.tpl-tags{display:flex;gap:5px;margin-top:4px}
.tpl-tag{font-size:11px;padding:3px 7px;border-radius:4px;font-weight:600}
.tpl-tag.domain{background:rgba(59,130,246,.12);color:var(--blue)}
.tpl-tag.msg{background:rgba(249,115,22,.12);color:var(--orange)}
.tpl-cond{font-size:11px;color:var(--cyan);margin-top:2px}
.tpl-actions{margin-left:auto;display:flex;gap:4px}
.tpl-btn{padding:5px 8px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit}
.tpl-btn:hover{border-color:var(--muted)}
.tpl-btn.del{color:var(--red);border-color:rgba(239,68,68,.3)}
.tpl-btn.edit{color:var(--blue);border-color:rgba(59,130,246,.3)}

/* í¸ì§‘ ì¸ë¼ì¸ */
.edit-inline{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.edit-inline input{padding:3px 6px;background:var(--bg);border:1px solid var(--blue);border-radius:3px;color:var(--text);font-size:10px;font-family:inherit}
.edit-inline input:focus{outline:none}
.edit-inline button{padding:3px 8px;border-radius:3px;border:none;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit}
.edit-inline .save{background:var(--blue);color:#fff}
.edit-inline .cancel{background:var(--border);color:var(--text2)}

/* ê²°ê³¼ */
.filters{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.ft{padding:5px 12px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit}
.ft.active{background:var(--blue);color:#fff;border-color:var(--blue)}

.results{display:flex;flex-direction:column;gap:8px}
.r-card{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:18px 20px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden;transition:all .15s}
.r-card:hover{border-color:var(--muted)}
.r-card.done{background:rgba(239,68,68,.05);border-color:rgba(239,68,68,.15)}
.r-card.done .r-info *{text-decoration:line-through;opacity:.35}

.r-badge{padding:6px 14px;border-radius:6px;font-size:15px;font-weight:800;white-space:nowrap;letter-spacing:.3px}
.r-badge.balloon{background:rgba(74,222,128,.1);color:var(--blue)}
.r-badge.adballoon{background:rgba(168,85,247,.1);color:var(--purple)}
.r-badge.video{background:rgba(6,182,212,.1);color:var(--cyan)}
.r-badge.mission{background:rgba(234,179,8,.1);color:var(--yellow);border:1px solid rgba(234,179,8,.3)}
.r-badge.challenge{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.3)}
.r-badge.auto{background:rgba(234,179,8,.1);color:var(--yellow)}

.r-info{flex:1;min-width:0}
.r-user{font-size:18px;font-weight:700;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.r-user .tag{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600}
.r-user .tag.auto{background:rgba(34,197,94,.15);color:var(--green)}
.r-user .tag.thresh{background:rgba(234,179,8,.15);color:var(--yellow)}
.r-msg{font-size:18px;color:var(--orange);font-weight:800;max-width:500px;overflow:hidden;text-overflow:ellipsis}
.r-detail{font-size:12px;color:var(--text2);margin-top:3px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.r-link{color:var(--blue);text-decoration:none;font-weight:600;font-size:12px}
.r-link:hover{text-decoration:underline}
.r-memo{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:14px;width:220px;font-family:inherit}
.r-memo:focus{outline:none;border-color:var(--orange)}
.r-time{font-size:13px;color:var(--muted);white-space:nowrap}
.r-acts{display:flex;gap:3px}
.rb{padding:6px 12px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .12s}
.rb:hover{border-color:var(--muted);color:var(--text)}
.rb.go{border-color:var(--blue);color:var(--blue)}
.rb.ok{border-color:var(--green);color:var(--green)}
.rb.undo{border-color:var(--orange);color:var(--orange)}
.rb.del{border-color:var(--red);color:var(--red);padding:4px 6px}

.stamp{display:none;position:absolute;right:50px;top:50%;transform:translateY(-50%) rotate(-12deg);border:2px solid var(--red);color:var(--red);font-family:'Black Han Sans';font-size:20px;padding:2px 14px;border-radius:4px;letter-spacing:2px;opacity:.45;pointer-events:none}
.r-card.done .stamp{display:block}

/* ë¡œê·¸ */
.blog{max-height:160px;overflow-y:auto;font-size:10px}
.blog::-webkit-scrollbar{width:3px}
.blog::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.be{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:6px}
.be .a{font-weight:800;color:var(--orange);min-width:40px}
.be .n{color:var(--text);font-weight:600}
.be .t{color:var(--muted);margin-left:auto;font-size:8px}
.be .tp{font-size:8px;padding:1px 4px;border-radius:2px;font-weight:600}

.empty{text-align:center;padding:28px 16px;color:var(--muted);font-size:13px}
.empty .icon{font-size:36px;margin-bottom:6px}

/* ë¡¤ ê³„ì • */
.lol-card{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card2);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .12s;text-decoration:none;margin-bottom:4px}
.lol-card:hover{border-color:var(--blue);background:rgba(74,222,128,.05)}
.lol-card .tier-badge{font-size:11px;font-weight:800;padding:3px 8px;border-radius:4px;white-space:nowrap}
.lol-card .tier-badge.MASTER{background:rgba(168,85,247,.15);color:#a855f7}
.lol-card .tier-badge.GRANDMASTER{background:rgba(239,68,68,.15);color:#ef4444}
.lol-card .tier-badge.CHALLENGER{background:rgba(234,179,8,.15);color:#eab308}
.lol-card .tier-badge.DIAMOND{background:rgba(96,165,250,.15);color:#60a5fa}
.lol-card .tier-badge.EMERALD{background:rgba(52,211,153,.15);color:#34d399}
.lol-card .tier-badge.PLATINUM{background:rgba(45,212,191,.15);color:#2dd4bf}
.lol-card .tier-badge.GOLD{background:rgba(251,191,36,.15);color:#fbbf24}
.lol-card .tier-badge.SILVER{background:rgba(148,163,184,.15);color:#94a3b8}
.lol-card .tier-badge.BRONZE{background:rgba(180,83,9,.15);color:#cd7c2f}
.lol-card .tier-badge.IRON{background:rgba(120,113,108,.15);color:#78716c}
.lol-card .tier-badge.unranked{background:rgba(100,116,139,.15);color:#64748b}
.lol-card .riot-id{font-size:14px;font-weight:700;color:var(--text)}
.lol-card .riot-tag{font-size:11px;color:var(--muted);font-weight:600}
.lol-card .lp{font-size:11px;color:var(--text2);font-weight:600}
.lol-card .fow-go{margin-left:auto;font-size:10px;color:var(--muted);white-space:nowrap}

/* íƒ€ì… ì¹© ë²„íŠ¼ */
.type-chips{display:flex;gap:4px}
.tc{padding:5px 10px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .12s;white-space:nowrap}
.tc:hover{border-color:var(--muted);color:var(--text2)}
.tc.active{background:rgba(74,222,128,.15);border-color:var(--blue);color:var(--blue)}
.tc[data-val="mission"].active{background:rgba(234,179,8,.15);border-color:var(--yellow);color:var(--yellow)}
.tc[data-val="balloon"].active{background:rgba(74,222,128,.15);border-color:var(--blue);color:var(--blue)}
.tc[data-val="adballoon"].active{background:rgba(134,239,172,.15);border-color:var(--purple);color:var(--purple)}
.tc[data-val="challenge"].active{background:rgba(251,146,60,.15);border-color:var(--orange);color:var(--orange)}

@media(max-width:768px){.header{flex-direction:column}.stats .st{min-width:calc(50% - 3px)}.tpl-form{flex-direction:column}.r-card{flex-wrap:wrap}}
</style>
</head>
<body>
<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="loginScreen" style="position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:32px;text-align:center;width:320px">
    <img src="icon.png" style="width:64px;height:64px;border-radius:10px;margin-bottom:12px">
    <div style="font-family:'Black Han Sans';font-size:20px;background:linear-gradient(135deg,#4ade80,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px">MK ëŒ€ê²°ë¯¸ì…˜ ë§¤ë‹ˆì €</div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:20px">ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;text-align:center;margin-bottom:10px">
    <div id="loginErr" style="font-size:10px;color:var(--red);margin-bottom:8px;min-height:14px"></div>
    <button onclick="doLogin()" style="width:100%;padding:10px;background:linear-gradient(135deg,#4ade80,#22c55e);border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">ì…ì¥</button>
  </div>
</div>

<div class="app" id="mainApp" style="display:none">
  <div class="header">
    <div>
      <div class="logo"><img src="icon.png" alt="MK">MK
        <a href="/" style="text-decoration:none;-webkit-text-fill-color:inherit;border-bottom:2px solid var(--green);padding-bottom:1px;margin-left:4px">ë¯¸ì…˜ë§¤ë‹ˆì €</a>
        <span style="-webkit-text-fill-color:var(--muted);font-size:16px;margin:0 2px">/</span>
        <a href="/team" style="text-decoration:none;-webkit-text-fill-color:var(--muted);font-size:16px">íŒ€ë½‘ê¸°</a>
        <span style="-webkit-text-fill-color:var(--muted);font-size:16px;margin:0 2px">/</span>
        <a href="/ladder" style="text-decoration:none;-webkit-text-fill-color:var(--muted);font-size:16px">ì‚¬ë‹¤ë¦¬</a>
        <span style="-webkit-text-fill-color:var(--muted);font-size:16px;margin:0 2px">/</span>
        <a href="/control" style="text-decoration:none;-webkit-text-fill-color:var(--muted);font-size:16px">ì§€í†µì‹¤</a>
      </div>
    </div>
    <div class="conn">
      <div class="dot off" id="dot"></div>
      <span id="connTxt">ì—°ê²° ì•ˆë¨</span>
      <input class="ci" id="sInput" value="phonics1" readonly style="opacity:.6;cursor:default">
      <button class="cb" onclick="setStreamer()">ì—°ê²°</button>
      <button class="cb" onclick="doReconnect()">ğŸ”„</button>
      <button class="cb" onclick="changePw()" style="border-color:var(--muted);color:var(--muted)">ğŸ”‘</button>
      <div style="position:relative;display:inline-block">
        <button class="cb" id="lolBtn" onclick="toggleLolPanel()" style="border-color:var(--cyan);color:var(--cyan)">ğŸ® ì „ì </button>
        <div id="lolPanel" style="display:none;position:absolute;right:0;top:110%;width:340px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,.5)">
          <div style="position:relative;margin-bottom:8px">
            <input id="lolName" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰ (ì˜ˆ: ê¹€ë¯¼êµ)" style="width:100%;padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;font-family:inherit;box-sizing:border-box">
            <div id="lolSearchResults" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--card2);border:1px solid var(--border);border-radius:0 0 8px 8px;z-index:10"></div>
          </div>
          <div id="lolSelected" style="display:none;margin-bottom:8px;padding:8px;background:var(--bg);border-radius:6px;display:none"></div>
          <div id="lolList" style="max-height:300px;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="stats">
    <div class="st"><div class="st-l">ì „ì²´</div><div class="st-v" style="color:var(--blue)" id="s1">0</div></div>
    <div class="st"><div class="st-l">ì§„í–‰ì¤‘</div><div class="st-v" style="color:var(--orange)" id="s2">0</div></div>
    <div class="st"><div class="st-l">ì™„ë£Œ</div><div class="st-v" style="color:var(--green)" id="s3">0</div></div>
  </div>

  <!-- ë¯¸ì…˜ ë“±ë¡ -->
  <div class="sec">
    <h2>ğŸ“‹ ë¯¸ì…˜ ë“±ë¡</h2>

    <!-- ìë™ë“±ë¡ ì„ê³„ê°’ -->
    <div class="auto-box">
      <label>âš¡ ìë™ë“±ë¡</label>
      <input id="autoVal" type="number" placeholder="0" value="0" min="0" step="100">
      <span style="font-size:11px;color:var(--text2)">ê°œ ì´ìƒì´ë©´ í…œí”Œë¦¿ ì—†ì–´ë„ ìë™ë“±ë¡</span>
      <button onclick="setAutoThreshold()">ì ìš©</button>
      <button onclick="document.getElementById('autoVal').value='0';setAutoThreshold()" style="border-color:var(--red);color:var(--red)">ë„ê¸°</button>
      <div class="desc" id="autoDesc">í˜„ì¬: ë¹„í™œì„±</div>
    </div>

    <!-- ë“±ë¡ í¼ -->
    <div class="tpl-form">
      <div class="fg"><label>ë¯¸ì…˜ ì´ë¦„</label><input id="tName" placeholder="ì—­íŒ¬, ë°©ì…€ ë“±" style="width:100px"></div>
      <div class="fg"><label>ê°œìˆ˜ (ì •í™•íˆ)</label><input id="tCount" type="number" value="500" style="width:80px"></div>
      <div class="fg"><label>íƒ€ì…</label>
        <div class="type-chips" id="tTypeChips">
          <button class="tc active" data-val="all" onclick="pickType(this)">ì „ì²´</button>
          <button class="tc" data-val="balloon" onclick="pickType(this)">â­ë³„í’</button>
          <button class="tc" data-val="adballoon" onclick="pickType(this)">ğŸˆì• ë“œ</button>
          <button class="tc" data-val="mission" onclick="pickType(this)">âš”ëŒ€ê²°</button>
          <button class="tc" data-val="challenge" onclick="pickType(this)">ğŸ¯ë„ì „</button>
        </div>
      </div>
      <div class="chk-group">
        <label><input type="checkbox" id="tDomain" checked> ğŸ”— ë„ë©”ì¸</label>
        <label><input type="checkbox" id="tMsg" checked> ğŸ’¬ ë©”ì‹œì§€</label>
      </div>
      <button class="btn-add" onclick="addTemplate()">+ ë“±ë¡</button>
    </div>

    <div class="tpl-list" id="tplList"></div>
  </div>

  <!-- ë¯¸ì…˜ í˜„í™© -->
  <div class="sec">
    <h2>ğŸ¯ ë¯¸ì…˜ í˜„í™©</h2>
    <div class="filters">
      <button class="ft active" onclick="setF('all',this)">ì „ì²´</button>
      <button class="ft" onclick="setF('pending',this)">ì§„í–‰ì¤‘</button>
      <button class="ft" onclick="setF('done',this)">ì™„ë£Œ</button>
      <span style="width:1px;height:16px;background:var(--border);margin:0 4px"></span>
      <button class="ft type-ft" onclick="setTF('all',this)" style="border-color:rgba(74,222,128,.3);color:var(--blue)">ëª¨ë“ íƒ€ì…</button>
      <button class="ft type-ft" onclick="setTF('mission',this)" style="border-color:rgba(234,179,8,.3);color:var(--yellow)">ëŒ€ê²°ë¯¸ì…˜</button>
      <button class="ft type-ft" onclick="setTF('challenge',this)" style="border-color:rgba(251,146,60,.3);color:var(--orange)">ë„ì „ë¯¸ì…˜</button>
      <button class="ft type-ft" onclick="setTF('balloon',this)" style="border-color:rgba(74,222,128,.3);color:var(--blue)">ë³„í’ì„ </button>
      <button class="ft type-ft" onclick="setTF('adballoon',this)" style="border-color:rgba(134,239,172,.3);color:var(--purple)">ì• ë“œë²Œë£¬</button>
      <span style="width:1px;height:16px;background:var(--border);margin:0 4px"></span>
      <span id="missionFilters"></span>
      <button class="ft" id="sheetBtn" style="margin-left:auto;border-color:rgba(74,222,128,.3);color:var(--blue)" onclick="exportSheets()">ğŸ“Š êµ¬ê¸€ì‹œíŠ¸</button>
      <button class="ft" style="border-color:rgba(110,231,183,.3);color:var(--cyan)" onclick="exportCSV()">ğŸ“„ CSV</button>
      <button class="ft" style="border-color:rgba(239,68,68,.3);color:var(--red)" onclick="resetResults()">ğŸ—‘ ì´ˆê¸°í™”</button>
    </div>
    <div class="results" id="resList">
      <div class="empty"><div class="icon">ğŸ®</div>ë³„í’ì„ ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
    </div>
  </div>

  <div id="bLog" style="display:none"></div>

</div>

<script>
let templates=[], results=[], filter='all', typeFilter='all', missionFilter='all', autoThreshold=0, es=null, editingId=null;

// ì¸ì¦ (ì¿ í‚¤ ê¸°ë°˜ â€” ì„œë²„ê°€ Set-Cookieë¡œ ê´€ë¦¬)
async function doLogin(){
  const pw=document.getElementById('loginPw').value;
  if(!pw){document.getElementById('loginErr').textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';return}
  try{
    const r=await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const d=await r.json();
    if(d.ok){showMain()}
    else{document.getElementById('loginErr').textContent=d.error||'í‹€ë ¸ìŠµë‹ˆë‹¤'}
  }catch(e){document.getElementById('loginErr').textContent='ì„œë²„ ì—°ê²° ì‹¤íŒ¨'}
}
function showMain(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';loadCfg();connectSSE()}
function showLogin(msg){document.getElementById('loginScreen').style.display='flex';document.getElementById('mainApp').style.display='none';if(msg)document.getElementById('loginErr').textContent=msg;}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
async function changePw(){
  const np=prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ):');
  if(!np||np.length<4){if(np!==null)alert('4ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');return}
  const r=await authFetch('/api/change-password',{method:'POST',body:JSON.stringify({newPassword:np})});
  const d=await r.json();
  if(d.ok){alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤')}
  else{alert(d.error||'ë³€ê²½ ì‹¤íŒ¨')}
}

document.getElementById('loginPw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});

// ì¿ í‚¤ë¡œ ìë™ ë¡œê·¸ì¸ (ì¿ í‚¤ëŠ” ë¸Œë¼ìš°ì €ê°€ ìë™ ì „ì†¡)
fetch('/api/verify').then(r=>{if(r.ok)showMain()}).catch(()=>{});

// 401 ë°œìƒ ì‹œ ì¬ë¡œê·¸ì¸
function authFetch(url,opts={}){
  if(!opts.headers) opts.headers={};
  opts.headers['Content-Type']='application/json';
  return fetch(url,opts).then(r=>{
    if(r.status===401){showLogin('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”');}
    return r;
  });
}


function connectSSE(){
  if(es)es.close();
  es=new EventSource('/api/events');
  es.addEventListener('status',e=>{const d=JSON.parse(e.data);updConn(d.status,d.streamerId,d.error)});
  es.addEventListener('templates',e=>{templates=JSON.parse(e.data);renderTpl()});
  es.addEventListener('autoThreshold',e=>{autoThreshold=JSON.parse(e.data).value;updAutoDesc()});
  es.addEventListener('result',e=>{const r=JSON.parse(e.data);if(!results.find(x=>x.id===r.id)){results.unshift(r);renderRes();updStats()}});
  es.addEventListener('resultUpdate',e=>{const r=JSON.parse(e.data);const i=results.findIndex(x=>x.id===r.id);if(i>=0)results[i]=r;renderRes();updStats()});
  es.addEventListener('resultDelete',e=>{results=results.filter(r=>r.id!==JSON.parse(e.data).id);renderRes();updStats()});
  es.addEventListener('resetResults',()=>{results=[];renderRes();updStats()});
  es.addEventListener('balloon',e=>{addBLog(JSON.parse(e.data))});
  es.addEventListener('donationMsg',e=>{
    const d=JSON.parse(e.data);
    addBLog({...d, type:'tts'});
  });
}

function updConn(s,id,err){
  const d=document.getElementById('dot'),t=document.getElementById('connTxt');
  d.className='dot';
  if(s==='connected'){d.classList.add('on');t.textContent=`${id} ì—°ê²°ë¨`}
  else if(s==='connecting'){d.classList.add('wait');t.textContent='ì—°ê²° ì¤‘...'}
  else if(s==='error'){d.classList.add('off');t.textContent=`ì˜¤ë¥˜: ${err||''}`}
  else if(s==='no_config'){d.classList.add('off');t.textContent='ìŠ¤íŠ¸ë¦¬ë¨¸ ID ì…ë ¥'}
  else{d.classList.add('off');t.textContent='ì—°ê²° ì•ˆë¨'}
}

async function setStreamer(){const id=document.getElementById('sInput').value.trim();if(!id)return;await authFetch('/api/config',{method:'POST',body:JSON.stringify({streamerId:id})})}
async function doReconnect(){await authFetch('/api/reconnect',{method:'POST'})}

// ìë™ë“±ë¡ ì„ê³„ê°’
async function setAutoThreshold(){
  const v=parseInt(document.getElementById('autoVal').value)||0;
  await authFetch('/api/auto-threshold',{method:'POST',body:JSON.stringify({value:v})});
}
function updAutoDesc(){
  document.getElementById('autoVal').value=autoThreshold;
  document.getElementById('autoDesc').textContent=autoThreshold>0?`í˜„ì¬: ${autoThreshold}ê°œ ì´ìƒ ìë™ë“±ë¡ í™œì„± âœ…`:'í˜„ì¬: ë¹„í™œì„±';
}

// íƒ€ì… ì¹©
let selectedType='all';
function pickType(btn){
  selectedType=btn.dataset.val;
  btn.closest('.type-chips').querySelectorAll('.tc').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// í…œí”Œë¦¿
async function addTemplate(){
  const name=document.getElementById('tName').value.trim()||'ë¯¸ì…˜';
  const starCount=parseInt(document.getElementById('tCount').value)||500;
  const eventType=selectedType;
  const collectDomain=document.getElementById('tDomain').checked;
  const collectMessage=document.getElementById('tMsg').checked;
  await authFetch('/api/templates',{method:'POST',body:JSON.stringify({name,starCount,eventType,collectDomain,collectMessage})});
  document.getElementById('tName').value='';
}

function renderTpl(){
  updateMissionFilters();
  const el=document.getElementById('tplList');
  if(!templates.length){el.innerHTML='<div class="empty" style="padding:12px;width:100%"><div class="icon">ğŸ“‹</div>ë¯¸ì…˜ì„ ë“±ë¡í•´ì£¼ì„¸ìš”!</div>';return}
  el.innerHTML=templates.map(t=>{
    if(editingId===t.id){
      const et=t.eventType||'all';
      return`<div class="tpl-card editing">
        <div class="edit-inline">
          <input id="eName" value="${t.name}" style="width:80px" placeholder="ì´ë¦„">
          <input id="eCount" type="number" value="${t.starCount}" style="width:70px">
          <div class="type-chips" id="eTypeChips">
            <button class="tc ${et==='all'?'active':''}" data-val="all" onclick="pickEditType(this)">ì „ì²´</button>
            <button class="tc ${et==='balloon'?'active':''}" data-val="balloon" onclick="pickEditType(this)">â­ë³„í’</button>
            <button class="tc ${et==='adballoon'?'active':''}" data-val="adballoon" onclick="pickEditType(this)">ğŸˆì• ë“œ</button>
            <button class="tc ${et==='mission'?'active':''}" data-val="mission" onclick="pickEditType(this)">âš”ëŒ€ê²°</button>
            <button class="tc ${et==='challenge'?'active':''}" data-val="challenge" onclick="pickEditType(this)">ğŸ¯ë„ì „</button>
          </div>
          <label style="font-size:10px;color:var(--text2);display:flex;align-items:center;gap:3px"><input type="checkbox" id="eDomain" ${t.collectDomain?'checked':''} style="width:12px;height:12px">ğŸ”—</label>
          <label style="font-size:10px;color:var(--text2);display:flex;align-items:center;gap:3px"><input type="checkbox" id="eMsg" ${t.collectMessage?'checked':''} style="width:12px;height:12px">ğŸ’¬</label>
          <button class="save" onclick="saveEdit(${t.id})">ì €ì¥</button>
          <button class="cancel" onclick="editingId=null;renderTpl()">ì·¨ì†Œ</button>
        </div>
      </div>`;
    }
    return`<div class="tpl-card ${t.active?'':'inactive'}">
      <div class="tpl-star">â­${t.starCount}</div>
      <div>
        <div class="tpl-name">${t.name}</div>
        <div class="tpl-cond">${t.starCount}ê°œ Â· ${({all:'ì „ì²´',balloon:'ë³„í’ì„ ',adballoon:'ì• ë“œë²Œë£¬',mission:'ëŒ€ê²°ë¯¸ì…˜',challenge:'ë„ì „ë¯¸ì…˜'})[t.eventType||'all']}</div>
        <div class="tpl-tags">
          <span class="tpl-tag" style="background:rgba(74,222,128,.12);color:var(--blue)">${({all:'ì „ì²´',balloon:'â­ë³„í’',adballoon:'ğŸˆì• ë“œ',mission:'âš”ëŒ€ê²°',challenge:'ğŸ¯ë„ì „'})[t.eventType||'all']}</span>
          ${t.collectDomain?'<span class="tpl-tag domain">ğŸ”—ë„ë©”ì¸</span>':''}
          ${t.collectMessage?'<span class="tpl-tag msg">ğŸ’¬ë©”ì‹œì§€</span>':''}
        </div>
      </div>
      <div class="tpl-actions">
        <button class="tpl-btn edit" onclick="startEdit(${t.id})">âœ</button>
        <button class="tpl-btn" onclick="toggleTpl(${t.id})">${t.active?'â¸':'â–¶'}</button>
        <button class="tpl-btn del" onclick="delTpl(${t.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

let editType='all';
function pickEditType(btn){
  editType=btn.dataset.val;
  btn.closest('.type-chips').querySelectorAll('.tc').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function startEdit(id){editingId=id;const t=templates.find(x=>x.id===id);editType=t?.eventType||'all';renderTpl()}
async function saveEdit(id){
  const name=document.getElementById('eName').value.trim();
  const starCount=parseInt(document.getElementById('eCount').value);
  const eventType=editType;
  const collectDomain=document.getElementById('eDomain').checked;
  const collectMessage=document.getElementById('eMsg').checked;
  await authFetch('/api/templates/update',{method:'POST',body:JSON.stringify({id,name,starCount,eventType,collectDomain,collectMessage})});
  editingId=null;
}
async function toggleTpl(id){await authFetch('/api/templates/toggle',{method:'POST',body:JSON.stringify({id})})}
async function delTpl(id){if(!confirm('ì‚­ì œ?'))return;await authFetch('/api/templates/delete',{method:'POST',body:JSON.stringify({id})})}

// ê²°ê³¼
function updateMissionFilters(){
  const fromResults=[...new Set(results.map(r=>r.templateName).filter(Boolean))];
  const fromTemplates=templates.filter(t=>t.active).map(t=>t.name);
  const names=[...new Set([...fromTemplates,...fromResults])];
  const el=document.getElementById('missionFilters');
  if(!names.length){el.innerHTML='';return}
  el.innerHTML='<button class="ft mission-ft'+(missionFilter==='all'?' active':'')+'" onclick="setMF(\'all\',this)">ì „ì²´ë¯¸ì…˜</button>'+
    names.map(n=>'<button class="ft mission-ft'+(missionFilter===n?' active':'')+'" onclick="setMF(\''+n.replace(/'/g,"\\'")+'\',this)">'+n+'</button>').join('');
}
function renderRes(){
  updateMissionFilters();
  const el=document.getElementById('resList');
  let list=results;
  if(filter==='pending')list=list.filter(r=>!r.completed);
  else if(filter==='done')list=list.filter(r=>r.completed);
  if(typeFilter!=='all')list=list.filter(r=>(r.eventType||'balloon')===typeFilter);
  if(missionFilter!=='all')list=list.filter(r=>r.templateName===missionFilter);
  if(!list.length){el.innerHTML='<div class="empty"><div class="icon">ğŸ®</div>ë¯¸ì…˜ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>';return}
  el.innerHTML=list.map(r=>{
    const et=r.eventType||'balloon';
    const isAuto=r.isAutoThreshold;
    const badgeClass=isAuto?'auto':et;
    const linkBtn=r.channelUrl&&!r.completed?`<a href="${r.channelUrl}" target="_blank" class="rb go">ë°©ì†¡êµ­â†’</a>`:'';
    const tagHtml=isAuto?'<span class="tag thresh">ìë™ë“±ë¡</span>':'<span class="tag auto">ë§¤ì¹­</span>';
    const msgDisplay=r.message?`<span class="r-msg">"${r.message}"</span>`:'';
    const editBtn=r.collectMessage&&r.message?`<button class="rb edit-memo" onclick="event.stopPropagation();startMemoEdit(${r.id})">âœï¸</button>`:'';
    const memoInput=r.collectMessage&&!r.message?`<div class="r-detail"><input class="r-memo" data-rid="${r.id}" value="" placeholder="ë©”ëª¨..." onclick="event.stopPropagation()"></div>`:'';
    return`<div class="r-card ${r.completed?'done':''}">
      <span class="r-badge ${badgeClass}">â­${r.amount} ${r.templateName}</span>
      <div class="r-info">
        <div class="r-user">${r.userNickname||r.userId||'?'} ${msgDisplay} ${editBtn} ${tagHtml}</div>
        ${memoInput}
      </div>
      <div class="stamp">ì™„ë£Œ</div>
      <div class="r-time">${r.createdAt}</div>
      <div class="r-acts">
        ${linkBtn}
        <button class="rb ${r.completed?'undo':'ok'}" onclick="toggleRes(${r.id})">${r.completed?'â†©':'âœ…'}</button>
        <button class="rb del" onclick="delRes(${r.id})">âœ•</button>
      </div>
    </div>`
  }).join('');
}

function setF(f,btn){filter=f;document.querySelectorAll('.ft:not(.type-ft)').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderRes()}
function setTF(f,btn){typeFilter=f;document.querySelectorAll('.type-ft').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderRes()}
function setMF(f,btn){missionFilter=f;document.querySelectorAll('.mission-ft').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderRes()}
function updStats(){
  const t=results.length,d=results.filter(r=>r.completed).length;
  document.getElementById('s1').textContent=t;
  document.getElementById('s2').textContent=t-d;
  document.getElementById('s3').textContent=d;
}

async function toggleRes(id){await authFetch('/api/results/toggle',{method:'POST',body:JSON.stringify({id})})}
async function delRes(id){await authFetch('/api/results/delete',{method:'POST',body:JSON.stringify({id})})}
async function updMemo(id,message){
  const r=results.find(x=>x.id===id);if(r)r.message=message;
  renderRes();
  await authFetch('/api/results/memo',{method:'POST',body:JSON.stringify({id,message})});
}
function startMemoEdit(id){
  const r=results.find(x=>x.id===id);if(!r)return;
  const card=document.querySelector(`.r-memo-editing[data-rid="${id}"]`);
  if(card)return;
  const userDiv=event.target.closest('.r-info');
  if(!userDiv)return;
  let detail=userDiv.querySelector('.r-detail');
  if(!detail){detail=document.createElement('div');detail.className='r-detail';userDiv.appendChild(detail);}
  detail.innerHTML=`<input class="r-memo r-memo-editing" data-rid="${id}" value="${(r.message||'').replace(/"/g,'&quot;')}" placeholder="ë©”ëª¨ ìˆ˜ì •..." onclick="event.stopPropagation()">`;
  const inp=detail.querySelector('input');
  inp.focus();inp.select();
}
async function resetResults(){if(confirm('ì „ì²´ ì´ˆê¸°í™”?'))await authFetch('/api/results/reset',{method:'POST'})}

// Google Sheets ì¶”ì¶œ (ì§ì ‘ API)
async function exportSheets(){
  if(!results.length){alert('ì¶”ì¶œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
  const btn=document.getElementById('sheetBtn');
  btn.textContent='â³ ìƒì„±ì¤‘...';btn.disabled=true;
  try{
    const r=await authFetch('/api/export-sheets',{method:'POST',body:JSON.stringify({})});
    const d=await r.json();
    btn.textContent='ğŸ“Š êµ¬ê¸€ì‹œíŠ¸';btn.disabled=false;
    if(d.ok!==false&&d.url){window.open(d.url,'_blank')}
    else{alert(d.error||'ì „ì†¡ ì‹¤íŒ¨')}
  }catch(e){btn.textContent='ğŸ“Š êµ¬ê¸€ì‹œíŠ¸';btn.disabled=false;alert('ì˜¤ë¥˜: '+e.message)}
}

// CSV ì¶”ì¶œ (Google Sheets í˜¸í™˜)
function exportCSV(){
  if(!results.length){alert('ì¶”ì¶œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
  const typeName={balloon:'ë³„í’ì„ ',adballoon:'ì• ë“œë²Œë£¬',video:'ì˜ìƒí’ì„ ',mission:'ëŒ€ê²°ë¯¸ì…˜',challenge:'ë„ì „ë¯¸ì…˜'};
  const header=['ë¯¸ì…˜ëª…','íƒ€ì…','ê°œìˆ˜','ë‹‰ë„¤ì„','ìœ ì €ID','ë„ë©”ì¸','ë©”ì‹œì§€','ìƒíƒœ','ì‹œê°„'];
  const rows=results.map(r=>[
    r.templateName||'',
    typeName[r.eventType||'balloon']||r.eventType||'',
    r.amount||'',
    r.userNickname||'',
    r.userId||'',
    r.channelUrl||'',
    (r.message||'').replace(/"/g,'""'),
    r.completed?'ì™„ë£Œ':'ì§„í–‰ì¤‘',
    r.createdAt||''
  ]);
  const bom='\uFEFF';
  const csv=bom+[header,...rows].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const d=new Date();
  a.download=`MKë¯¸ì…˜_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ë¡œê·¸
let blogFirst=true;
function addBLog(b){
  const el=document.getElementById('bLog');
  if(blogFirst){el.innerHTML='';blogFirst=false}
  const tc={balloon:'color:var(--blue)',adballoon:'color:var(--purple)',video:'color:var(--cyan)',mission:'color:var(--yellow);font-weight:800',challenge:'color:var(--orange);font-weight:800',tts:'color:var(--orange);font-weight:800'};
  const tn={balloon:'ë³„í’',adballoon:'ì• ë“œ',video:'ì˜ìƒ',mission:'ëŒ€ê²°',challenge:'ë„ì „',tts:'ğŸ’¬TTS'};
  const tp=b.type||'balloon';
  const mTitle=b.missionTitle?` [${b.missionTitle}]`:'';
  const msgHtml=b.message?`<span style="color:var(--orange);font-weight:600;margin-left:4px">"${b.message}"</span>`:'';
  el.insertAdjacentHTML('afterbegin',`<div class="be"><span class="a">â­${b.amount}</span><span class="tp" style="${tc[tp]||''}">${tn[tp]||tp}${mTitle}</span><span class="n">${b.userNickname}</span>${msgHtml}<span class="t">${b.time}</span></div>`);
  while(el.children.length>100)el.lastChild.remove();
}



async function loadCfg(){try{const r=await fetch('/api/config');const c=await r.json();if(c.streamerId)document.getElementById('sInput').value=c.streamerId;if(c.autoThreshold){autoThreshold=c.autoThreshold;updAutoDesc()}}catch(e){}}

// ë¡¤ ê³„ì • ì¡°íšŒ
const tierOrder={CHALLENGER:0,GRANDMASTER:1,MASTER:2,DIAMOND:3,EMERALD:4,PLATINUM:5,GOLD:6,SILVER:7,BRONZE:8,IRON:9,unranked:10};
let lolOpen=false;
let lolSearchTimer=null;
let lolSelectedStreamer=null;
function toggleLolPanel(){
  lolOpen=!lolOpen;
  document.getElementById('lolPanel').style.display=lolOpen?'block':'none';
  if(lolOpen){document.getElementById('lolName').value='';document.getElementById('lolName').focus();document.getElementById('lolSearchResults').style.display='none';document.getElementById('lolSelected').style.display='none';document.getElementById('lolList').innerHTML='';}
}
document.addEventListener('click',e=>{
  if(lolOpen&&!e.target.closest('#lolPanel')&&!e.target.closest('#lolBtn')){
    lolOpen=false;document.getElementById('lolPanel').style.display='none';
  }
});
// SOOP ìŠ¤íŠ¸ë¦¬ë¨¸ ê²€ìƒ‰
document.addEventListener('input',e=>{
  if(e.target.id==='lolName'){
    clearTimeout(lolSearchTimer);
    const q=e.target.value.trim();
    if(!q){document.getElementById('lolSearchResults').style.display='none';return;}
    lolSearchTimer=setTimeout(()=>searchSoopForLol(q),300);
  }
});
async function searchSoopForLol(q){
  try{
    const r=await fetch('/api/search-streamer?q='+encodeURIComponent(q));
    const d=await r.json();
    const box=document.getElementById('lolSearchResults');
    if(!d.streamers||!d.streamers.length){box.style.display='none';return;}
    box.innerHTML=d.streamers.slice(0,10).map(s=>`<div onclick="selectLolStreamer('${s.name.replace(/'/g,"\\'")}','${s.id}')" style="display:flex;align-items:center;gap:8px;padding:7px 10px;cursor:pointer;border-bottom:1px solid var(--border);font-size:12px;color:var(--text)" onmouseover="this.style.background='var(--card)'" onmouseout="this.style.background='transparent'"><img src="${s.profileImage||''}" style="width:24px;height:24px;border-radius:50%;background:var(--border)" onerror="this.style.display='none'"><span>${s.name}</span><span style="color:var(--muted);font-size:10px;margin-left:auto">${s.id}</span></div>`).join('');
    box.style.display='block';
  }catch(e){}
}
function selectLolStreamer(name,id){
  lolSelectedStreamer={name,id};
  document.getElementById('lolName').value=name;
  document.getElementById('lolSearchResults').style.display='none';
  document.getElementById('lolSelected').style.display='block';
  document.getElementById('lolSelected').innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:12px;color:var(--text);font-weight:700">${name}</span><button onclick="searchLol()" style="padding:4px 12px;border-radius:4px;border:1px solid var(--cyan);background:transparent;color:var(--cyan);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">ì „ì  ì¡°íšŒ</button></div>`;
}
// localStorage ë§¤í•‘
function getLolMap(){ try{ return JSON.parse(localStorage.getItem('lol_name_map')||'{}'); }catch(e){ return {}; } }
function saveLolMap(map){ localStorage.setItem('lol_name_map', JSON.stringify(map)); }
function setLolMapping(k,v){ const m=getLolMap(); m[k]=v; saveLolMap(m); }
function delLolMapping(k){ const m=getLolMap(); delete m[k]; saveLolMap(m); }
// ë”¥ë¡¤ API (ë¸Œë¼ìš°ì € ì§ì ‘ í˜¸ì¶œ)
async function fetchDeepLol2(queryName, status){
  try{
    const r=await fetch(`https://b2c-api-cdn.deeplol.gg/summoner/strm_pro_info?name=${encodeURIComponent(queryName)}&status=${status}`);
    const d=await r.json();
    if(d.account_list&&d.account_list.length>0) return d;
  }catch(e){}
  return null;
}
async function searchAutoComplete2(s){
  try{
    const r=await fetch(`https://b2c-api-cdn.deeplol.gg/summoner/pro-search-auto-complete?search_string=${encodeURIComponent(s)}&riot_id_tag_line=`);
    const d=await r.json();
    if(d.streamer&&d.streamer.length>0) return {player_name:d.streamer[0].player_name,status:'streamer'};
    if(d.pro&&d.pro.length>0) return {player_name:d.pro[0].player_name,status:'pro'};
  }catch(e){}
  return null;
}
async function deepLolLookup2(name){
  const names=[name];
  const cleaned=name.replace(/^[^ê°€-í£a-zA-Z0-9]+/,'').replace(/[^ê°€-í£a-zA-Z0-9]+$/,'').trim();
  if(cleaned&&cleaned!==name) names.push(cleaned);
  const korOnly=name.replace(/[^ê°€-í£]/g,'');
  if(korOnly.length>=2&&korOnly!==name&&korOnly!==cleaned) names.push(korOnly);
  // 0: localStorage ë§¤í•‘
  const map=getLolMap();
  if(map[name]){ for(const st of ['streamer','pro']){ const r=await fetchDeepLol2(map[name],st); if(r) return r; } }
  // 1: ì§ì ‘ ì¡°íšŒ
  for(const st of ['streamer','pro']){ for(const n of names){ const r=await fetchDeepLol2(n,st); if(r) return r; } }
  // 2: auto-complete
  let found=null;
  for(const n of names){ found=await searchAutoComplete2(n); if(found) break; }
  // 3: ì ‘ë‘ì‚¬ ì¶•ì†Œ
  if(!found){ const base=korOnly.length>=2?korOnly:(cleaned||name); for(let len=base.length-1;len>=2&&!found;len--){ found=await searchAutoComplete2(base.substring(0,len)); } }
  if(found) return await fetchDeepLol2(found.player_name, found.status);
  return null;
}
async function searchLol(){
  const name=document.getElementById('lolName').value.trim();
  if(!name)return;
  const el=document.getElementById('lolList');
  el.innerHTML='<div style="text-align:center;padding:12px;color:var(--muted);font-size:12px">ê²€ìƒ‰ì¤‘...</div>';
  const deepUrl='https://www.deeplol.gg/summoner/search/kr/'+encodeURIComponent(name);
  try{
    const d=await deepLolLookup2(name);
    if(!d){
      const map=getLolMap();const saved=map[name]||'';
      el.innerHTML=`<div style="padding:8px"><div style="color:var(--muted);font-size:11px;margin-bottom:8px;text-align:center">ìë™ ì¡°íšŒ ì‹¤íŒ¨</div>
        <div style="display:flex;gap:4px;margin-bottom:8px">
          <input id="lolManualInput2" placeholder="ë”¥ë¡¤ ë“±ë¡ëª… ì…ë ¥" value="${saved}" style="flex:1;padding:5px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;font-family:inherit">
          <button onclick="saveLolManual2('${name.replace(/'/g,"\\'")}')" style="padding:5px 10px;border-radius:4px;border:1px solid var(--green);background:transparent;color:var(--green);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap">ì €ì¥</button>
        </div>
        ${saved?`<div style="text-align:center;margin-bottom:6px"><button onclick="delLolMapping('${name.replace(/'/g,"\\'")}');searchLol()" style="padding:3px 8px;border:none;background:transparent;color:var(--red);font-size:10px;cursor:pointer;font-family:inherit">ë§¤í•‘ ì‚­ì œ</button></div>`:''}
        <div style="text-align:center"><a href="${deepUrl}" target="_blank" rel="noopener" style="display:inline-block;padding:6px 14px;border-radius:5px;background:rgba(96,165,250,.15);color:#60a5fa;font-size:11px;font-weight:700;text-decoration:none;border:1px solid rgba(96,165,250,.3)">ë”¥ë¡¤ì—ì„œ ê²€ìƒ‰ â†’</a></div></div>`;
      const inp2=document.getElementById('lolManualInput2');
      if(inp2) inp2.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.isComposing){e.preventDefault();saveLolManual2(name);}});
      return;
    }
    const sorted=d.account_list.slice().sort((a,b)=>(tierOrder[a.tier]??99)-(tierOrder[b.tier]??99)||(b.lp||0)-(a.lp||0));
    const map=getLolMap();const hasSaved=!!map[name];
    el.innerHTML=sorted.map(a=>{
      const fowUrl='https://fow.kr/find/'+encodeURIComponent(a.riot_id+'-'+a.riot_tag);
      const lpText=a.tier!=='unranked'?a.lp+'LP':'';
      const ago=a.last_game_date>0?timeAgo(a.last_game_date*1000):'';
      return`<a href="${fowUrl}" target="_blank" class="lol-card">
        <span class="tier-badge ${a.tier}">${a.tier!=='unranked'?a.tier:'UN'}</span>
        <div style="flex:1;min-width:0">
          <div><span class="riot-id">${a.riot_id}</span><span class="riot-tag">#${a.riot_tag}</span></div>
          <div><span class="lp">${lpText}${lpText&&ago?' Â· ':''}${ago}</span></div>
        </div>
        <span class="fow-go">fow.kr â†’</span>
      </a>`;
    }).join('')+(hasSaved?`<div style="text-align:center;padding:4px"><button onclick="delLolMapping('${name.replace(/'/g,"\\'")}');searchLol()" style="border:none;background:transparent;color:var(--muted);font-size:10px;cursor:pointer;font-family:inherit">ë§¤í•‘ ì´ˆê¸°í™” (${map[name]})</button></div>`:'');
  }catch(e){el.innerHTML='<div style="text-align:center;padding:12px;color:var(--red);font-size:12px">ì˜¤ë¥˜: '+e.message+'</div>';}
}
async function saveLolManual2(soopName){
  const inp=document.getElementById('lolManualInput2');
  if(!inp)return;const val=inp.value.trim();if(!val)return;
  setLolMapping(soopName,val);
  document.getElementById('lolName').value=soopName;
  searchLol();
}
function timeAgo(ts){
  const diff=Date.now()-ts;
  const m=Math.floor(diff/60000),h=Math.floor(diff/3600000),d=Math.floor(diff/86400000);
  if(d>0)return d+'ì¼ ì „';if(h>0)return h+'ì‹œê°„ ì „';if(m>0)return m+'ë¶„ ì „';return 'ë°©ê¸ˆ';
}

document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.target.id==='sInput')setStreamer();
  if(e.key==='Enter'&&!e.isComposing&&e.target.id==='lolName'){e.preventDefault();const first=document.querySelector('#lolSearchResults div');if(first)first.click();else if(lolSelectedStreamer)searchLol();}
  if(e.key==='Enter'&&['tName','tCategory','tCount'].includes(e.target.id))addTemplate();
  if(e.key==='Enter'&&e.target.id==='autoVal')setAutoThreshold();
  if(e.key==='Enter'&&!e.isComposing&&e.target.classList.contains('r-memo')){
    e.preventDefault();
    const id=Number(e.target.getAttribute('data-rid'));
    const val=e.target.value.trim();
    if(val){updMemo(id,val);const r=results.find(x=>x.id===id);if(r)r.message=val;renderRes();}
  }
});

// loadCfg, connectSSEëŠ” ë¡œê·¸ì¸ ì„±ê³µ ì‹œ showMain()ì—ì„œ í˜¸ì¶œ
</script>
</body>
</html>
